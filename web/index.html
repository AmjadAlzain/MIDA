<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIDA Certificate OCR & Converter</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            max-width: 1000px; 
            margin: 2rem auto; 
            padding: 0 1rem;
            background: #f5f5f5;
            color: #333;
        }
        h1 { color: #2c3e50; margin-bottom: 0.5rem; }
        h2 { color: #34495e; border-bottom: 2px solid #3498db; padding-bottom: 0.5rem; margin-top: 2rem; }
        h3 { color: #2c3e50; margin-top: 1.5rem; }
        
        .container { 
            background: white;
            border: 1px solid #ddd; 
            padding: 2rem; 
            border-radius: 8px; 
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #555;
        }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
        }
        .form-group input[type="file"] {
            padding: 0.5rem 0;
        }
        .form-group small {
            display: block;
            margin-top: 0.25rem;
            color: #888;
            font-style: italic;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        
        .row {
            display: flex;
            gap: 1rem;
        }
        .row .form-group {
            flex: 1;
        }
        
        pre { 
            background: #f8f9fa; 
            padding: 1rem; 
            overflow-x: auto; 
            border-radius: 4px;
            border: 1px solid #e9ecef;
            font-size: 0.85rem;
        }
        
        button { 
            padding: 0.75rem 1.5rem; 
            cursor: pointer;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: 600;
            transition: background 0.2s;
        }
        button:hover { background: #2980b9; }
        button:disabled { background: #bdc3c7; cursor: not-allowed; }
        
        .btn-secondary {
            background: #95a5a6;
        }
        .btn-secondary:hover { background: #7f8c8d; }
        
        /* Results section */
        .results-section { margin-top: 2rem; }
        
        .summary-stats {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .stat-card {
            flex: 1;
            background: #ecf0f1;
            padding: 1rem;
            border-radius: 4px;
            text-align: center;
        }
        .stat-card .number {
            font-size: 2rem;
            font-weight: bold;
            color: #2c3e50;
        }
        .stat-card .label {
            color: #7f8c8d;
            font-size: 0.85rem;
        }
        .stat-card.matched { background: #d5f4e6; }
        .stat-card.matched .number { color: #27ae60; }
        .stat-card.unmatched { background: #fdecea; }
        .stat-card.unmatched .number { color: #e74c3c; }
        
        /* Table styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 0.9rem;
        }
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #3498db;
            color: white;
            font-weight: 600;
        }
        tr:hover { background: #f8f9fa; }
        tr:nth-child(even) { background: #fafafa; }
        tr:nth-child(even):hover { background: #f0f0f0; }
        
        .match-score {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.85rem;
        }
        .match-score.high { background: #d5f4e6; color: #27ae60; }
        .match-score.medium { background: #fef3cd; color: #856404; }
        .match-score.low { background: #fdecea; color: #e74c3c; }
        
        /* Warnings section */
        .warnings-section {
            margin-top: 1.5rem;
        }
        .warning-item {
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
            border-left: 4px solid;
        }
        .warning-item.error {
            background: #fdecea;
            border-color: #e74c3c;
        }
        .warning-item.warning {
            background: #fef3cd;
            border-color: #f39c12;
        }
        .warning-item.info {
            background: #d6eaf8;
            border-color: #3498db;
        }
        .warning-item .invoice-item {
            font-weight: 600;
            color: #2c3e50;
        }
        .warning-item .reason {
            margin-top: 0.25rem;
            color: #555;
        }
        .warning-item .severity-badge {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            border-radius: 3px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
            margin-left: 0.5rem;
        }
        .severity-badge.error { background: #e74c3c; color: white; }
        .severity-badge.warning { background: #f39c12; color: white; }
        .severity-badge.info { background: #3498db; color: white; }
        
        /* Error message */
        .error-message {
            background: #fdecea;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
        }
        .error-message h4 {
            margin: 0 0 0.5rem 0;
            color: #721c24;
        }
        
        /* Loading state */
        .loading {
            text-align: center;
            padding: 2rem;
            color: #7f8c8d;
        }
        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #3498db;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 0.5rem;
            vertical-align: middle;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 0;
            margin-bottom: 0;
        }
        .tab {
            padding: 0.75rem 1.5rem;
            background: #ecf0f1;
            border: 1px solid #ddd;
            border-bottom: none;
            cursor: pointer;
            font-weight: 600;
            color: #7f8c8d;
            border-radius: 4px 4px 0 0;
        }
        .tab.active {
            background: white;
            color: #3498db;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        /* Hidden */
        .hidden { display: none; }
        
        /* View toggle buttons */
        .view-toggle {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .toggle-btn {
            padding: 0.5rem 1rem;
            background: #ecf0f1;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .toggle-btn:hover {
            background: #d5dbdb;
        }
        .toggle-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        /* Form flag badge */
        .form-flag-badge {
            display: inline-block;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        .form-flag-badge.form-d {
            background: #fdecea;
            color: #e74c3c;
        }
        .form-flag-badge.empty {
            background: #d5f4e6;
            color: #27ae60;
        }
        
        /* Total row styling */
        tr.total-row {
            background: #f8f9fa !important;
            font-weight: bold;
            border-top: 2px solid #3498db;
        }
        tr.total-row:hover {
            background: #f0f0f0 !important;
        }
        
        /* Certificate Parser Styles */
        .cert-header {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        .cert-header-field {
            display: flex;
            flex-direction: column;
        }
        .cert-header-field label {
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 0.25rem;
            font-weight: 600;
        }
        .cert-header-field .value {
            font-size: 1rem;
            color: #2c3e50;
            padding: 0.5rem;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            min-height: 38px;
        }
        .cert-header-field .value.editable {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        .cert-header-field input {
            font-size: 1rem;
            padding: 0.5rem;
            border: 1px solid #3498db;
            border-radius: 4px;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        /* Editable table cells */
        .editable-cell {
            transition: all 0.2s;
        }
        .editable-cell.editing {
            background: #fff3cd !important;
            border: 2px solid #3498db !important;
            padding: 0.5rem;
        }
        td[contenteditable="true"] {
            background: #fff3cd;
            border: 2px solid #3498db;
            outline: none;
        }
        td[contenteditable="true"]:focus {
            background: #fffef0;
        }
        
        /* Action buttons group */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        .btn-edit {
            background: #f39c12;
        }
        .btn-edit:hover { background: #e67e22; }
        .btn-save {
            background: #27ae60;
        }
        .btn-save:hover { background: #219a52; }
        .btn-cancel {
            background: #e74c3c;
        }
        .btn-cancel:hover { background: #c0392b; }
        .btn-database {
            background: #27ae60;
        }
        .btn-database:hover { background: #1e8449; }
        
        /* Confirmation Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        .modal-content h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        .modal-content p {
            color: #555;
            line-height: 1.6;
        }
        .modal-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }
        
        /* Parser results container */
        .parser-results {
            margin-top: 1.5rem;
        }
        
        /* Items table for parser */
        .items-table-container {
            overflow-x: auto;
            margin-top: 1rem;
        }
        .items-table th {
            white-space: nowrap;
        }
        .items-table td {
            min-width: 80px;
        }
        .items-table td:nth-child(3) {
            min-width: 200px;
        }
        
        /* Success message */
        .success-message {
            background: #d5f4e6;
            border: 1px solid #27ae60;
            color: #155724;
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
        }
        .success-message h4 {
            margin: 0 0 0.5rem 0;
            color: #155724;
        }
        
        /* Warnings badge */
        .warnings-badge {
            background: #fef3cd;
            color: #856404;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.85rem;
            margin-left: 0.5rem;
        }
        
        /* Discrepancy highlighting */
        tr.discrepancy-row {
            background: #fdecea !important;
        }
        tr.discrepancy-row:hover {
            background: #f5c6cb !important;
        }
        tr.discrepancy-row td {
            border-color: #e74c3c;
        }
        /* Ensure discrepancy rows can still be edited */
        tr.discrepancy-row td[contenteditable="true"] {
            background: #fff3cd !important;
            border: 2px solid #3498db !important;
        }
        tr.discrepancy-row td.editing {
            background: #fff3cd !important;
            border: 2px solid #3498db !important;
        }
        
        /* Missing data highlighting (more severe - blocks save) */
        tr.missing-data-row {
            background: #f8d7da !important;
        }
        tr.missing-data-row:hover {
            background: #f1b0b7 !important;
        }
        tr.missing-data-row td.missing-field {
            background: #e74c3c !important;
            color: white;
            border-color: #c0392b;
        }
        tr.missing-data-row td[contenteditable="true"].missing-field {
            background: #fff3cd !important;
            color: #333;
            border: 2px solid #e74c3c !important;
        }
        
        /* Missing header field highlighting */
        .cert-header-field .value.missing-field {
            background: #f8d7da !important;
            border: 2px solid #e74c3c !important;
            color: #721c24;
        }
        .cert-header-field .value.missing-field.editable {
            background: #fff3cd !important;
            border: 2px solid #e74c3c !important;
            color: #333;
        }
        
        /* Missing data warning banner (error level) */
        .missing-data-warning {
            background: #f8d7da;
            border: 1px solid #c0392b;
            border-left: 4px solid #c0392b;
            color: #721c24;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        .missing-data-warning h4 {
            margin: 0 0 0.5rem 0;
            color: #721c24;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .missing-data-warning ul {
            margin: 0.5rem 0 0 1.5rem;
            padding: 0;
        }
        .missing-data-warning li {
            margin-bottom: 0.25rem;
        }
        
        /* Discrepancy warning banner */
        .discrepancy-warning {
            background: #fdecea;
            border: 1px solid #e74c3c;
            border-left: 4px solid #e74c3c;
            color: #721c24;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        .discrepancy-warning h4 {
            margin: 0 0 0.5rem 0;
            color: #721c24;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .discrepancy-warning ul {
            margin: 0.5rem 0 0 1.5rem;
            padding: 0;
        }
        .discrepancy-warning li {
            margin-bottom: 0.25rem;
        }
        
        /* ==========================================
           Row Action Buttons (Add/Delete Rows)
           ========================================== */
        
        /* Actions column - hidden by default, shown in edit mode */
        .actions-column {
            display: none;
            width: 90px;
            min-width: 90px;
        }
        .actions-column.visible {
            display: table-cell;
        }
        
        /* Row action buttons */
        .row-actions {
            display: flex;
            gap: 4px;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .row-actions.visible {
            opacity: 1;
        }
        .row-action-btn {
            padding: 4px 8px;
            font-size: 0.8rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-insert-row {
            background: #27ae60;
            color: white;
        }
        .btn-insert-row:hover {
            background: #219a52;
        }
        .btn-delete-row {
            background: #e74c3c;
            color: white;
        }
        .btn-delete-row:hover {
            background: #c0392b;
        }
        .btn-delete-row:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        
        /* Add row between rows button (appears between rows) */
        .add-row-divider {
            display: none;
            height: 0;
            position: relative;
        }
        .add-row-divider.visible {
            display: table-row;
        }
        .add-row-divider td {
            padding: 0 !important;
            border: none !important;
            position: relative;
            height: 24px;
        }
        .add-row-btn-container {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }
        .btn-add-row-between {
            padding: 2px 12px;
            font-size: 0.75rem;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            opacity: 0.7;
        }
        .btn-add-row-between:hover {
            background: #2980b9;
            opacity: 1;
        }
        
        /* Undo Toast Notification */
        .undo-toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #2c3e50;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 2000;
            animation: slideUp 0.3s ease;
        }
        .undo-toast.hiding {
            animation: slideDown 0.3s ease forwards;
        }
        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(100px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(0); opacity: 1; }
            to { transform: translateX(-50%) translateY(100px); opacity: 0; }
        }
        .undo-toast .toast-message {
            font-size: 0.95rem;
        }
        .undo-toast .btn-undo {
            padding: 6px 14px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }
        .undo-toast .btn-undo:hover {
            background: #2980b9;
        }
        .undo-toast .toast-dismiss {
            padding: 4px 8px;
            background: transparent;
            color: #95a5a6;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
        }
        .undo-toast .toast-dismiss:hover {
            color: white;
        }
        
        /* ==========================================
           Database View Tab Styles
           ========================================== */
        
        /* Breadcrumb navigation */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        .breadcrumb-item {
            color: #3498db;
            cursor: pointer;
            text-decoration: none;
        }
        .breadcrumb-item:hover {
            text-decoration: underline;
        }
        .breadcrumb-item.active {
            color: #2c3e50;
            cursor: default;
            font-weight: 600;
        }
        .breadcrumb-separator {
            color: #7f8c8d;
        }
        
        /* Clickable table rows */
        .clickable-row {
            cursor: pointer;
            transition: background 0.15s;
        }
        .clickable-row:hover {
            background: #e8f4fc !important;
        }
        .clickable-row.selected {
            background: #d4edfc !important;
            border-left: 3px solid #3498db;
        }
        
        /* Quantity status colors */
        .qty-status-normal {
            color: #27ae60;
            font-weight: 600;
        }
        .qty-status-warning {
            color: #f39c12;
            font-weight: 600;
        }
        .qty-status-depleted {
            color: #e74c3c;
            font-weight: 600;
        }
        .qty-status-overdrawn {
            color: #c0392b;
            font-weight: bold;
            background: #fdecea;
        }
        
        /* Status badge */
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: capitalize;
        }
        .status-badge.active {
            background: #d5f4e6;
            color: #27ae60;
        }
        .status-badge.expired {
            background: #fdecea;
            color: #e74c3c;
        }
        /* Legacy support for any remaining draft/confirmed badges */
        .status-badge.draft {
            background: #fef3cd;
            color: #856404;
        }
        .status-badge.confirmed {
            background: #d5f4e6;
            color: #27ae60;
        }
        
        /* Database Sub-tabs */
        .db-sub-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 0.5rem;
        }
        .db-sub-tab {
            padding: 0.6rem 1.2rem;
            border: none;
            background: #ecf0f1;
            border-radius: 4px 4px 0 0;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            color: #7f8c8d;
            transition: all 0.2s ease;
        }
        .db-sub-tab:hover {
            background: #dfe6e9;
            color: #2c3e50;
        }
        .db-sub-tab.active {
            background: #3498db;
            color: white;
        }
        
        /* Action Buttons in Tables */
        .btn-action {
            padding: 0.3rem 0.6rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            margin: 0 0.2rem;
            transition: all 0.2s ease;
        }
        .btn-action-delete {
            background: #fdecea;
            color: #e74c3c;
        }
        .btn-action-delete:hover {
            background: #e74c3c;
            color: white;
        }
        .btn-action-restore {
            background: #d5f4e6;
            color: #27ae60;
        }
        .btn-action-restore:hover {
            background: #27ae60;
            color: white;
        }
        .btn-action-permanent {
            background: #2c3e50;
            color: white;
        }
        .btn-action-permanent:hover {
            background: #1a252f;
        }
        
        /* Quantity toggle */
        .qty-toggle-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            background: #ecf0f1;
            border-radius: 4px;
        }
        .qty-toggle-label {
            font-weight: 600;
            color: #2c3e50;
        }
        .qty-toggle-switch {
            display: flex;
            background: white;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #bdc3c7;
        }
        .qty-toggle-btn {
            padding: 0.5rem 1rem;
            background: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.2s;
            color: #7f8c8d;
        }
        .qty-toggle-btn:hover {
            background: #f8f9fa;
        }
        .qty-toggle-btn.active {
            background: #3498db;
            color: white;
        }
        .qty-toggle-btn:first-child {
            border-right: 1px solid #bdc3c7;
        }
        
        /* Port filter buttons */
        .port-filter-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .port-filter-btn {
            padding: 0.5rem 1rem;
            background: #ecf0f1;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .port-filter-btn:hover {
            background: #d5dbdb;
        }
        .port-filter-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #7f8c8d;
        }
        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        .empty-state-text {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        .empty-state-subtext {
            font-size: 0.9rem;
            color: #95a5a6;
        }
        
        /* Pagination */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            padding: 0.75rem 0;
            border-top: 1px solid #e9ecef;
        }
        .pagination-left {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        .pagination-info {
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        .rows-per-page {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: #7f8c8d;
        }
        .rows-per-page select {
            padding: 0.3rem 0.5rem;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 0.85rem;
            cursor: pointer;
        }
        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .pagination-btn {
            padding: 0.4rem 0.75rem;
            background: #ecf0f1;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.15s;
        }
        .pagination-btn:hover:not(:disabled) {
            background: #d5dbdb;
        }
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pagination-page {
            padding: 0.4rem 0.6rem;
            min-width: 35px;
            text-align: center;
            background: white;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        .pagination-page.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        /* Back button */
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.5rem 1rem;
            background: #ecf0f1;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.15s;
        }
        .back-btn:hover {
            background: #d5dbdb;
        }
        
        /* Info card */
        .info-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .info-card-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        .info-card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
        }
        .info-card-item {
            display: flex;
            flex-direction: column;
        }
        .info-card-label {
            font-size: 0.8rem;
            color: #7f8c8d;
        }
        .info-card-value {
            font-weight: 600;
            color: #2c3e50;
        }
        
        /* Table number formatting */
        .number-cell {
            font-family: 'Consolas', 'Monaco', monospace;
            text-align: right;
        }
        
        /* ==========================================
           3-Tab Classification Styles
           ========================================== */
        
        /* Classification results tabs */
        .classification-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 0;
            border-bottom: 2px solid #ddd;
        }
        .classification-tab {
            padding: 0.75rem 1.5rem;
            background: #ecf0f1;
            border: 1px solid #ddd;
            border-bottom: none;
            cursor: pointer;
            font-weight: 600;
            color: #7f8c8d;
            border-radius: 4px 4px 0 0;
            margin-right: 2px;
            position: relative;
        }
        .classification-tab.active {
            background: white;
            color: #3498db;
            border-bottom: 2px solid white;
            margin-bottom: -2px;
        }
        .classification-tab .tab-count {
            display: inline-block;
            background: #7f8c8d;
            color: white;
            padding: 0.1rem 0.5rem;
            border-radius: 10px;
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }
        .classification-tab.active .tab-count {
            background: #3498db;
        }
        .classification-tab.form-d.active { color: #9b59b6; }
        .classification-tab.form-d.active .tab-count { background: #9b59b6; }
        .classification-tab.mida.active { color: #27ae60; }
        .classification-tab.mida.active .tab-count { background: #27ae60; }
        .classification-tab.duties.active { color: #e67e22; }
        .classification-tab.duties.active .tab-count { background: #e67e22; }
        
        .classification-content {
            display: none;
            border: 1px solid #ddd;
            border-top: none;
            padding: 1rem;
            background: white;
        }
        .classification-content.active {
            display: block;
        }
        
        /* SST Toggle */
        .sst-toggle {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .sst-toggle input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        .sst-toggle label {
            cursor: pointer;
            font-size: 0.85rem;
        }
        .sst-toggle.on label {
            color: #27ae60;
            font-weight: 600;
        }
        .sst-toggle.off label {
            color: #e74c3c;
        }
        
        /* Modified row highlighting */
        tr.modified-row {
            background: #fffacd !important;
        }
        tr.modified-row:hover {
            background: #fff3a0 !important;
        }
        
        /* Toggle all SST button */
        .toggle-all-sst-btn {
            background: none;
            border: 1px solid rgba(255,255,255,0.5);
            border-radius: 4px;
            padding: 2px 6px;
            cursor: pointer;
            font-size: 0.75rem;
            color: white;
            margin-left: 0.5rem;
        }
        .toggle-all-sst-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        /* Move item dropdown */
        .move-dropdown {
            position: relative;
            display: inline-block;
        }
        .move-dropdown-btn {
            background: none;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 0.3rem 0.5rem;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .move-dropdown-btn:hover {
            background: #f0f0f0;
        }
        .move-dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            min-width: 180px;
            z-index: 100;
        }
        .move-dropdown-content.show {
            display: block;
        }
        .move-dropdown-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .move-dropdown-item:hover {
            background: #f8f9fa;
        }
        .move-dropdown-item.form-d { color: #9b59b6; }
        .move-dropdown-item.mida { color: #27ae60; }
        .move-dropdown-item.duties { color: #e67e22; }
        
        /* Move dropdown select styling */
        .move-dropdown select {
            padding: 0.3rem 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85rem;
            cursor: pointer;
            background: white;
            min-width: 100px;
        }
        .move-dropdown select:hover {
            border-color: #3498db;
        }
        
        /* Export buttons section */
        .export-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 1.5rem;
        }
        .export-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }
        .export-btn.form-d {
            background: #9b59b6;
            color: white;
        }
        .export-btn.form-d:hover { background: #8e44ad; }
        .export-btn.form-d:disabled { background: #c39bd3; cursor: not-allowed; }
        .export-btn.mida {
            background: #27ae60;
            color: white;
        }
        .export-btn.mida:hover { background: #219a52; }
        .export-btn.mida:disabled { background: #82e0aa; cursor: not-allowed; }
        .export-btn.duties {
            background: #e67e22;
            color: white;
        }
        .export-btn.duties:hover { background: #d35400; }
        .export-btn.duties:disabled { background: #f5b041; cursor: not-allowed; }
        
        /* Company mandatory indicator */
        .required-field::after {
            content: " *";
            color: #e74c3c;
        }
        
        /* Stat item styles for classification summary */
        .stat-item {
            background: #ecf0f1;
            padding: 0.75rem 1rem;
            border-radius: 4px;
            text-align: center;
            min-width: 100px;
        }
        .stat-item .stat-label {
            color: #7f8c8d;
            font-size: 0.75rem;
            text-transform: uppercase;
        }
        .stat-item .stat-value {
            font-size: 1.25rem;
            font-weight: bold;
            color: #2c3e50;
        }
        .stat-item.form-d {
            background: #f5eef8;
        }
        .stat-item.form-d .stat-value {
            color: #9b59b6;
        }
        .stat-item.mida {
            background: #d5f4e6;
        }
        .stat-item.mida .stat-value {
            color: #27ae60;
        }
        .stat-item.duties {
            background: #fef5e7;
        }
        .stat-item.duties .stat-value {
            color: #e67e22;
        }
        
        /* ==========================================
           CRUD Modal and Form Styles
           ========================================== */
        
        /* Add Certificate/Item buttons */
        .btn-add {
            background: #27ae60;
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: background 0.2s;
        }
        .btn-add:hover { background: #219a52; }
        
        /* Edit button */
        .btn-action-edit {
            background: #3498db !important;
            color: white;
        }
        .btn-action-edit:hover { background: #2980b9 !important; }
        
        /* Large modal for forms */
        .modal-content.large {
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        /* Form sections */
        .form-section {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        .form-section-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #3498db;
        }
        
        /* Form grid */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        .form-grid-3 {
            grid-template-columns: repeat(3, 1fr);
        }
        .form-grid-4 {
            grid-template-columns: repeat(4, 1fr);
        }
        
        /* Form field */
        .form-field {
            margin-bottom: 0.75rem;
        }
        .form-field label {
            display: block;
            font-weight: 600;
            color: #555;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }
        .form-field input,
        .form-field select {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.95rem;
        }
        .form-field input:focus,
        .form-field select:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        .form-field input.error,
        .form-field select.error {
            border-color: #e74c3c;
        }
        .form-field .field-error {
            color: #e74c3c;
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }
        
        /* Items table in edit form */
        .items-form-container {
            margin-top: 1rem;
        }
        .items-form-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        .items-form-table th {
            background: #2c3e50;
            color: white;
            padding: 0.6rem;
            text-align: left;
            font-size: 0.8rem;
        }
        .items-form-table td {
            padding: 0.5rem;
            border-bottom: 1px solid #e9ecef;
            vertical-align: top;
        }
        .items-form-table input {
            width: 100%;
            padding: 0.4rem;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 0.85rem;
        }
        .items-form-table input:focus {
            border-color: #3498db;
            outline: none;
        }
        .items-form-table input.error {
            border-color: #e74c3c;
            background: #fef0f0;
        }
        .items-form-table .line-no-cell {
            width: 50px;
            text-align: center;
        }
        .items-form-table .qty-cell {
            width: 100px;
        }
        .items-form-table .action-cell {
            width: 50px;
            text-align: center;
        }
        
        /* Row action buttons */
        .btn-row-delete {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 0.3rem 0.5rem;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        .btn-row-delete:hover { background: #c0392b; }
        
        /* Add item row button */
        .btn-add-row {
            background: #27ae60;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 0.5rem;
        }
        .btn-add-row:hover { background: #219a52; }
        
        /* Toolbar above table */
        .table-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            background: #f8f9fa;
            border-radius: 6px;
        }
        .table-toolbar-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .table-toolbar-title {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1rem;
        }
        
        /* Confirm item deletion modal */
        .item-delete-info {
            background: #fef0f0;
            border: 1px solid #f5c6cb;
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }
        .item-delete-info p {
            margin: 0.25rem 0;
        }
        
        /* ==========================================
           Workflow Navigation History System
           ========================================== */
        
        /* Global navigation header */
        .nav-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .nav-back-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .nav-back-btn:hover:not(:disabled) {
            background: rgba(255,255,255,0.25);
            transform: translateX(-2px);
        }
        .nav-back-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .nav-back-btn .back-arrow {
            font-size: 1.1rem;
        }
        .nav-back-btn .back-text {
            display: none;
        }
        @media (min-width: 600px) {
            .nav-back-btn .back-text {
                display: inline;
            }
        }
        
        /* Workflow breadcrumb trail */
        .workflow-breadcrumb {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.25rem;
            flex: 1;
            color: rgba(255,255,255,0.7);
            font-size: 0.85rem;
        }
        .workflow-crumb {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .workflow-crumb-link {
            color: rgba(255,255,255,0.8);
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.2s;
            text-decoration: none;
        }
        .workflow-crumb-link:hover {
            background: rgba(255,255,255,0.15);
            color: white;
        }
        .workflow-crumb-active {
            color: white;
            font-weight: 600;
            background: rgba(52, 152, 219, 0.4);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }
        .workflow-crumb-separator {
            color: rgba(255,255,255,0.4);
            margin: 0 0.25rem;
        }
        
        /* Workflow status indicator */
        .workflow-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.75rem;
            background: rgba(39, 174, 96, 0.2);
            border: 1px solid rgba(39, 174, 96, 0.4);
            border-radius: 20px;
            color: #82e0aa;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .workflow-status.has-changes {
            background: rgba(241, 196, 15, 0.2);
            border-color: rgba(241, 196, 15, 0.4);
            color: #f9e79f;
        }
        .workflow-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Keyboard shortcut hint */
        .nav-shortcut-hint {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.5);
            margin-left: auto;
            display: none;
        }
        @media (min-width: 768px) {
            .nav-shortcut-hint {
                display: block;
            }
        }
        .nav-shortcut-hint kbd {
            background: rgba(255,255,255,0.15);
            padding: 0.1rem 0.4rem;
            border-radius: 3px;
            font-family: inherit;
            font-size: 0.7rem;
            margin: 0 0.1rem;
        }
        
        /* Unsaved changes warning */
        .unsaved-warning-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #f39c12;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 1rem;
            z-index: 3000;
            animation: slideDown 0.3s ease;
        }
        @keyframes slideDownFromTop {
            from { transform: translateX(-50%) translateY(-100px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        .unsaved-warning-toast .warning-buttons {
            display: flex;
            gap: 0.5rem;
        }
        .unsaved-warning-toast button {
            padding: 0.4rem 0.8rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
        }
        .unsaved-warning-toast .btn-save-continue {
            background: white;
            color: #f39c12;
        }
        .unsaved-warning-toast .btn-discard {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        .unsaved-warning-toast .btn-cancel-nav {
            background: transparent;
            color: rgba(255,255,255,0.8);
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <!-- Global Navigation Header -->
    <div class="nav-header" id="navHeader">
        <button class="nav-back-btn" id="globalBackBtn" onclick="workflowHistory.goBack()" disabled title="Go back (Alt+←)">
            <span class="back-arrow">←</span>
            <span class="back-text">Back</span>
        </button>
        <div class="workflow-breadcrumb" id="workflowBreadcrumb">
            <span class="workflow-crumb-active">🏠 Home</span>
        </div>
        <div class="workflow-status" id="workflowStatus" style="display: none;">
            <span class="workflow-status-dot"></span>
            <span id="workflowStatusText">Saved</span>
        </div>
        <div class="nav-shortcut-hint">
            <kbd>Alt</kbd>+<kbd>←</kbd> Back
        </div>
    </div>

    <h1>🏭 MIDA Certificate System</h1>
    
    <!-- Tabs -->
    <div class="tabs">
        <div class="tab active" onclick="switchTab('converter')">Invoice Converter</div>
        <div class="tab" onclick="switchTab('parser')">Certificate Parser</div>
        <div class="tab" onclick="switchTab('database')">Database View</div>
    </div>
    
    <!-- Converter Tab -->
    <div id="converter-tab" class="tab-content active">
        <div class="container">
            <h2>📄 Invoice Converter</h2>
            <p>Upload an invoice file (Excel .xls or .xlsx), select a company, and classify items into Form-D, MIDA, and Duties Payable categories.</p>
            
            <div class="form-group">
                <label for="invoiceFile">Invoice File</label>
                <input type="file" id="invoiceFile" accept=".xls,.xlsx">
            </div>
            
            <!-- MIDA Certificate Selection (always visible) -->
            <div id="midaOptions">
                <div class="form-group">
                    <label for="companySelect" class="required-field">Company</label>
                    <select id="companySelect" style="width: 100%; padding: 0.6rem; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 1rem;" onchange="onCompanyChange()">
                        <option value="">-- Select Company (Required) --</option>
                    </select>
                    <small id="companyLoadingText" class="hidden">⏳ Loading companies...</small>
                </div>
                
                <div class="form-group" id="certificateListSection" class="hidden">
                    <label>MIDA Certificates (optional - select for MIDA matching)</label>
                    <div id="certificateSearchBox" style="margin-bottom: 0.5rem;">
                        <input type="text" id="certSearchInput" placeholder="🔍 Search certificates..." 
                               style="width: 100%; padding: 0.5rem; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 0.9rem;"
                               oninput="filterCertificates()">
                    </div>
                    <div id="certificateList" style="max-height: 250px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 4px; padding: 0.5rem; background: #fff;">
                        <p style="color: #7f8c8d; text-align: center; margin: 1rem 0;">Select a company to view certificates</p>
                    </div>
                    <small id="certLoadingText" class="hidden">⏳ Loading certificates...</small>
                    <div id="selectedCertsInfo" style="margin-top: 0.5rem; font-size: 0.85rem; color: #2c3e50;"></div>
                </div>
            </div>
            
            <button onclick="classifyInvoice()" id="convertBtn">🔄 Classify Items</button>
            
            <!-- Import Metadata Fields (always visible) -->
            <div id="importMetadataSection" style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px;">
                <h4 style="margin: 0 0 0.75rem 0; color: #2c3e50;">📋 Import Details</h4>
                <div class="row" style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1; min-width: 150px;">
                        <label for="countrySelect" style="font-weight: 600; color: #555;">Country</label>
                        <select id="countrySelect" style="width: 100%; padding: 0.5rem; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 0.9rem;">
                            <option value="AF">Afghanistan (AF)</option>
                            <option value="AL">Albania (AL)</option>
                            <option value="DZ">Algeria (DZ)</option>
                            <option value="AR">Argentina (AR)</option>
                            <option value="AU">Australia (AU)</option>
                            <option value="AT">Austria (AT)</option>
                            <option value="BD">Bangladesh (BD)</option>
                            <option value="BE">Belgium (BE)</option>
                            <option value="BR">Brazil (BR)</option>
                            <option value="BN">Brunei Darussalam (BN)</option>
                            <option value="KH">Cambodia (KH)</option>
                            <option value="CA">Canada (CA)</option>
                            <option value="CN">China (CN)</option>
                            <option value="CO">Colombia (CO)</option>
                            <option value="CZ">Czechia (CZ)</option>
                            <option value="DK">Denmark (DK)</option>
                            <option value="EG">Egypt (EG)</option>
                            <option value="FI">Finland (FI)</option>
                            <option value="FR">France (FR)</option>
                            <option value="DE">Germany (DE)</option>
                            <option value="GR">Greece (GR)</option>
                            <option value="HK">Hong Kong (HK)</option>
                            <option value="HU">Hungary (HU)</option>
                            <option value="IN">India (IN)</option>
                            <option value="ID">Indonesia (ID)</option>
                            <option value="IR">Iran (IR)</option>
                            <option value="IQ">Iraq (IQ)</option>
                            <option value="IE">Ireland (IE)</option>
                            <option value="IL">Israel (IL)</option>
                            <option value="IT">Italy (IT)</option>
                            <option value="JP" selected>Japan (JP)</option>
                            <option value="JO">Jordan (JO)</option>
                            <option value="KZ">Kazakhstan (KZ)</option>
                            <option value="KE">Kenya (KE)</option>
                            <option value="KR">Korea, Republic of (KR)</option>
                            <option value="KW">Kuwait (KW)</option>
                            <option value="LA">Lao PDR (LA)</option>
                            <option value="LB">Lebanon (LB)</option>
                            <option value="MY">Malaysia (MY)</option>
                            <option value="MX">Mexico (MX)</option>
                            <option value="MM">Myanmar (MM)</option>
                            <option value="NL">Netherlands (NL)</option>
                            <option value="NZ">New Zealand (NZ)</option>
                            <option value="NG">Nigeria (NG)</option>
                            <option value="NO">Norway (NO)</option>
                            <option value="PK">Pakistan (PK)</option>
                            <option value="PH">Philippines (PH)</option>
                            <option value="PL">Poland (PL)</option>
                            <option value="PT">Portugal (PT)</option>
                            <option value="QA">Qatar (QA)</option>
                            <option value="RO">Romania (RO)</option>
                            <option value="RU">Russia (RU)</option>
                            <option value="SA">Saudi Arabia (SA)</option>
                            <option value="SG">Singapore (SG)</option>
                            <option value="ZA">South Africa (ZA)</option>
                            <option value="ES">Spain (ES)</option>
                            <option value="LK">Sri Lanka (LK)</option>
                            <option value="SE">Sweden (SE)</option>
                            <option value="CH">Switzerland (CH)</option>
                            <option value="TW">Taiwan (TW)</option>
                            <option value="TH">Thailand (TH)</option>
                            <option value="TR">Turkey (TR)</option>
                            <option value="AE">United Arab Emirates (AE)</option>
                            <option value="GB">United Kingdom (GB)</option>
                            <option value="US">United States (US)</option>
                            <option value="VN">Vietnam (VN)</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 150px;">
                        <label for="portSelect" style="font-weight: 600; color: #555;">Import Port</label>
                        <select id="portSelect" style="width: 100%; padding: 0.5rem; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 0.9rem;" onchange="renderClassificationTable('mida')">
                            <option value="port_klang" selected>Port Klang</option>
                            <option value="klia">KLIA</option>
                            <option value="bukit_kayu_hitam">Bukit Kayu Hitam</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 150px;">
                        <label for="importDate" style="font-weight: 600; color: #555;">Import Date</label>
                        <input type="date" id="importDate" style="width: 100%; padding: 0.5rem; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 0.9rem;">
                    </div>
                </div>
            </div>
            
            <!-- Results -->
            <div id="converterResults" class="results-section hidden">
                <!-- Summary Stats -->
                <div id="summaryStats" class="summary-stats"></div>
                
                <!-- 3-Tab Classification Results -->
                <div id="classificationSection" class="hidden">
                    <!-- Classification Tabs -->
                    <div class="classification-tabs">
                        <div class="classification-tab form-d active" onclick="switchClassificationTab('form-d')">
                            🏷️ Form-D <span class="tab-count" id="formDCount">0</span>
                        </div>
                        <div class="classification-tab mida" onclick="switchClassificationTab('mida')">
                            ✅ MIDA <span class="tab-count" id="midaCount">0</span>
                        </div>
                        <div class="classification-tab duties" onclick="switchClassificationTab('duties')">
                            💰 Duties Payable <span class="tab-count" id="dutiesCount">0</span>
                        </div>
                    </div>
                    
                    <!-- Form-D Content -->
                    <div id="form-d-content" class="classification-content active">
                        <div style="overflow-x: auto;">
                            <table id="formDTable">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;"><input type="checkbox" onchange="toggleSelectAllItems('form_d', this.checked)"></th>
                                        <th>Line</th>
                                        <th>Parts Name</th>
                                        <th>HS Code</th>
                                        <th>Qty</th>
                                        <th>UOM</th>
                                        <th>Net Wt (Kg)</th>
                                        <th>Amount (USD)</th>
                                        <th>SST Exempt <button class="toggle-all-sst-btn" onclick="toggleAllSST('form_d')" title="Toggle All">☑</button></th>
                                        <th>Move</th>
                                    </tr>
                                </thead>
                                <tbody id="formDTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- MIDA Content -->
                    <div id="mida-content" class="classification-content">
                        <div style="overflow-x: auto;">
                            <table id="midaTable">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;"><input type="checkbox" onchange="toggleSelectAllItems('mida', this.checked)"></th>
                                        <th>Line</th>
                                        <th>Parts Name</th>
                                        <th>MIDA HS Code</th>
                                        <th>UOM</th>
                                        <th>Certificate</th>
                                        <th>Remaining</th>
                                        <th>Deduction</th>
                                        <th>Score</th>
                                        <th>SST Exempt <button class="toggle-all-sst-btn" onclick="toggleAllSST('mida')" title="Toggle All">☑</button></th>
                                        <th>Move</th>
                                    </tr>
                                </thead>
                                <tbody id="midaTableBody"></tbody>
                            </table>
                        </div>
                        
                        <!-- Balance Sheet Update Section (MIDA tab only) -->
                        <div id="databaseUpdateSection" class="hidden" style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; border: 1px solid #e0e0e0;">
                            <div style="display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap;">
                                <div class="form-group" style="margin: 0;">
                                    <label for="declarationNumber" style="font-weight: 600; color: #555; font-size: 0.85rem;">Declaration Form Reg No</label>
                                    <input type="text" id="declarationNumber" placeholder="e.g., Bxxxxxx" style="width: 180px; padding: 0.5rem; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 0.9rem;">
                                </div>
                                <button id="updateDatabaseBtn" style="background: #3498db; color: white; border: none; border-radius: 4px; padding: 0.6rem 1.2rem; cursor: pointer; font-weight: 600;" onclick="updateClassifiedDatabase()">
                                    📊 Update Balance Sheet
                                </button>
                            </div>
                            <p style="font-size: 0.85rem; color: #7f8c8d; margin-top: 0.5rem;">
                                Note: Only non-manually-moved MIDA items with certificate matches will be updated.
                            </p>
                        </div>
                    </div>
                    
                    <!-- Duties Payable Content -->
                    <div id="duties-content" class="classification-content">
                        <div style="overflow-x: auto;">
                            <table id="dutiesTable">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;"><input type="checkbox" onchange="toggleSelectAllItems('duties_payable', this.checked)"></th>
                                        <th>Line</th>
                                        <th>Parts Name</th>
                                        <th>HS Code</th>
                                        <th>Qty</th>
                                        <th>UOM</th>
                                        <th>Net Wt (Kg)</th>
                                        <th>Amount (USD)</th>
                                        <th>SST Exempt <button class="toggle-all-sst-btn" onclick="toggleAllSST('duties_payable')" title="Toggle All">☑</button></th>
                                        <th>Move</th>
                                    </tr>
                                </thead>
                                <tbody id="dutiesTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Export Buttons -->
                    <div class="export-buttons">
                        <button class="export-btn form-d" id="exportFormDBtn" onclick="exportClassifiedK1('form_d')">
                            📥 Export Form-D
                        </button>
                        <button class="export-btn mida" id="exportMidaBtn" onclick="exportClassifiedK1('mida')">
                            📥 Export MIDA
                        </button>
                        <button class="export-btn duties" id="exportDutiesBtn" onclick="exportClassifiedK1('duties_payable')">
                            📥 Export Duties Payable
                        </button>
                    </div>
                </div>
                
                <!-- Legacy: Matched Items Table (kept for backward compatibility) -->
                <div id="matchedItemsSection" class="hidden">
                    <h3>✅ Matched Items (MIDA-Eligible)</h3>
                    <div style="overflow-x: auto;">
                        <table id="matchedItemsTable">
                            <thead>
                                <tr>
                                    <th>Line</th>
                                    <th>Invoice Part Name</th>
                                    <th>Model No</th>
                                    <th>Qty</th>
                                    <th>Net Wt (Kg)</th>
                                    <th>Certificate</th>
                                    <th>MIDA Line</th>
                                    <th>MIDA Item</th>
                                    <th>MIDA HS Code</th>
                                    <th>Remaining</th>
                                    <th>Deduction</th>
                                    <th>Score</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Legacy: All Invoice Items (Normal Mode) -->
                <div id="allItemsSection" class="hidden">
                    <div class="view-toggle">
                        <button id="viewFilteredBtn" class="toggle-btn active" onclick="switchToFilteredView()">
                            📋 Non-FORM-D Items Only
                        </button>
                        <button id="viewFullBtn" class="toggle-btn" onclick="switchToFullView()">
                            📄 All Items (incl. FORM-D & Total)
                        </button>
                    </div>
                    <h3 id="itemsTableTitle">📋 Invoice Items with Empty Form Flag (Non-FORM-D)</h3>
                    <div style="overflow-x: auto;">
                        <table id="allItemsTable">
                            <thead id="allItemsTableHead">
                                <tr>
                                    <th>Line</th>
                                    <th>Parts No</th>
                                    <th>Parts Name</th>
                                    <th>HS Code</th>
                                    <th>Qty</th>
                                    <th>Amount (USD)</th>
                                    <th>Net Wt (Kg)</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div id="tableActionButtons" style="margin-top: 1rem; display: flex; gap: 0.75rem; justify-content: flex-end; align-items: flex-end; flex-wrap: wrap;">
                        <button id="exportK1Btn" class="toggle-btn" style="background: #27ae60; color: white; border-color: #27ae60; padding: 0.6rem 1.2rem;" onclick="exportK1Xls()">
                            📥 Export K1 XLS
                        </button>
                    </div>
                </div>
                
                <!-- Warnings Section -->
                <div id="warningsSection" class="warnings-section hidden">
                    <h3>⚠️ Warnings</h3>
                    <div id="warningsList"></div>
                </div>
                
                <!-- Raw JSON -->
                <details style="margin-top: 1.5rem;">
                    <summary style="cursor: pointer; color: #7f8c8d;">Show Raw JSON Response</summary>
                    <pre id="rawResult"></pre>
                </details>
            </div>
            
            <!-- Error Display -->
            <div id="converterError" class="error-message hidden">
                <h4>❌ Error</h4>
                <p id="errorText"></p>
            </div>
            
            <!-- Loading -->
            <div id="converterLoading" class="loading hidden">Processing invoice...</div>
        </div>
    </div>
    
    <!-- Parser Tab -->
    <div id="parser-tab" class="tab-content">
        <div class="container">
            <h2>🔍 MIDA Certificate Parser</h2>
            <p>Upload a MIDA certificate PDF to parse and extract data into an editable table.</p>
            
            <div class="form-group">
                <label for="pdfInput">Certificate PDF</label>
                <input type="file" id="pdfInput" accept=".pdf">
            </div>
            
            <button onclick="parseCertificate()" id="parseBtn">Parse Certificate</button>
            
            <!-- Loading -->
            <div id="parserLoading" class="loading hidden">Processing certificate...</div>
            
            <!-- Error Display -->
            <div id="parserError" class="error-message hidden">
                <h4>❌ Error</h4>
                <p id="parserErrorText"></p>
            </div>
            
            <!-- Parser Results -->
            <div id="parserResults" class="parser-results hidden">
                <!-- Discrepancy Warning Banner -->
                <div id="discrepancyWarning" class="discrepancy-warning hidden">
                    <h4>⚠️ Quantity Discrepancies Detected</h4>
                    <p>The following rows have a mismatch between Approved Quantity and the sum of station quantities (Port Klang + KLIA + Bukit Kayu Hitam):</p>
                    <ul id="discrepancyList"></ul>
                    <p style="margin-top: 0.5rem; font-size: 0.9rem;">Please review and correct these values before saving to database.</p>
                </div>
                
                <!-- Missing Data Warning Banner (Blocks Save) -->
                <div id="missingDataWarning" class="missing-data-warning hidden">
                    <h4>❌ Required Data Missing</h4>
                    <p>The following required fields are missing. You must fill in all required data before saving to database:</p>
                    <ul id="missingDataList"></ul>
                </div>
                
                <h3>📋 Certificate Data 
                    <span id="warningsBadge" class="warnings-badge hidden"></span>
                </h3>
                
                <!-- Certificate Header Fields -->
                <div class="cert-header" id="certHeader">
                    <div class="cert-header-field">
                        <label>Certificate Number</label>
                        <div class="value" id="certNumber" data-field="certificate_number">-</div>
                    </div>
                    <div class="cert-header-field">
                        <label>Company Name</label>
                        <div class="value" id="certCompany" data-field="company_name">-</div>
                    </div>
                    <div class="cert-header-field">
                        <label>Model Number</label>
                        <div class="value" id="certModelNumber" data-field="model_number">-</div>
                    </div>
                    <div class="cert-header-field">
                        <label>Exemption Start Date</label>
                        <div class="value" id="certStartDate" data-field="exemption_start_date">-</div>
                    </div>
                    <div class="cert-header-field">
                        <label>Exemption End Date</label>
                        <div class="value" id="certEndDate" data-field="exemption_end_date">-</div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button id="editBtn" class="btn-edit" onclick="toggleEditMode()">✏️ Edit Data</button>
                    <button id="saveDatabaseBtn" class="btn-database" onclick="showSaveConfirmation()">💾 Save to Database</button>
                    <button id="saveBtn" class="btn-save hidden" onclick="saveChanges()">✅ Save Changes</button>
                    <button id="cancelBtn" class="btn-cancel hidden" onclick="cancelEdit()">❌ Cancel</button>
                </div>
                
                <!-- Items Table -->
                <h3>📦 Certificate Items</h3>
                <div class="items-table-container">
                    <table class="items-table" id="certItemsTable">
                        <thead>
                            <tr>
                                <th>Line No</th>
                                <th>HS Code</th>
                                <th>Item Name</th>
                                <th>Approved Qty</th>
                                <th>UOM</th>
                                <th>Port Klang</th>
                                <th>KLIA</th>
                                <th>Bukit Kayu Hitam</th>
                                <th class="actions-column" id="actionsColumnHeader">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="certItemsBody">
                        </tbody>
                    </table>
                </div>
                
                <!-- Success message -->
                <div id="saveSuccess" class="success-message hidden">
                    <h4>✅ Changes Saved</h4>
                    <p>Your edits have been saved successfully.</p>
                </div>
                
                <!-- Warnings Section -->
                <div id="parserWarnings" class="warnings-section hidden">
                    <h3>⚠️ OCR Warnings</h3>
                    <div id="parserWarningsList"></div>
                </div>
                
                <!-- Raw JSON -->
                <details style="margin-top: 1.5rem;">
                    <summary style="cursor: pointer; color: #7f8c8d;">Show Raw JSON Response</summary>
                    <pre id="parserRawResult"></pre>
                </details>
            </div>
        </div>
    </div>
    
    <!-- Database View Tab -->
    <div id="database-tab" class="tab-content">
        <div class="container">
            <h2>🗄️ Database View</h2>
            <p>Browse MIDA certificates, items, and import records stored in the database.</p>
            
            <!-- Breadcrumb Navigation -->
            <div class="breadcrumb" id="dbBreadcrumb">
                <span class="breadcrumb-item active" onclick="dbNavigateToCertificates()">📋 Certificates</span>
            </div>
            
            <!-- Loading -->
            <div id="dbLoading" class="loading hidden">Loading data...</div>
            
            <!-- Error Display -->
            <div id="dbError" class="error-message hidden">
                <h4>❌ Error</h4>
                <p id="dbErrorText"></p>
            </div>
            
            <!-- Certificates View (Level 1) -->
            <div id="certificatesView">
                <!-- Sub-tabs for Active/Deleted Certificates -->
                <div class="db-sub-tabs">
                    <button class="db-sub-tab active" id="activeCertsTab" onclick="switchDbSubTab('active')">
                        📋 Active Certificates
                    </button>
                    <button class="db-sub-tab" id="deletedCertsTab" onclick="switchDbSubTab('deleted')">
                        🗑️ Deleted Certificates
                    </button>
                </div>
                
                <!-- Active Certificates Table -->
                <div id="activeCertificatesSection">
                    <!-- Toolbar -->
                    <div class="table-toolbar">
                        <div class="table-toolbar-left">
                            <span class="table-toolbar-title">📋 MIDA Certificates</span>
                        </div>
                        <button class="btn-add" onclick="showAddCertificateModal()">
                            ➕ Add Certificate
                        </button>
                    </div>
                    <div style="overflow-x: auto;">
                        <table id="certificatesTable">
                            <thead>
                                <tr>
                                    <th>Certificate Number</th>
                                    <th>Company Name</th>
                                    <th>Start Date</th>
                                    <th>End Date</th>
                                    <th>Status</th>
                                    <th>Items</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="certificatesTableBody">
                            </tbody>
                        </table>
                    </div>
                    <div id="certificatesPagination" class="pagination-container hidden">
                        <div class="pagination-left">
                            <div class="pagination-info" id="certificatesPaginationInfo"></div>
                            <div class="rows-per-page">
                                <label>Rows per page:</label>
                                <select id="certificatesPerPageSelect" onchange="changeCertificatesPerPage(this.value)">
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                    <option value="100" selected>100</option>
                                    <option value="200">200</option>
                                </select>
                            </div>
                        </div>
                        <div class="pagination-controls" id="certificatesPaginationControls"></div>
                    </div>
                </div>
                
                <!-- Deleted Certificates Table -->
                <div id="deletedCertificatesSection" class="hidden">
                    <div style="overflow-x: auto;">
                        <table id="deletedCertificatesTable">
                            <thead>
                                <tr>
                                    <th>Certificate Number</th>
                                    <th>Company Name</th>
                                    <th>Start Date</th>
                                    <th>End Date</th>
                                    <th>Deleted At</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="deletedCertificatesTableBody">
                            </tbody>
                        </table>
                    </div>
                    <div id="deletedCertificatesPagination" class="pagination-container hidden">
                        <div class="pagination-left">
                            <div class="pagination-info" id="deletedCertificatesPaginationInfo"></div>
                            <div class="rows-per-page">
                                <label>Rows per page:</label>
                                <select id="deletedCertificatesPerPageSelect" onchange="changeDeletedCertificatesPerPage(this.value)">
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                    <option value="100" selected>100</option>
                                    <option value="200">200</option>
                                </select>
                            </div>
                        </div>
                        <div class="pagination-controls" id="deletedCertificatesPaginationControls"></div>
                    </div>
                </div>
            </div>
            
            <!-- Certificate Items View (Level 2) -->
            <div id="itemsView" class="hidden">
                <button class="back-btn" onclick="dbNavigateToCertificates()">← Back to Certificates</button>
                
                <!-- Selected Certificate Info Card -->
                <div class="info-card" id="selectedCertificateInfo">
                    <div class="info-card-title">Selected Certificate</div>
                    <div class="info-card-grid">
                        <div class="info-card-item">
                            <span class="info-card-label">Certificate Number</span>
                            <span class="info-card-value" id="infoCertNumber">-</span>
                        </div>
                        <div class="info-card-item">
                            <span class="info-card-label">Company Name</span>
                            <span class="info-card-value" id="infoCertCompany">-</span>
                        </div>
                        <div class="info-card-item">
                            <span class="info-card-label">Model Number</span>
                            <span class="info-card-value" id="infoCertModelNumber">-</span>
                        </div>
                        <div class="info-card-item">
                            <span class="info-card-label">Valid Period</span>
                            <span class="info-card-value" id="infoCertPeriod">-</span>
                        </div>
                        <div class="info-card-item">
                            <span class="info-card-label">Status</span>
                            <span class="info-card-value" id="infoCertStatus">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- Items Table Header with Toolbar -->
                <div class="table-toolbar">
                    <div class="table-toolbar-left">
                        <span class="table-toolbar-title">📦 Certificate Items</span>
                        <!-- Quantity Toggle -->
                        <div class="qty-toggle-switch" style="margin-left: 1rem;">
                            <button class="qty-toggle-btn active" id="toggleApproved" onclick="toggleQuantityView('approved')">Approved</button>
                            <button class="qty-toggle-btn" id="toggleRemaining" onclick="toggleQuantityView('remaining')">Remaining</button>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <button class="btn-action btn-action-edit" onclick="showEditCertificateModal()" title="Edit Certificate Header">
                            ✏️ Edit Certificate
                        </button>
                        <button class="btn-add" onclick="showAddItemModal()">
                            ➕ Add Item
                        </button>
                    </div>
                </div>
                
                <div style="margin-bottom: 0.5rem; font-size: 0.85rem; color: #7f8c8d;">
                    <span class="qty-status-normal">●</span> Normal &nbsp;
                    <span class="qty-status-warning">●</span> Depleting &nbsp;
                    <span class="qty-status-depleted">●</span> Depleted &nbsp;
                    <span class="qty-status-overdrawn">●</span> Overdrawn
                </div>
                
                <div style="overflow-x: auto;">
                    <table id="itemsTable">
                        <thead>
                            <tr>
                                <th>Line</th>
                                <th>HS Code</th>
                                <th>Item Name</th>
                                <th>UOM</th>
                                <th class="number-cell">Total Qty</th>
                                <th class="number-cell">Port Klang</th>
                                <th class="number-cell">KLIA</th>
                                <th class="number-cell">Bukit Kayu Hitam</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="itemsTableBody">
                        </tbody>
                    </table>
                </div>
                <div id="itemsPagination" class="pagination-container hidden">
                    <div class="pagination-left">
                        <div class="pagination-info" id="itemsPaginationInfo"></div>
                        <div class="rows-per-page">
                            <label>Rows per page:</label>
                            <select id="itemsPerPageSelect" onchange="changeItemsPerPage(this.value)">
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100" selected>100</option>
                                <option value="200">200</option>
                            </select>
                        </div>
                    </div>
                    <div class="pagination-controls" id="itemsPaginationControls"></div>
                </div>
            </div>
            
            <!-- Import Records View (Level 3) -->
            <div id="importsView" class="hidden">
                <button class="back-btn" onclick="dbNavigateToItems()">← Back to Items</button>
                
                <!-- Selected Item Info Card -->
                <div class="info-card" id="selectedItemInfo">
                    <div class="info-card-title">Selected Item</div>
                    <div class="info-card-grid">
                        <div class="info-card-item">
                            <span class="info-card-label">Certificate</span>
                            <span class="info-card-value" id="infoItemCert">-</span>
                        </div>
                        <div class="info-card-item">
                            <span class="info-card-label">HS Code</span>
                            <span class="info-card-value" id="infoItemHsCode">-</span>
                        </div>
                        <div class="info-card-item">
                            <span class="info-card-label">Item Name</span>
                            <span class="info-card-value" id="infoItemName">-</span>
                        </div>
                        <div class="info-card-item">
                            <span class="info-card-label">UOM</span>
                            <span class="info-card-value" id="infoItemUom">-</span>
                        </div>
                    </div>
                </div>
                
                <h3>📥 Import Records</h3>
                
                <!-- Port Filter -->
                <div class="port-filter-container">
                    <button class="port-filter-btn active" data-port="all" onclick="filterByPort('all')">🌐 All Ports</button>
                    <button class="port-filter-btn" data-port="port_klang" onclick="filterByPort('port_klang')">🚢 Port Klang</button>
                    <button class="port-filter-btn" data-port="klia" onclick="filterByPort('klia')">✈️ KLIA</button>
                    <button class="port-filter-btn" data-port="bukit_kayu_hitam" onclick="filterByPort('bukit_kayu_hitam')">🚛 Bukit Kayu Hitam</button>
                </div>
                
                <div style="overflow-x: auto;">
                    <table id="importsTable">
                        <thead>
                            <tr>
                                <th>Import Date</th>
                                <th>Invoice Number</th>
                                <th>Invoice Line</th>
                                <th>Port</th>
                                <th class="number-cell">Qty Imported</th>
                                <th class="number-cell">Before Balance</th>
                                <th class="number-cell">After Balance</th>
                                <th>Remarks</th>
                            </tr>
                        </thead>
                        <tbody id="importsTableBody">
                        </tbody>
                    </table>
                </div>
                <div id="importsPagination" class="pagination-container hidden">
                    <div class="pagination-left">
                        <div class="pagination-info" id="importsPaginationInfo"></div>
                        <div class="rows-per-page">
                            <label>Rows per page:</label>
                            <select id="importsPerPageSelect" onchange="changeImportsPerPage(this.value)">
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100" selected>100</option>
                                <option value="200">200</option>
                            </select>
                        </div>
                    </div>
                    <div class="pagination-controls" id="importsPaginationControls"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Use relative URL when served from same origin, or localhost for local file access
        const API_BASE = window.location.protocol === 'file:' ? 'http://localhost:8000' : '';
        
        // ==========================================
        // Workflow Navigation History System
        // ==========================================
        
        /**
         * WorkflowHistory - A comprehensive navigation history and state management system
         * 
         * Features:
         * - Tracks navigation through tabs, sub-views, and drill-downs
         * - Saves state snapshots before major operations
         * - Supports "go back" with proper state restoration
         * - Handles unsaved changes with user prompts
         * - Keyboard shortcuts (Alt+← for back, Escape to cancel)
         * 
         * State Categories:
         * - Navigation: current tab, sub-view, database drill-down level
         * - Form Data: classification results, parsed certificate data
         * - Selections: selected company, certificates, items
         * - UI State: scroll positions, active filters, expanded sections
         */
        class WorkflowHistory {
            constructor() {
                this.stack = [];  // Navigation history stack
                this.maxStackSize = 50;  // Prevent memory issues
                this.hasUnsavedChanges = false;
                this.unsavedChangeContext = null;  // What has unsaved changes
                this.pendingNavigation = null;  // Stores nav action if user needs to confirm
                this.isNavigating = false;  // Prevent recursive navigation
                
                // Initialize with home state
                this.pushState({
                    type: 'tab',
                    tab: 'converter',
                    label: '📄 Invoice Converter',
                    timestamp: Date.now()
                });
                
                // Set up keyboard shortcuts
                this.setupKeyboardShortcuts();
                
                // Set up beforeunload warning
                this.setupBeforeUnload();
            }
            
            /**
             * Get the current state (top of stack)
             */
            getCurrentState() {
                return this.stack[this.stack.length - 1] || null;
            }
            
            /**
             * Get the previous state (for go back)
             */
            getPreviousState() {
                return this.stack.length > 1 ? this.stack[this.stack.length - 2] : null;
            }
            
            /**
             * Push a new navigation state onto the stack
             * @param {Object} state - The state to push
             */
            pushState(state) {
                // Don't push duplicate states
                const current = this.getCurrentState();
                if (current && this.areStatesEqual(current, state)) {
                    return;
                }
                
                // Add metadata
                state.timestamp = state.timestamp || Date.now();
                state.scrollY = window.scrollY;
                
                this.stack.push(state);
                
                // Trim stack if too large
                if (this.stack.length > this.maxStackSize) {
                    this.stack = this.stack.slice(-this.maxStackSize);
                }
                
                this.updateUI();
            }
            
            /**
             * Replace the current state (for updates without creating new history)
             */
            replaceState(state) {
                if (this.stack.length > 0) {
                    state.timestamp = Date.now();
                    state.scrollY = window.scrollY;
                    this.stack[this.stack.length - 1] = state;
                    this.updateUI();
                }
            }
            
            /**
             * Go back to the previous state
             * @returns {boolean} Whether navigation occurred
             */
            async goBack() {
                if (this.isNavigating) return false;
                if (this.stack.length <= 1) return false;
                
                // Check for unsaved changes
                if (this.hasUnsavedChanges) {
                    const shouldContinue = await this.promptUnsavedChanges();
                    if (!shouldContinue) return false;
                }
                
                this.isNavigating = true;
                
                try {
                    // Pop current state
                    const currentState = this.stack.pop();
                    const previousState = this.getCurrentState();
                    
                    if (!previousState) {
                        this.stack.push(currentState); // Restore if no previous
                        return false;
                    }
                    
                    // Restore the previous state
                    await this.restoreState(previousState, currentState);
                    
                    this.updateUI();
                    return true;
                } finally {
                    this.isNavigating = false;
                }
            }
            
            /**
             * Navigate to a specific point in history (for breadcrumb clicks)
             * @param {number} index - The stack index to navigate to
             */
            async navigateToIndex(index) {
                if (this.isNavigating) return;
                if (index < 0 || index >= this.stack.length - 1) return;
                
                // Check for unsaved changes
                if (this.hasUnsavedChanges) {
                    const shouldContinue = await this.promptUnsavedChanges();
                    if (!shouldContinue) return;
                }
                
                this.isNavigating = true;
                
                try {
                    // Pop states until we reach the target
                    const targetState = this.stack[index];
                    const currentState = this.getCurrentState();
                    this.stack = this.stack.slice(0, index + 1);
                    
                    await this.restoreState(targetState, currentState);
                    this.updateUI();
                } finally {
                    this.isNavigating = false;
                }
            }
            
            /**
             * Restore a state - navigate UI to match the state
             */
            async restoreState(state, fromState) {
                switch (state.type) {
                    case 'tab':
                        this.restoreTabState(state);
                        break;
                    case 'database-certificates':
                        this.restoreDatabaseCertificatesState(state);
                        break;
                    case 'database-items':
                        await this.restoreDatabaseItemsState(state);
                        break;
                    case 'database-imports':
                        await this.restoreDatabaseImportsState(state);
                        break;
                    case 'classification-result':
                        this.restoreClassificationState(state);
                        break;
                    case 'parser-result':
                        this.restoreParserState(state);
                        break;
                }
                
                // Restore scroll position
                if (state.scrollY !== undefined) {
                    setTimeout(() => window.scrollTo(0, state.scrollY), 100);
                }
            }
            
            /**
             * Restore tab navigation state
             */
            restoreTabState(state) {
                // Use the internal switch without pushing to history
                this.switchTabInternal(state.tab);
                
                // Restore sub-state if any
                if (state.subView) {
                    this.restoreSubView(state);
                }
            }
            
            /**
             * Restore database certificates view
             */
            restoreDatabaseCertificatesState(state) {
                this.switchTabInternal('database');
                
                // Show certificates view
                hideElement('itemsView');
                hideElement('importsView');
                showElement('certificatesView');
                
                // Restore sub-tab (active/deleted)
                if (state.subTab === 'deleted') {
                    switchDbSubTab('deleted');
                } else {
                    switchDbSubTab('active');
                }
                
                // Restore page if saved
                if (state.page) {
                    dbState.certificatesPage = state.page;
                    loadCertificates(state.page);
                }
            }
            
            /**
             * Restore database items view
             */
            async restoreDatabaseItemsState(state) {
                this.switchTabInternal('database');
                
                // Ensure we have the certificate
                if (state.certificate) {
                    dbState.selectedCertificate = state.certificate;
                    
                    // Update UI
                    document.getElementById('infoCertNumber').textContent = state.certificate.certificate_number || '-';
                    document.getElementById('infoCertCompany').textContent = state.certificate.company_name || '-';
                    document.getElementById('infoCertModelNumber').textContent = state.certificate.model_number || '-';
                    document.getElementById('infoCertPeriod').textContent = 
                        `${formatDate(state.certificate.exemption_start_date)} - ${formatDate(state.certificate.exemption_end_date)}`;
                    document.getElementById('infoCertStatus').innerHTML = 
                        `<span class="status-badge ${state.certificate.status}">${state.certificate.status}</span>`;
                    
                    updateBreadcrumb('items', { certificateNumber: state.certificate.certificate_number });
                }
                
                hideElement('certificatesView');
                hideElement('importsView');
                showElement('itemsView');
                
                // Restore quantity view
                if (state.quantityView) {
                    toggleQuantityView(state.quantityView);
                }
                
                // Reload items if we have a certificate
                if (state.certificate?.id) {
                    await loadCertificateItems(state.certificate.id, state.page || 1);
                }
            }
            
            /**
             * Restore database imports view
             */
            async restoreDatabaseImportsState(state) {
                this.switchTabInternal('database');
                
                // Restore certificate and item context
                if (state.certificate) {
                    dbState.selectedCertificate = state.certificate;
                }
                if (state.item) {
                    dbState.selectedItem = state.item;
                    
                    // Update info card
                    document.getElementById('infoItemCert').textContent = 
                        dbState.selectedCertificate?.certificate_number || state.item.certificate_number || '-';
                    document.getElementById('infoItemHsCode').textContent = state.item.hs_code || state.item.item_hs_code || '-';
                    document.getElementById('infoItemName').textContent = state.item.item_name || '-';
                    document.getElementById('infoItemUom').textContent = state.item.uom || state.item.item_uom || '-';
                    
                    updateBreadcrumb('imports', {
                        certificateNumber: dbState.selectedCertificate?.certificate_number || state.item.certificate_number,
                        itemName: state.item.item_name || `Line ${state.item.line_no}`
                    });
                }
                
                hideElement('certificatesView');
                hideElement('itemsView');
                showElement('importsView');
                
                // Restore port filter
                if (state.port) {
                    document.querySelectorAll('.port-filter-btn').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.port === state.port);
                    });
                    dbState.currentPort = state.port;
                }
                
                // Reload imports
                if (state.item?.item_id) {
                    await loadImportRecords(state.item.item_id, state.port || 'all', state.page || 1);
                }
            }
            
            /**
             * Restore classification results state
             */
            restoreClassificationState(state) {
                this.switchTabInternal('converter');
                
                // Restore classification data if saved
                if (state.classificationData) {
                    // classificationData is the global variable used for classification results
                    classificationData.form_d_items = state.classificationData.form_d || [];
                    classificationData.mida_items = state.classificationData.mida || [];
                    classificationData.duties_payable_items = state.classificationData.duties_payable || [];
                    
                    // Re-render tables
                    renderClassificationTable('form_d');
                    renderClassificationTable('mida');
                    renderClassificationTable('duties_payable');
                    updateTabCounts();
                    
                    // Show results section
                    showElement('converterResults');
                    showElement('classificationSection');
                    
                    // Switch to active classification tab
                    if (state.activeClassificationTab) {
                        switchClassificationTab(state.activeClassificationTab);
                    }
                }
            }
            
            /**
             * Restore parser results state
             */
            restoreParserState(state) {
                this.switchTabInternal('parser');
                
                if (state.parsedData) {
                    displayParsedCertificate(state.parsedData);
                }
            }
            
            /**
             * Internal tab switch that doesn't push to history
             */
            switchTabInternal(tabName) {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                
                const tabContent = document.querySelector(`.tab-content#${tabName}-tab`);
                const tabButton = document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`);
                
                if (tabContent) tabContent.classList.add('active');
                if (tabButton) tabButton.classList.add('active');
            }
            
            /**
             * Compare two states for equality (to prevent duplicates)
             */
            areStatesEqual(a, b) {
                if (a.type !== b.type) return false;
                if (a.tab !== b.tab) return false;
                if (a.type === 'database-items' && a.certificate?.id !== b.certificate?.id) return false;
                if (a.type === 'database-imports' && a.item?.item_id !== b.item?.item_id) return false;
                return true;
            }
            
            /**
             * Mark that there are unsaved changes
             */
            setUnsavedChanges(hasChanges, context = null) {
                this.hasUnsavedChanges = hasChanges;
                this.unsavedChangeContext = context;
                this.updateWorkflowStatus();
            }
            
            /**
             * Prompt user about unsaved changes
             * @returns {Promise<boolean>} True if user wants to continue (discard changes)
             */
            async promptUnsavedChanges() {
                return new Promise((resolve) => {
                    const context = this.unsavedChangeContext || 'this page';
                    const result = confirm(
                        `You have unsaved changes in ${context}.\n\n` +
                        `Do you want to discard these changes and go back?`
                    );
                    
                    if (result) {
                        this.hasUnsavedChanges = false;
                        this.unsavedChangeContext = null;
                        this.updateWorkflowStatus();
                    }
                    
                    resolve(result);
                });
            }
            
            /**
             * Update the navigation UI (back button, breadcrumbs)
             */
            updateUI() {
                this.updateBackButton();
                this.updateBreadcrumbs();
                this.updateWorkflowStatus();
            }
            
            /**
             * Update the back button state
             */
            updateBackButton() {
                const backBtn = document.getElementById('globalBackBtn');
                if (backBtn) {
                    const canGoBack = this.stack.length > 1;
                    backBtn.disabled = !canGoBack;
                    
                    // Update tooltip
                    const prevState = this.getPreviousState();
                    if (prevState) {
                        backBtn.title = `Go back to ${prevState.label || 'previous page'} (Alt+←)`;
                    } else {
                        backBtn.title = 'No previous page';
                    }
                }
            }
            
            /**
             * Update the workflow breadcrumbs
             */
            updateBreadcrumbs() {
                const breadcrumb = document.getElementById('workflowBreadcrumb');
                if (!breadcrumb) return;
                
                let html = '';
                
                this.stack.forEach((state, index) => {
                    const isLast = index === this.stack.length - 1;
                    const label = state.label || state.type;
                    
                    if (index > 0) {
                        html += '<span class="workflow-crumb-separator">›</span>';
                    }
                    
                    html += '<span class="workflow-crumb">';
                    if (isLast) {
                        html += `<span class="workflow-crumb-active">${escapeHtml(label)}</span>`;
                    } else {
                        html += `<span class="workflow-crumb-link" onclick="workflowHistory.navigateToIndex(${index})">${escapeHtml(label)}</span>`;
                    }
                    html += '</span>';
                });
                
                breadcrumb.innerHTML = html;
            }
            
            /**
             * Update workflow status indicator
             */
            updateWorkflowStatus() {
                const statusEl = document.getElementById('workflowStatus');
                const statusText = document.getElementById('workflowStatusText');
                
                if (!statusEl || !statusText) return;
                
                if (this.hasUnsavedChanges) {
                    statusEl.style.display = 'flex';
                    statusEl.classList.add('has-changes');
                    statusText.textContent = 'Unsaved changes';
                } else {
                    statusEl.style.display = 'none';
                    statusEl.classList.remove('has-changes');
                }
            }
            
            /**
             * Set up keyboard shortcuts
             */
            setupKeyboardShortcuts() {
                document.addEventListener('keydown', async (e) => {
                    // Alt + Left Arrow = Go Back
                    if (e.altKey && e.key === 'ArrowLeft') {
                        e.preventDefault();
                        await this.goBack();
                    }
                    
                    // Escape = Cancel current operation or go back
                    if (e.key === 'Escape') {
                        // Check if a modal is open
                        const openModal = document.querySelector('.modal-overlay.active');
                        if (openModal) {
                            // Let the modal handle its own escape
                            return;
                        }
                        
                        // Check if in edit mode
                        const editBtn = document.getElementById('editBtn');
                        const cancelBtn = document.getElementById('cancelBtn');
                        if (cancelBtn && !cancelBtn.classList.contains('hidden')) {
                            e.preventDefault();
                            cancelEdit();
                            return;
                        }
                    }
                });
            }
            
            /**
             * Set up beforeunload warning for unsaved changes
             */
            setupBeforeUnload() {
                window.addEventListener('beforeunload', (e) => {
                    if (this.hasUnsavedChanges) {
                        e.preventDefault();
                        e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
                        return e.returnValue;
                    }
                });
            }
            
            /**
             * Clear history (for full reset)
             */
            clear() {
                this.stack = [];
                this.hasUnsavedChanges = false;
                this.unsavedChangeContext = null;
                this.updateUI();
            }
        }
        
        // Create global instance
        const workflowHistory = new WorkflowHistory();
        
        // ==========================================
        // End Workflow History System
        // ==========================================
        
        // Set default import date to today
        document.addEventListener('DOMContentLoaded', async function() {
            const importDateInput = document.getElementById('importDate');
            if (importDateInput) {
                const today = new Date().toISOString().split('T')[0];
                importDateInput.value = today;
            }
            
            // Load companies on page load
            await loadCompanies();
            
            // Initialize workflow history UI
            workflowHistory.updateUI();
        });
        
        // Tab switching - Enhanced with history tracking
        function switchTab(tabName) {
            // Get current tab for comparison
            const currentTab = document.querySelector('.tab.active');
            const currentTabName = currentTab ? currentTab.textContent.trim() : '';
            
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            document.querySelector(`.tab-content#${tabName}-tab`).classList.add('active');
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            // Push to history
            const tabLabels = {
                'converter': '📄 Invoice Converter',
                'parser': '🔍 Certificate Parser',
                'database': '🗄️ Database View'
            };
            
            workflowHistory.pushState({
                type: 'tab',
                tab: tabName,
                label: tabLabels[tabName] || tabName
            });
        }
        
        // Store all certificates for the selected company (for filtering)
        let allCertificatesForCompany = [];
        
        // Load companies for the dropdown (from companies table)
        async function loadCompanies() {
            const companySelect = document.getElementById('companySelect');
            const loadingText = document.getElementById('companyLoadingText');
            
            loadingText.classList.remove('hidden');
            companySelect.disabled = true;
            
            try {
                // Fetch companies from the companies API endpoint
                const response = await fetch(`${API_BASE}/api/companies`);
                
                if (!response.ok) {
                    loadingText.textContent = '❌ Failed to load companies';
                    return;
                }
                
                const companies = await response.json();
                
                companySelect.innerHTML = '<option value="">-- Select Company (Required) --</option>';
                
                if (companies && companies.length > 0) {
                    companies.forEach(company => {
                        const option = document.createElement('option');
                        option.value = company.id;  // Use company ID as value
                        option.textContent = company.name;
                        option.dataset.sstDefault = company.sst_default_behavior;
                        option.dataset.dualFlagRouting = company.dual_flag_routing;
                        companySelect.appendChild(option);
                    });
                    loadingText.classList.add('hidden');
                } else {
                    loadingText.textContent = '📭 No companies found';
                }
                
            } catch (error) {
                console.error('Error loading companies:', error);
                loadingText.textContent = '❌ Error connecting to database';
            } finally {
                companySelect.disabled = false;
            }
        }
        
        // Handle company selection change
        function onCompanyChange() {
            // Load certificates for the selected company
            loadCertificatesForCompany();
        }
        
        // Load certificates for the selected company
        async function loadCertificatesForCompany() {
            const companySelect = document.getElementById('companySelect');
            const certificateList = document.getElementById('certificateList');
            const certificateListSection = document.getElementById('certificateListSection');
            const loadingText = document.getElementById('certLoadingText');
            const selectedCertsInfo = document.getElementById('selectedCertsInfo');
            
            const companyId = companySelect.value;
            const companyName = companySelect.options[companySelect.selectedIndex]?.textContent || '';
            
            // Clear previous certificates
            allCertificatesForCompany = [];
            selectedCertsInfo.innerHTML = '';
            
            if (!companyId) {
                certificateList.innerHTML = '<p style="color: #7f8c8d; text-align: center; margin: 1rem 0;">Select a company to view certificates</p>';
                certificateListSection.classList.add('hidden');
                return;
            }
            
            certificateListSection.classList.remove('hidden');
            loadingText.classList.remove('hidden');
            certificateList.innerHTML = '<p style="color: #7f8c8d; text-align: center;">Loading...</p>';
            
            try {
                // Use company name for the certificate lookup (existing API)
                const url = `${API_BASE}/api/mida/certificates/by-company/${encodeURIComponent(companyName)}?status=active`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    loadingText.textContent = '❌ Failed to load certificates';
                    return;
                }
                
                const data = await response.json();
                
                if (data.certificates && data.certificates.length > 0) {
                    allCertificatesForCompany = data.certificates;
                    renderCertificateList(data.certificates);
                    loadingText.classList.add('hidden');
                } else {
                    certificateList.innerHTML = '<p style="color: #7f8c8d; text-align: center; margin: 1rem 0;">No active certificates found for this company</p>';
                    loadingText.classList.add('hidden');
                }
                
            } catch (error) {
                console.error('Error loading certificates:', error);
                loadingText.textContent = '❌ Error connecting to database';
                certificateList.innerHTML = '<p style="color: #e74c3c; text-align: center; margin: 1rem 0;">Error loading certificates</p>';
            }
        }
        
        // Render the certificate checkbox list
        function renderCertificateList(certificates) {
            const certificateList = document.getElementById('certificateList');
            
            if (!certificates || certificates.length === 0) {
                certificateList.innerHTML = '<p style="color: #7f8c8d; text-align: center; margin: 1rem 0;">No certificates match your search</p>';
                return;
            }
            
            let html = '';
            certificates.forEach(cert => {
                const expDate = cert.exemption_end_date ? new Date(cert.exemption_end_date).toLocaleDateString() : 'N/A';
                const isExpiringSoon = cert.exemption_end_date && new Date(cert.exemption_end_date) < new Date(Date.now() + 30 * 24 * 60 * 60 * 1000);
                const expiryClass = isExpiringSoon ? 'color: #e74c3c; font-weight: bold;' : '';
                
                html += `
                    <label style="display: flex; align-items: flex-start; padding: 0.5rem; margin-bottom: 0.25rem; background: #f8f9fa; border-radius: 4px; cursor: pointer; border: 1px solid transparent; transition: all 0.2s;"
                           onmouseover="this.style.borderColor='#3498db'" onmouseout="this.style.borderColor='transparent'">
                        <input type="checkbox" class="cert-checkbox" value="${cert.id}" 
                               data-cert-number="${cert.certificate_number}" 
                               data-model-number="${cert.model_number || ''}"
                               data-end-date="${cert.exemption_end_date || ''}"
                               onchange="updateSelectedCertsInfo()"
                               style="margin-right: 0.75rem; margin-top: 0.25rem;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #2c3e50;">${escapeHtml(cert.certificate_number)}</div>
                            <div style="font-size: 0.85rem; color: #666;">
                                Model: ${escapeHtml(cert.model_number || 'N/A')} | 
                                Items: ${cert.item_count} | 
                                <span style="${expiryClass}">Expires: ${expDate}</span>
                            </div>
                        </div>
                    </label>
                `;
            });
            
            certificateList.innerHTML = html;
        }
        
        // Filter certificates based on search input
        function filterCertificates() {
            const searchInput = document.getElementById('certSearchInput').value.toLowerCase();
            
            if (!allCertificatesForCompany || allCertificatesForCompany.length === 0) {
                return;
            }
            
            const filtered = allCertificatesForCompany.filter(cert => {
                const certNum = (cert.certificate_number || '').toLowerCase();
                const modelNum = (cert.model_number || '').toLowerCase();
                return certNum.includes(searchInput) || modelNum.includes(searchInput);
            });
            
            renderCertificateList(filtered);
        }
        
        // Update the selected certificates info display
        function updateSelectedCertsInfo() {
            const checkboxes = document.querySelectorAll('.cert-checkbox:checked');
            const selectedCertsInfo = document.getElementById('selectedCertsInfo');
            
            if (checkboxes.length === 0) {
                selectedCertsInfo.innerHTML = '';
                return;
            }
            
            const certNumbers = Array.from(checkboxes).map(cb => cb.dataset.certNumber).join(', ');
            selectedCertsInfo.innerHTML = `<strong>Selected (${checkboxes.length}):</strong> ${certNumbers}`;
        }
        
        // Get selected certificate IDs
        function getSelectedCertificateIds() {
            const checkboxes = document.querySelectorAll('.cert-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }
        
        // Store matched items data for database update
        let matchedItemsForDatabase = [];
        
        // Store matched items for MIDA export (with MIDA HS codes)
        let matchedItemsForExport = [];
        
        // Update database with matched import records
        async function updateDatabase() {
            const selectedCertIds = getSelectedCertificateIds();
            const declarationNumber = document.getElementById('declarationNumber').value.trim();
            const importDate = document.getElementById('importDate').value;
            const port = document.getElementById('portSelect').value;
            
            // Validation
            if (selectedCertIds.length === 0) {
                showError('Please select at least one MIDA certificate.');
                return;
            }
            
            if (!importDate) {
                showError('Please enter an import date.');
                return;
            }
            
            if (!matchedItemsForDatabase || matchedItemsForDatabase.length === 0) {
                showError('No matched items to save. Please convert an invoice with MIDA matching first.');
                return;
            }
            
            // Check for items with missing deduction quantity (HSCODE not found errors)
            const itemsWithErrors = matchedItemsForDatabase.filter(item => item.deduction_quantity === null || item.deduction_quantity === undefined);
            if (itemsWithErrors.length > 0) {
                const errorItems = itemsWithErrors.map(item => `Line ${item.invoice_line}: ${item.description?.substring(0, 30) || 'Unknown'}`).join('\n');
                alert(`❌ Cannot update balance sheet. The following items have HSCODE errors (UOM could not be determined):\n\n${errorItems}\n\nPlease resolve these errors before updating.`);
                return;
            }
            
            const updateBtn = document.getElementById('updateDatabaseBtn');
            const originalText = updateBtn.textContent;
            updateBtn.disabled = true;
            updateBtn.textContent = '⏳ Saving...';
            
            try {
                // Build import records from matched items using deduction_quantity (based on hscode_uom)
                const importRecords = matchedItemsForDatabase.map(item => ({
                    certificate_item_id: item.mida_item_id,
                    import_date: importDate,
                    declaration_form_reg_no: declarationNumber || null,
                    invoice_number: item.invoice_number || 'UNKNOWN',
                    invoice_line: item.invoice_line,
                    quantity_imported: item.deduction_quantity,  // Use deduction_quantity (respects hscode_uom)
                    port: port,
                    remarks: `Matched with score ${item.match_score}, UOM: ${item.hscode_uom || 'N/A'}`
                }));
                
                const response = await fetch(`${API_BASE}/api/mida/imports/bulk`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ records: importRecords })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    const errorDetail = data.detail;
                    if (typeof errorDetail === 'object') {
                        showError(errorDetail.detail || 'Failed to update database');
                    } else {
                        showError(errorDetail || 'Failed to update database');
                    }
                    return;
                }
                
                // Success
                alert(`✅ Successfully saved ${data.length} import records to the database!\n\nRedirecting to Database View to see updated balances...`);
                updateBtn.textContent = '✅ Saved!';
                
                // Clear matched items since they've been saved
                matchedItemsForDatabase = [];
                
                // Redirect to Database View tab after a short delay
                setTimeout(() => {
                    updateBtn.textContent = originalText;
                    // Switch to database tab to show updated balances
                    switchTab('database');
                }, 1500);
                
            } catch (error) {
                console.error('Database update error:', error);
                showError('Error updating database: ' + error.message);
            } finally {
                updateBtn.disabled = false;
                if (updateBtn.textContent === '⏳ Saving...') {
                    updateBtn.textContent = originalText;
                }
            }
        }
        
        // ==================== CLASSIFICATION TAB FUNCTIONS ====================
        
        // Global state for classification
        let classificationData = {
            form_d_items: [],
            mida_items: [],
            duties_payable_items: [],
            selectedMidaItemIds: new Set(),
            company: null,
            country: '',
            port: '',
            import_date: ''
        };
        
        // Switch between classification tabs
        function switchClassificationTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.classification-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.classification-tab.${tabName === 'duties_payable' ? 'duties' : tabName.replace('-', '-')}`).classList.add('active');
            
            // Update content visibility
            document.querySelectorAll('.classification-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName === 'duties_payable' ? 'duties' : tabName}-content`).classList.add('active');
        }
        
        // Toggle SST exemption for an item
        function toggleSST(itemId, currentTable) {
            const tableKey = currentTable + '_items';
            const items = classificationData[tableKey];
            const item = items.find(i => i.id === itemId);
            
            if (item) {
                item.sst_exempted = !item.sst_exempted;
                // Check if new value matches the default - if so, reset the manual flag
                if (item.sst_exempted === item.sst_exempted_default) {
                    item.sst_manually_changed = false;
                } else {
                    item.sst_manually_changed = true;
                }
                renderClassificationTable(currentTable);
            }
        }
        
        // Toggle all SST exemptions in a table
        function toggleAllSST(tableName) {
            const tableKey = tableName + '_items';
            const items = classificationData[tableKey];
            
            if (items.length === 0) return;
            
            // Determine new state: if any are OFF, turn all ON; otherwise turn all OFF
            const anyOff = items.some(item => !item.sst_exempted);
            const newState = anyOff;  // Turn all ON if any are OFF
            
            items.forEach(item => {
                item.sst_exempted = newState;
                // Check if new value matches the default - if so, reset the manual flag
                if (item.sst_exempted === item.sst_exempted_default) {
                    item.sst_manually_changed = false;
                } else {
                    item.sst_manually_changed = true;
                }
            });
            
            renderClassificationTable(tableName);
        }

        // Toggle item selection
        function toggleItemSelection(itemId, tableName, isChecked) {
            let set;
            if (tableName === 'mida') set = classificationData.selectedMidaItemIds;
            else if (tableName === 'form_d') set = classificationData.selectedFormDItemIds;
            else set = classificationData.selectedDutiesItemIds;

            if (isChecked) {
                set.add(itemId);
            } else {
                set.delete(itemId);
            }
        }

        // Toggle select all items in a table
        function toggleSelectAllItems(tableName, isChecked) {
            const tableKey = tableName + '_items';
            const items = classificationData[tableKey];
            
            let set;
            if (tableName === 'mida') set = classificationData.selectedMidaItemIds;
            else if (tableName === 'form_d') set = classificationData.selectedFormDItemIds;
            else set = classificationData.selectedDutiesItemIds;

            if (isChecked) {
                items.forEach(item => set.add(item.id));
            } else {
                set.clear();
            }
            
            renderClassificationTable(tableName);
        }
        
        // Move item to a different table
        function moveItemToTable(itemId, sourceTable, targetTable) {
            if (sourceTable === targetTable) return;
            
            const sourceKey = sourceTable + '_items';
            const targetKey = targetTable + '_items';
            
            // Find and remove from source
            const sourceItems = classificationData[sourceKey];
            const itemIndex = sourceItems.findIndex(i => i.id === itemId);
            
            if (itemIndex === -1) return;
            
            const item = sourceItems.splice(itemIndex, 1)[0];
            
            // Remember original table if not set
            item.original_table = item.original_table || sourceTable;
            item.current_table = targetTable;
            
            // Check if item is back at original table - if so, reset manually_moved
            if (targetTable === item.original_table) {
                item.manually_moved = false;
            } else {
                item.manually_moved = true;
            }
            
            // Auto-update SST exemption based on destination table (if not manually changed)
            if (!item.sst_manually_changed) {
                const company = classificationData.company;
                // Get SST default for target table
                // HICOM (all_on) = all tables have SST exempted
                // Others (mida_only) = only MIDA table has SST exempted
                let newSstDefault;
                if (company && company.sst_default_behavior === 'all_on') {
                    newSstDefault = false;  // HICOM: all SST exemption = No
                } else {
                    // Hong Leong / mida_only: MIDA = Yes, Form-D & Duties Payable = No
                    newSstDefault = (targetTable === 'mida');
                }
                item.sst_exempted = newSstDefault;
                item.sst_exempted_default = newSstDefault;
            }
            
            // Add to target
            classificationData[targetKey].push(item);
            
            // Track that we have unsaved changes in classification
            workflowHistory.setUnsavedChanges(true, 'classification results');
            
            // Re-render both tables and update counts
            renderClassificationTable(sourceTable);
            renderClassificationTable(targetTable);
            updateTabCounts();
        }
        
        // Render a classification table
        function renderClassificationTable(tableName) {
            const tableKey = tableName + '_items';
            const items = classificationData[tableKey];
            
            let tbodyId, tableType;
            if (tableName === 'form_d') {
                tbodyId = 'formDTableBody';
                tableType = 'form_d';
            } else if (tableName === 'mida') {
                tbodyId = 'midaTableBody';
                tableType = 'mida';
            } else {
                tbodyId = 'dutiesTableBody';
                tableType = 'duties_payable';
            }
            
            const tbody = document.getElementById(tbodyId);
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            items.forEach((item, index) => {
                const tr = document.createElement('tr');
                
                // Add modified class if manually changed (table move OR SST change)
                if (item.manually_moved || item.sst_manually_changed) {
                    tr.classList.add('modified-row');
                }

                // Determine selection state
                let isSelected = false;
                if (tableName === 'mida') isSelected = classificationData.selectedMidaItemIds?.has(item.id);
                else if (tableName === 'form_d') isSelected = classificationData.selectedFormDItemIds?.has(item.id);
                else isSelected = classificationData.selectedDutiesItemIds?.has(item.id);
                
                if (tableName === 'mida') {
                    // MIDA table: Calculate dynamic balance based on selected port
                    const currentPort = document.getElementById('portSelect')?.value || 'port_klang';
                    let displayRemaining = item.remaining_qty;
                    
                    // Build tooltip
                    let balanceTooltip = `Total: ${item.remaining_qty != null ? parseFloat(item.remaining_qty).toLocaleString() : '-'}`;
                    if (item.remaining_port_klang != null) {
                         balanceTooltip += `\nPort Klang: ${parseFloat(item.remaining_port_klang).toLocaleString()}`;
                         balanceTooltip += `\nKLIA: ${parseFloat(item.remaining_klia).toLocaleString()}`;
                         balanceTooltip += `\nBKH: ${parseFloat(item.remaining_bukit_kayu_hitam).toLocaleString()}`;
                    }

                    // Select specific port balance
                    if (currentPort === 'port_klang' && item.remaining_port_klang != null) {
                        displayRemaining = item.remaining_port_klang;
                    } else if (currentPort === 'klia' && item.remaining_klia != null) {
                        displayRemaining = item.remaining_klia;
                    } else if (currentPort === 'bukit_kayu_hitam' && item.remaining_bukit_kayu_hitam != null) {
                        displayRemaining = item.remaining_bukit_kayu_hitam;
                    } else if (item.port_specific_remaining != null) {
                        displayRemaining = item.port_specific_remaining;
                    }

                    // Format parts name with MIDA line number
                    const partsName = item.description || item.parts_name || '';
                    const midaLineDisplay = item.mida_line_no ? `${partsName} (${item.mida_line_no})` : partsName;
                    
                    tr.innerHTML = `
                        <td style="text-align: center;">
                            <input type="checkbox" onchange="toggleItemSelection('${item.id}', '${tableName}', this.checked)" ${isSelected ? 'checked' : ''}>
                        </td>
                        <td>${item.line_no || index + 1}</td>
                        <td>${escapeHtml(midaLineDisplay)}</td>
                        <td>${escapeHtml(item.mida_hs_code || item.hs_code || '')}</td>
                        <td>${escapeHtml(item.uom || '')}</td>
                        <td>${escapeHtml(item.mida_certificate_number || '-')}</td>
                        <td title="${escapeHtml(balanceTooltip)}" style="cursor: help; border-bottom: 1px dotted #ccc;">
                            ${displayRemaining != null ? parseFloat(displayRemaining).toLocaleString() : '-'}
                        </td>
                        <td>${item.deduction_quantity != null ? parseFloat(item.deduction_quantity).toLocaleString() : '-'}</td>
                        <td>${item.match_score != null ? (item.match_score * 100).toFixed(0) + '%' : '-'}</td>
                        <td>
                            <label class="sst-toggle">
                                <input type="checkbox" ${item.sst_exempted ? 'checked' : ''} 
                                    onchange="toggleSST('${item.id}', '${tableName}')">
                                <span class="sst-slider"></span>
                            </label>
                        </td>
                        <td>
                            <div class="move-dropdown">
                                <select onchange="moveItemToTable('${item.id}', '${tableName}', this.value); this.value='';">
                                    <option value="">Move to...</option>
                                    ${tableName !== 'form_d' ? '<option value="form_d">Form-D</option>' : ''}
                                    ${tableName !== 'mida' ? '<option value="mida">MIDA</option>' : ''}
                                    ${tableName !== 'duties_payable' ? '<option value="duties_payable">Duties Payable</option>' : ''}
                                </select>
                            </div>
                        </td>
                    `;
                } else {
                    // Form-D and Duties Payable tables
                    const displayHsCode = item.hs_code || (item.mida_hs_code ? item.mida_hs_code.replace(/\./g, '') : '');
                    tr.innerHTML = `
                        <td style="text-align: center;">
                            <input type="checkbox" onchange="toggleItemSelection('${item.id}', '${tableName}', this.checked)" ${isSelected ? 'checked' : ''}>
                        </td>
                        <td>${item.line_no || index + 1}</td>
                        <td>${escapeHtml(item.description || item.parts_name || '')}</td>
                        <td>${escapeHtml(displayHsCode)}</td>
                        <td>${item.quantity != null ? parseFloat(item.quantity).toLocaleString() : ''}</td>
                        <td>${escapeHtml(item.uom || '')}</td>
                        <td>${item.net_weight_kg != null ? parseFloat(item.net_weight_kg).toFixed(2) : ''}</td>
                        <td>${item.amount != null ? parseFloat(item.amount).toFixed(2) : ''}</td>
                        <td>
                            <label class="sst-toggle">
                                <input type="checkbox" ${item.sst_exempted ? 'checked' : ''} 
                                    onchange="toggleSST('${item.id}', '${tableName}')">
                                <span class="sst-slider"></span>
                            </label>
                        </td>
                        <td>
                            <div class="move-dropdown">
                                <select onchange="moveItemToTable('${item.id}', '${tableName}', this.value); this.value='';">
                                    <option value="">Move to...</option>
                                    ${tableName !== 'form_d' ? '<option value="form_d">Form-D</option>' : ''}
                                    ${tableName !== 'mida' ? '<option value="mida">MIDA</option>' : ''}
                                    ${tableName !== 'duties_payable' ? '<option value="duties_payable">Duties Payable</option>' : ''}
                                </select>
                            </div>
                        </td>
                    `;
                }
                
                tbody.appendChild(tr);
            });
        }
        
        // Update tab counts
        function updateTabCounts() {
            document.getElementById('formDCount').textContent = classificationData.form_d_items.length;
            document.getElementById('midaCount').textContent = classificationData.mida_items.length;
            document.getElementById('dutiesCount').textContent = classificationData.duties_payable_items.length;
        }
        
        // Display classification results
        function displayClassificationResults(data) {
            // Store in global state with unique IDs
            classificationData = {
                form_d_items: (data.form_d_items || []).map((item, i) => ({
                    ...item,
                    id: `fd_${i}_${Date.now()}`,
                    original_table: 'form_d',
                    current_table: 'form_d'
                })),
                mida_items: (data.mida_items || []).map((item, i) => ({
                    ...item,
                    id: `mida_${i}_${Date.now()}`,
                    original_table: 'mida',
                    current_table: 'mida'
                })),
                duties_payable_items: (data.duties_payable_items || []).map((item, i) => ({
                    ...item,
                    id: `dp_${i}_${Date.now()}`,
                    original_table: 'duties_payable',
                    current_table: 'duties_payable'
                })),
                company: data.company,
                country: document.getElementById('countrySelect').value,
                port: document.getElementById('portSelect')?.value || '',
                import_date: document.getElementById('importDate')?.value || ''
            };
            
            // Initialize selected items (empty by default)
            classificationData.selectedMidaItemIds = new Set();
            classificationData.selectedFormDItemIds = new Set();
            classificationData.selectedDutiesItemIds = new Set();
            
            // Render all tables
            renderClassificationTable('form_d');
            renderClassificationTable('mida');
            renderClassificationTable('duties_payable');
            
            // Update counts
            updateTabCounts();
            
            // Show classification section
            showElement('classificationSection');
            
            // Show database update section if there are MIDA items with certificates
            const midaWithCerts = classificationData.mida_items.filter(i => i.mida_certificate_number && !i.manually_moved);
            if (midaWithCerts.length > 0) {
                showElement('databaseUpdateSection');
            } else {
                hideElement('databaseUpdateSection');
            }
            
            // Update summary stats
            const summaryHtml = `
                <div class="stat-item">
                    <span class="stat-label">Total Items</span>
                    <span class="stat-value">${data.total_items || 0}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Company</span>
                    <span class="stat-value">${escapeHtml(data.company?.name || 'N/A')}</span>
                </div>
                <div class="stat-item form-d">
                    <span class="stat-label">Form-D Items</span>
                    <span class="stat-value">${classificationData.form_d_items.length}</span>
                </div>
                <div class="stat-item mida">
                    <span class="stat-label">MIDA Items</span>
                    <span class="stat-value">${classificationData.mida_items.length}</span>
                </div>
                <div class="stat-item duties">
                    <span class="stat-label">Duties Payable</span>
                    <span class="stat-value">${classificationData.duties_payable_items.length}</span>
                </div>
            `;
            document.getElementById('summaryStats').innerHTML = summaryHtml;
            
            // Switch to Form-D tab by default
            switchClassificationTab('form-d');
            
            // Track in workflow history - classification results are a significant state
            workflowHistory.pushState({
                type: 'classification-result',
                tab: 'converter',
                label: '📊 Classification Results',
                classificationData: {
                    form_d: classificationData.form_d_items,
                    mida: classificationData.mida_items,
                    duties_payable: classificationData.duties_payable_items,
                    nextId: Date.now()
                },
                activeClassificationTab: 'form-d'
            });
        }
        
        // Classify Invoice - Main function for classification
        async function classifyInvoice() {
            const fileInput = document.getElementById('invoiceFile');
            const companySelect = document.getElementById('companySelect');
            const selectedCertIds = getSelectedCertificateIds();
            
            // Reset UI
            hideElement('converterResults');
            hideElement('converterError');
            hideElement('classificationSection');
            hideElement('matchedItemsSection');
            hideElement('allItemsSection');
            hideElement('warningsSection');
            
            // Validation
            if (!fileInput.files[0]) {
                showError('Please select an invoice file first.');
                return;
            }
            
            if (!companySelect.value) {
                showError('Please select a company. This is required for SST exemption rules.');
                return;
            }
            
            // Show loading
            showElement('converterLoading');
            document.getElementById('convertBtn').disabled = true;
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('company_id', companySelect.value);
            formData.append('country', document.getElementById('countrySelect').value);
            
            const portSelect = document.getElementById('portSelect');
            if (portSelect) {
                formData.append('port', portSelect.value);
            }
            
            const importDate = document.getElementById('importDate');
            if (importDate && importDate.value) {
                formData.append('import_date', importDate.value);
            }
            
            // Add certificate IDs if any selected
            if (selectedCertIds.length > 0) {
                formData.append('mida_certificate_ids', selectedCertIds.join(','));
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/convert/classify`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    const errorDetail = data.detail;
                    if (typeof errorDetail === 'object') {
                        showError(errorDetail.detail || 'Classification failed');
                    } else {
                        showError(errorDetail || 'Classification failed');
                    }
                    return;
                }
                
                // Show results section
                showElement('converterResults');
                
                // Display classification results
                displayClassificationResults(data);
                
            } catch (error) {
                console.error('Error:', error);
                showError('Error connecting to server: ' + error.message);
            } finally {
                hideElement('converterLoading');
                document.getElementById('convertBtn').disabled = false;
            }
        }
        
        // Export classified K1 XLS
        async function exportClassifiedK1(exportType) {
            const btnId = exportType === 'form_d' ? 'exportFormDBtn' : 
                          exportType === 'mida' ? 'exportMidaBtn' : 'exportDutiesBtn';
            const btn = document.getElementById(btnId);
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '⏳ Exporting...';
            
            try {
                // Gather items based on export type
                let items;
                if (exportType === 'form_d') {
                    items = classificationData.form_d_items;
                } else if (exportType === 'mida') {
                    items = classificationData.mida_items;
                } else {
                    items = classificationData.duties_payable_items;
                }
                
                if (items.length === 0) {
                    showError(`No items to export for ${exportType.replace('_', ' ').replace('-', ' ')}`);
                    return;
                }
                
                // Transform items to K1ExportItem format
                const exportItems = items.map(item => ({
                    hs_code: item.mida_hs_code || item.hs_code || '',
                    description: item.description || '',
                    description2: item.quantity ? String(item.quantity) : '',
                    quantity: parseFloat(item.quantity) || 0,
                    uom: item.uom || 'UNT',
                    amount: item.amount ? parseFloat(item.amount) : null,
                    net_weight_kg: item.net_weight_kg ? parseFloat(item.net_weight_kg) : null,
                    sst_exempted: item.sst_exempted || false
                }));
                
                const response = await fetch(`${API_BASE}/api/convert/export-classified`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        items: exportItems,
                        export_type: exportType,
                        country: classificationData.country || document.getElementById('countrySelect').value
                    })
                });
                
                if (!response.ok) {
                    const data = await response.json();
                    const errorDetail = data.detail;
                    if (typeof errorDetail === 'object') {
                        showError(errorDetail.detail || 'Export failed');
                    } else {
                        showError(errorDetail || 'Export failed');
                    }
                    return;
                }
                
                // Download the file
                const blob = await response.blob();
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = `${exportType}-k1-import.xls`;
                if (contentDisposition) {
                    const match = contentDisposition.match(/filename="(.+)"/);
                    if (match) filename = match[1];
                }
                
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
            } catch (error) {
                console.error('Export error:', error);
                showError('Error exporting: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }
        
        // Update database with MIDA items (only non-manually-moved with certificates)
        async function updateClassifiedDatabase() {
            const declarationNumber = document.getElementById('declarationNumber').value.trim();
            const importDate = document.getElementById('importDate')?.value || new Date().toISOString().split('T')[0];
            const port = document.getElementById('portSelect')?.value || 'port_klang';
            
            if (!declarationNumber) {
                showError('Please enter the Declaration Form Reg No.');
                return;
            }
            
            // Check for selected items
            if (classificationData.selectedMidaItemIds.size === 0) {
                showError('Please select at least one MIDA item to update balances.');
                return;
            }

            // Filter MIDA items: only SELECTED, non-manually-moved with certificate matches
            const eligibleItems = classificationData.mida_items.filter(item => 
                classificationData.selectedMidaItemIds.has(item.id) &&
                !item.manually_moved && 
                item.mida_certificate_number && 
                item.original_table === 'mida' &&
                item.deduction_quantity != null
            );
            
            if (eligibleItems.length === 0) {
                showError('No eligible selected items to update. Ensure selected items have certificate matches and valid deduction quantities.');
                return;
            }
            
            // Check for items with missing deduction quantity (among selected)
            const itemsWithErrors = classificationData.mida_items.filter(item => 
                classificationData.selectedMidaItemIds.has(item.id) &&
                !item.manually_moved && 
                item.mida_certificate_number && 
                item.original_table === 'mida' &&
                (item.deduction_quantity === null || item.deduction_quantity === undefined)
            );
            if (itemsWithErrors.length > 0) {
                const errorItems = itemsWithErrors.map(item => `Line ${item.line_no}: ${(item.description || '').substring(0, 30)}`).join('\n');
                alert(`❌ Some items have HSCODE errors (UOM could not be determined):\n\n${errorItems}\n\nThese items will be skipped.`);
            }
            
            const updateBtn = document.getElementById('updateDatabaseBtn');
            const originalText = updateBtn.textContent;
            updateBtn.disabled = true;
            updateBtn.textContent = '⏳ Saving...';
            
            try {
                // Build import records from eligible items
                const importRecords = eligibleItems.map(item => ({
                    certificate_item_id: item.mida_item_id,
                    import_date: importDate,
                    declaration_form_reg_no: declarationNumber || null,
                    invoice_number: item.invoice_no || 'UNKNOWN',
                    invoice_line: item.line_no,
                    quantity_imported: parseFloat(item.deduction_quantity),
                    port: port,
                    remarks: `Matched score ${(item.match_score * 100).toFixed(0)}%, UOM: ${item.hscode_uom || 'N/A'}`
                }));
                
                const response = await fetch(`${API_BASE}/api/mida/imports/bulk`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ records: importRecords })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    const errorDetail = data.detail;
                    showError(typeof errorDetail === 'object' ? errorDetail.detail : errorDetail || 'Update failed');
                    return;
                }
                
                // Success
                alert(`✅ Successfully saved ${data.length} import records to the database!\n\nRedirecting to Database View to see updated balances...`);
                updateBtn.textContent = '✅ Updated!';
                
                // Clear unsaved changes since data was saved to database
                workflowHistory.setUnsavedChanges(false);
                
                setTimeout(() => {
                    updateBtn.textContent = originalText;
                    switchTab('database');
                }, 1500);
                
            } catch (error) {
                console.error('Database update error:', error);
                showError('Error updating database: ' + error.message);
            } finally {
                updateBtn.disabled = false;
                if (updateBtn.textContent === '⏳ Saving...') {
                    updateBtn.textContent = originalText;
                }
            }
        }
        
        // ==================== END CLASSIFICATION TAB FUNCTIONS ====================
        
        // Convert Invoice (Legacy - kept for backward compatibility)
        async function convertInvoice() {
            const fileInput = document.getElementById('invoiceFile');
            const selectedCertIds = getSelectedCertificateIds();
            // Match mode and threshold are developer-controlled defaults
            const matchMode = 'fuzzy';
            const matchThreshold = 0.88;
            
            // Reset UI
            hideElement('converterResults');
            hideElement('converterError');
            hideElement('matchedItemsSection');
            hideElement('allItemsSection');
            hideElement('warningsSection');
            
            // Validation
            if (!fileInput.files[0]) {
                showError('Please select an invoice file first.');
                return;
            }
            
            // Determine if MIDA mode (certificates selected)
            const midaMode = selectedCertIds.length > 0;
            
            if (!midaMode) {
                showError('Please select at least one MIDA certificate to match against.');
                return;
            }
            
            // Show loading
            showElement('converterLoading');
            document.getElementById('convertBtn').disabled = true;
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('match_mode', matchMode);
            formData.append('match_threshold', matchThreshold);
            
            // Use multi-certificate endpoint
            formData.append('mida_certificate_ids', selectedCertIds.join(','));
            
            try {
                const response = await fetch(`${API_BASE}/api/convert-multi`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    // Handle error responses
                    const errorDetail = data.detail;
                    if (typeof errorDetail === 'object') {
                        if (errorDetail.detail === 'Invalid MIDA certificate number') {
                            showError(`Certificate not found: "${certNumber}" is not a valid MIDA certificate number. Please check the certificate number and try again.`);
                        } else {
                            showError(errorDetail.detail || 'An error occurred');
                        }
                    } else {
                        showError(errorDetail || 'An error occurred');
                    }
                    return;
                }
                
                // Display results
                displayResults(data, midaMode);
                
            } catch (error) {
                console.error('Error:', error);
                showError('Error connecting to server: ' + error.message);
            } finally {
                hideElement('converterLoading');
                document.getElementById('convertBtn').disabled = false;
            }
        }
        
        // Export K1 XLS
        async function exportK1Xls() {
            const exportBtn = document.getElementById('exportK1Btn');
            const originalText = exportBtn.textContent;
            exportBtn.disabled = true;
            exportBtn.textContent = '⏳ Exporting...';
            
            const country = document.getElementById('countrySelect').value;
            const midaMode = document.getElementById('midaMatchingMode').checked;
            
            try {
                let response;
                
                if (midaMode && matchedItemsForExport && matchedItemsForExport.length > 0) {
                    // MIDA mode: Use the new endpoint with MIDA HS codes from certificate
                    response = await fetch(`${API_BASE}/api/convert/export-mida`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            items: matchedItemsForExport,
                            country: country
                        })
                    });
                } else {
                    // Normal mode: Use the original endpoint (parses invoice file)
                    const fileInput = document.getElementById('invoiceFile');
                    
                    if (!fileInput.files[0]) {
                        showError('Please select an invoice file first.');
                        return;
                    }
                    
                    const formData = new FormData();
                    formData.append('file', fileInput.files[0]);
                    formData.append('country', country);
                    
                    response = await fetch(`${API_BASE}/api/convert/export`, {
                        method: 'POST',
                        body: formData
                    });
                }
                
                if (!response.ok) {
                    const data = await response.json();
                    const errorDetail = data.detail;
                    if (typeof errorDetail === 'object') {
                        showError(errorDetail.detail || 'Export failed');
                    } else {
                        showError(errorDetail || 'Export failed');
                    }
                    return;
                }
                
                // Download the file
                const blob = await response.blob();
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'mida-k1-import.xls';
                if (contentDisposition) {
                    const match = contentDisposition.match(/filename="(.+)"/);
                    if (match) filename = match[1];
                }
                
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
            } catch (error) {
                console.error('Export error:', error);
                showError('Error exporting K1 XLS: ' + error.message);
            } finally {
                exportBtn.disabled = false;
                exportBtn.textContent = originalText;
            }
        }
        
        // Display results
        function displayResults(data, midaMode) {
            showElement('converterResults');
            
            // Summary stats
            const statsHtml = `
                <div class="stat-card">
                    <div class="number">${data.total_invoice_items}</div>
                    <div class="label">Total Items</div>
                </div>
                <div class="stat-card matched">
                    <div class="number">${data.matched_item_count}</div>
                    <div class="label">Matched</div>
                </div>
                <div class="stat-card unmatched">
                    <div class="number">${data.unmatched_item_count}</div>
                    <div class="label">Unmatched</div>
                </div>
            `;
            document.getElementById('summaryStats').innerHTML = statsHtml;
            
            // Raw JSON
            document.getElementById('rawResult').textContent = JSON.stringify(data, null, 2);
            
            // Show database update section when we have MIDA matched items
            const databaseUpdateSection = document.getElementById('databaseUpdateSection');
            
            if (midaMode && data.mida_matched_items && data.mida_matched_items.length > 0) {
                // Show database update section
                if (databaseUpdateSection) {
                    databaseUpdateSection.classList.remove('hidden');
                    databaseUpdateSection.style.display = 'block';
                }
                
                // Store matched items for database update (with certificate info for multi-cert)
                matchedItemsForDatabase = data.mida_matched_items.map(item => ({
                    mida_item_id: item.mida_item_id,
                    mida_certificate_id: item.mida_certificate_id,
                    mida_certificate_number: item.mida_certificate_number,
                    invoice_number: item.invoice_no || 'UNKNOWN',
                    invoice_line: item.line_no,
                    quantity: parseFloat(item.quantity) || 0,
                    net_weight_kg: item.net_weight_kg ? parseFloat(item.net_weight_kg) : null,
                    hscode_uom: item.hscode_uom,
                    deduction_quantity: item.deduction_quantity ? parseFloat(item.deduction_quantity) : null,
                    match_score: item.match_score,
                    description: item.description
                }));
                
                // Store matched items for export (with MIDA HS codes)
                matchedItemsForExport = data.mida_matched_items.map(item => ({
                    hs_code: item.mida_hs_code,  // Use MIDA certificate HS code, not invoice HS code
                    description: item.description,
                    quantity: parseFloat(item.quantity) || 0,
                    uom: item.uom || 'UNT',
                    amount: item.amount ? parseFloat(item.amount) : null,
                    net_weight_kg: item.net_weight_kg ? parseFloat(item.net_weight_kg) : null
                }));
                
                // Display matched items table (with certificate column for multi-cert)
                displayMatchedItems(data.mida_matched_items);
            } else if (!midaMode && data.all_invoice_items && data.all_invoice_items.length > 0) {
                // Hide database update section
                if (databaseUpdateSection) {
                    databaseUpdateSection.classList.add('hidden');
                    databaseUpdateSection.style.display = 'none';
                }
                
                // Clear matched items when not in MIDA mode
                matchedItemsForDatabase = [];
                matchedItemsForExport = [];
                
                // Display all items table (normal mode) - start with filtered view
                cachedResponseData = data;
                currentViewMode = 'filtered';
                updateToggleUI();
                displayAllItems(data.all_invoice_items, false);
            } else {
                // No matches - hide database update section
                if (databaseUpdateSection) {
                    databaseUpdateSection.classList.add('hidden');
                    databaseUpdateSection.style.display = 'none';
                }
                matchedItemsForDatabase = [];
                matchedItemsForExport = [];
            }
            
            // Display warnings
            if (data.warnings && data.warnings.length > 0) {
                displayWarnings(data.warnings);
            }
        }
        
        // Cache response data for toggle functionality
        let cachedResponseData = null;
        let currentViewMode = 'filtered'; // 'filtered' or 'full'
        
        // Switch to filtered view (non-FORM-D only)
        function switchToFilteredView() {
            if (!cachedResponseData) return;
            currentViewMode = 'filtered';
            updateToggleUI();
            displayAllItems(cachedResponseData.all_invoice_items, false);
            document.getElementById('itemsTableTitle').textContent = '📋 Invoice Items with Empty Form Flag (Non-FORM-D)';
            
            // Hide warnings in filtered view (totals won't match since FORM-D items are excluded)
            hideElement('warningsSection');
        }
        
        // Switch to full view (all items including FORM-D and Total)
        function switchToFullView() {
            if (!cachedResponseData) return;
            currentViewMode = 'full';
            updateToggleUI();
            
            if (cachedResponseData.full_invoice_items && cachedResponseData.full_invoice_items.length > 0) {
                displayAllItems(cachedResponseData.full_invoice_items, true);
            } else {
                console.warn('full_invoice_items is empty or undefined');
                // Fallback: show message
                const tbody = document.querySelector('#allItemsTable tbody');
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #7f8c8d;">No items available in full view</td></tr>';
            }
            document.getElementById('itemsTableTitle').textContent = '📄 All Invoice Items (Including FORM-D & Total)';
            
            // Show warnings in full view (Total Row Validation)
            if (cachedResponseData.warnings && cachedResponseData.warnings.length > 0) {
                displayWarnings(cachedResponseData.warnings);
            } else {
                hideElement('warningsSection');
            }
        }
        
        // Update toggle button UI
        function updateToggleUI() {
            document.getElementById('viewFilteredBtn').classList.toggle('active', currentViewMode === 'filtered');
            document.getElementById('viewFullBtn').classList.toggle('active', currentViewMode === 'full');
        }
        
        // Display matched items table
        function displayMatchedItems(items) {
            showElement('matchedItemsSection');
            const tbody = document.querySelector('#matchedItemsTable tbody');
            tbody.innerHTML = '';
            
            items.forEach(item => {
                const scoreClass = item.match_score >= 0.95 ? 'high' : 
                                   item.match_score >= 0.8 ? 'medium' : 'low';
                
                // Determine deduction display
                const deductionDisplay = item.deduction_quantity !== null && item.deduction_quantity !== undefined
                    ? `${parseFloat(item.deduction_quantity).toFixed(2)} ${item.hscode_uom || ''}`
                    : '<span style="color: #e74c3c;">⚠️ Error</span>';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.line_no}</td>
                    <td>${escapeHtml(item.description)}</td>
                    <td>${escapeHtml(item.model_no || '-')}</td>
                    <td>${item.quantity}</td>
                    <td>${item.net_weight_kg ? parseFloat(item.net_weight_kg).toFixed(2) : '-'}</td>
                    <td><small>${escapeHtml(item.mida_certificate_number || '-')}</small></td>
                    <td>${item.mida_line_no}</td>
                    <td>${escapeHtml(item.mida_item_name)}</td>
                    <td><code>${escapeHtml(item.mida_hs_code)}</code></td>
                    <td>${item.remaining_qty} ${item.remaining_uom}</td>
                    <td>${deductionDisplay}</td>
                    <td><span class="match-score ${scoreClass}">${(item.match_score * 100).toFixed(0)}%</span></td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Display all items table (normal mode)
        function displayAllItems(items, showFormFlag = false) {
            showElement('allItemsSection');
            
            // Update table header based on view mode
            const thead = document.getElementById('allItemsTableHead');
            if (showFormFlag) {
                thead.innerHTML = `
                    <tr>
                        <th>Line</th>
                        <th>Parts No</th>
                        <th>Parts Name</th>
                        <th>HS Code</th>
                        <th>Form Flag</th>
                        <th>Qty</th>
                        <th>Amount (USD)</th>
                        <th>Net Wt (Kg)</th>
                    </tr>
                `;
            } else {
                thead.innerHTML = `
                    <tr>
                        <th>Line</th>
                        <th>Parts No</th>
                        <th>Parts Name</th>
                        <th>HS Code</th>
                        <th>Qty</th>
                        <th>Amount (USD)</th>
                        <th>Net Wt (Kg)</th>
                    </tr>
                `;
            }
            
            const tbody = document.querySelector('#allItemsTable tbody');
            tbody.innerHTML = '';
            
            items.forEach(item => {
                const row = document.createElement('tr');
                const isTotal = item.is_total_row === true;
                const isFormD = item.form_flag === 'FORM-D';
                
                if (isTotal) {
                    row.className = 'total-row';
                }
                
                if (showFormFlag) {
                    // Full view with Form Flag column
                    const formFlagBadge = isTotal ? '' : 
                        isFormD ? '<span class="form-flag-badge form-d">FORM-D</span>' :
                        '<span class="form-flag-badge empty">Non-FORM-D</span>';
                    
                    row.innerHTML = `
                        <td>${isTotal ? '' : item.line_no}</td>
                        <td>${escapeHtml(item.parts_no || '')}</td>
                        <td>${isTotal ? '<strong>Total</strong>' : escapeHtml(item.description)}</td>
                        <td>${escapeHtml(item.hs_code || '')}</td>
                        <td>${formFlagBadge}</td>
                        <td>${item.quantity}</td>
                        <td>${item.amount ? '$' + item.amount.toFixed(2) : '-'}</td>
                        <td>${item.net_weight_kg ? item.net_weight_kg.toFixed(2) : '-'}</td>
                    `;
                } else {
                    // Filtered view without Form Flag column
                    row.innerHTML = `
                        <td>${item.line_no}</td>
                        <td>${escapeHtml(item.parts_no || '')}</td>
                        <td>${escapeHtml(item.description)}</td>
                        <td>${escapeHtml(item.hs_code || '')}</td>
                        <td>${item.quantity}</td>
                        <td>${item.amount ? '$' + item.amount.toFixed(2) : '-'}</td>
                        <td>${item.net_weight_kg ? item.net_weight_kg.toFixed(2) : '-'}</td>
                    `;
                }
                tbody.appendChild(row);
            });
        }
        
        // Display warnings
        function displayWarnings(warnings) {
            showElement('warningsSection');
            const container = document.getElementById('warningsList');
            container.innerHTML = '';
            
            warnings.forEach(warning => {
                const div = document.createElement('div');
                div.className = `warning-item ${warning.severity}`;
                div.innerHTML = `
                    <span class="invoice-item">${escapeHtml(warning.invoice_item)}</span>
                    <span class="severity-badge ${warning.severity}">${warning.severity}</span>
                    <div class="reason">${escapeHtml(warning.reason)}</div>
                `;
                container.appendChild(div);
            });
        }
        
        // Show error message
        function showError(message) {
            document.getElementById('errorText').textContent = message;
            showElement('converterError');
        }
        
        // Helper functions
        function showElement(id) {
            document.getElementById(id).classList.remove('hidden');
        }
        
        function hideElement(id) {
            document.getElementById(id).classList.add('hidden');
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Certificate Parser (existing functionality)
        async function uploadFile() {
            const fileInput = document.getElementById('pdfInput');
            const resultDisplay = document.getElementById('result');
            
            if (!fileInput.files[0]) {
                alert('Please select a PDF file first.');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            resultDisplay.textContent = 'Uploading and processing...';

            try {
                const response = await fetch(`${API_BASE}/api/mida/certificate/parse`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                resultDisplay.textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                console.error('Error:', error);
                resultDisplay.textContent = 'Error processing request: ' + error.message;
            }
        }
        
        // ==========================================
        // Certificate Parser - Interactive Table
        // ==========================================
        
        let parsedCertificateData = null;
        let originalCertificateData = null;
        let isEditMode = false;
        
        // Parse Certificate
        async function parseCertificate() {
            const fileInput = document.getElementById('pdfInput');
            
            // Reset UI
            hideElement('parserResults');
            hideElement('parserError');
            hideElement('saveSuccess');
            hideElement('parserWarnings');
            
            if (!fileInput.files[0]) {
                showParserError('Please select a PDF file first.');
                return;
            }
            
            // Show loading
            showElement('parserLoading');
            document.getElementById('parseBtn').disabled = true;
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            try {
                const response = await fetch(`${API_BASE}/api/mida/certificate/parse`, {
                    method: 'POST',
                    body: formData
                });
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    showParserError(`Server error: ${text || response.statusText}`);
                    return;
                }
                
                const data = await response.json();
                
                if (!response.ok) {
                    const errorMsg = data.detail || 'Failed to parse certificate';
                    showParserError(typeof errorMsg === 'object' ? JSON.stringify(errorMsg) : errorMsg);
                    return;
                }
                
                // Store data
                parsedCertificateData = JSON.parse(JSON.stringify(data));
                originalCertificateData = JSON.parse(JSON.stringify(data));
                
                // Display results
                displayParsedCertificate(data);
                
            } catch (error) {
                console.error('Error:', error);
                showParserError('Error connecting to server: ' + error.message);
            } finally {
                hideElement('parserLoading');
                document.getElementById('parseBtn').disabled = false;
            }
        }
        
        // Date format conversion utilities
        function isoToDisplay(isoDate) {
            // Convert YYYY-MM-DD to DD/MM/YYYY
            if (!isoDate || isoDate === '-') return '-';
            const parts = isoDate.split('-');
            if (parts.length !== 3) return isoDate;
            return `${parts[2]}/${parts[1]}/${parts[0]}`;
        }
        
        function displayToIso(displayDate) {
            // Convert DD/MM/YYYY to YYYY-MM-DD
            if (!displayDate || displayDate === '-') return null;
            const parts = displayDate.split('/');
            if (parts.length !== 3) return displayDate;
            return `${parts[2]}-${parts[1]}-${parts[0]}`;
        }
        
        function isoToInputValue(isoDate) {
            // Convert YYYY-MM-DD to input date value (YYYY-MM-DD for HTML date input)
            if (!isoDate || isoDate === '-') return '';
            return isoDate;
        }
        
        // Display parsed certificate data
        function displayParsedCertificate(data) {
            showElement('parserResults');
            
            // Populate header fields (note: backend uses mida_no, exemption_start, exemption_end)
            document.getElementById('certNumber').textContent = data.mida_no || '-';
            document.getElementById('certCompany').textContent = data.company_name || '-';
            document.getElementById('certModelNumber').textContent = '-'; // Model number is user-entered, not from OCR
            
            // Store ISO dates as data attributes and display in DD/MM/YYYY format
            const startDateEl = document.getElementById('certStartDate');
            const endDateEl = document.getElementById('certEndDate');
            
            startDateEl.dataset.isoDate = data.exemption_start || '';
            startDateEl.textContent = isoToDisplay(data.exemption_start) || '-';
            
            endDateEl.dataset.isoDate = data.exemption_end || '';
            endDateEl.textContent = isoToDisplay(data.exemption_end) || '-';
            
            // Populate items table
            const tbody = document.getElementById('certItemsBody');
            tbody.innerHTML = '';
            
            if (data.items && data.items.length > 0) {
                data.items.forEach((item, index) => {
                    const row = document.createElement('tr');
                    row.dataset.index = index;
                    
                    // Extract station quantities from nested station_split object
                    const stationSplit = item.station_split || {};
                    const portKlangQty = stationSplit.PORT_KLANG ?? '';
                    const kliaQty = stationSplit.KLIA ?? '';
                    const bukitKayuHitamQty = stationSplit.BUKIT_KAYU_HITAM ?? '';
                    
                    row.innerHTML = `
                        <td class="editable-cell" data-field="line_no">${item.line_no || ''}</td>
                        <td class="editable-cell" data-field="hs_code">${escapeHtml(item.hs_code || '')}</td>
                        <td class="editable-cell" data-field="item_name">${escapeHtml(item.item_name || '')}</td>
                        <td class="editable-cell" data-field="approved_quantity">${item.approved_quantity ?? ''}</td>
                        <td class="editable-cell" data-field="uom">${escapeHtml(item.uom || '')}</td>
                        <td class="editable-cell" data-field="port_klang_qty">${portKlangQty}</td>
                        <td class="editable-cell" data-field="klia_qty">${kliaQty}</td>
                        <td class="editable-cell" data-field="bukit_kayu_hitam_qty">${bukitKayuHitamQty}</td>
                        <td class="actions-column">
                            <div class="row-actions">
                                <button class="row-action-btn btn-insert-row" onclick="insertRowAfter(${index})" title="Insert row below">+</button>
                                <button class="row-action-btn btn-delete-row" onclick="deleteRow(${index})" title="Delete row">🗑️</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #7f8c8d;">No items found in certificate</td></tr>';
            }
            
            // Show warnings if any
            if (data.warnings && data.warnings.length > 0) {
                document.getElementById('warningsBadge').textContent = `${data.warnings.length} warning(s)`;
                showElement('warningsBadge');
                displayParserWarnings(data.warnings);
            } else {
                hideElement('warningsBadge');
            }
            
            // Show raw JSON
            document.getElementById('parserRawResult').textContent = JSON.stringify(data, null, 2);
            
            // Reset edit mode
            isEditMode = false;
            updateEditButtons();
            
            // Validate missing required fields after parse
            validateMissingRequiredFields();
            
            // Validate quantity discrepancies after parse
            validateQuantityDiscrepancies();
            
            // Track in workflow history - parsed certificate is a significant state
            workflowHistory.pushState({
                type: 'parser-result',
                tab: 'parser',
                label: `📋 ${data.mida_no || 'Parsed Certificate'}`,
                parsedData: data
            });
        }
        
        // Validate missing required fields (blocks save to database)
        function validateMissingRequiredFields() {
            const missingItems = [];
            
            // Check header fields
            const certNumber = document.getElementById('certNumber').textContent.trim();
            const company = document.getElementById('certCompany').textContent.trim();
            const modelNumber = document.getElementById('certModelNumber').textContent.trim();
            const startDateEl = document.getElementById('certStartDate');
            const endDateEl = document.getElementById('certEndDate');
            
            // Get date values (check both text content and data attribute)
            let startDate = startDateEl.dataset.isoDate || '';
            let endDate = endDateEl.dataset.isoDate || '';
            
            // If in view mode, also check text content
            if (!startDate && startDateEl.textContent.trim() !== '-') {
                startDate = startDateEl.textContent.trim();
            }
            if (!endDate && endDateEl.textContent.trim() !== '-') {
                endDate = endDateEl.textContent.trim();
            }
            
            // Clear previous header highlighting
            document.getElementById('certNumber').classList.remove('missing-field');
            document.getElementById('certCompany').classList.remove('missing-field');
            document.getElementById('certModelNumber').classList.remove('missing-field');
            startDateEl.classList.remove('missing-field');
            endDateEl.classList.remove('missing-field');
            
            // Check each required header field
            if (!certNumber || certNumber === '-') {
                missingItems.push('Certificate Number is missing');
                document.getElementById('certNumber').classList.add('missing-field');
            }
            if (!company || company === '-') {
                missingItems.push('Company Name is missing');
                document.getElementById('certCompany').classList.add('missing-field');
            }
            if (!modelNumber || modelNumber === '-') {
                missingItems.push('Model Number is missing');
                document.getElementById('certModelNumber').classList.add('missing-field');
            }
            if (!startDate) {
                missingItems.push('Exemption Start Date is missing');
                startDateEl.classList.add('missing-field');
            }
            if (!endDate) {
                missingItems.push('Exemption End Date is missing');
                endDateEl.classList.add('missing-field');
            }
            
            // Check table rows for required fields
            const rows = document.querySelectorAll('#certItemsBody tr[data-index]');
            
            rows.forEach((row) => {
                const lineNo = row.querySelector('[data-field="line_no"]')?.textContent.trim() || '';
                const hsCode = row.querySelector('[data-field="hs_code"]')?.textContent.trim() || '';
                const itemName = row.querySelector('[data-field="item_name"]')?.textContent.trim() || '';
                const approvedQty = row.querySelector('[data-field="approved_quantity"]')?.textContent.trim() || '';
                const uom = row.querySelector('[data-field="uom"]')?.textContent.trim() || '';
                const portKlang = row.querySelector('[data-field="port_klang_qty"]')?.textContent.trim() || '';
                const klia = row.querySelector('[data-field="klia_qty"]')?.textContent.trim() || '';
                const bukitKayuHitam = row.querySelector('[data-field="bukit_kayu_hitam_qty"]')?.textContent.trim() || '';
                
                // Clear previous cell highlighting
                row.classList.remove('missing-data-row');
                row.querySelectorAll('.missing-field').forEach(cell => cell.classList.remove('missing-field'));
                
                // Skip completely empty rows - they will be auto-deleted on save
                const allFieldsEmpty = !lineNo && !hsCode && !itemName && !approvedQty && 
                                       !uom && !portKlang && !klia && !bukitKayuHitam;
                if (allFieldsEmpty) {
                    return; // Skip validation for completely empty rows
                }
                
                const rowMissing = [];
                
                if (!hsCode) {
                    rowMissing.push('HS Code');
                    row.querySelector('[data-field="hs_code"]')?.classList.add('missing-field');
                }
                if (!itemName) {
                    rowMissing.push('Item Name');
                    row.querySelector('[data-field="item_name"]')?.classList.add('missing-field');
                }
                if (!approvedQty) {
                    rowMissing.push('Approved Quantity');
                    row.querySelector('[data-field="approved_quantity"]')?.classList.add('missing-field');
                }
                if (!uom) {
                    rowMissing.push('UOM');
                    row.querySelector('[data-field="uom"]')?.classList.add('missing-field');
                }
                
                if (rowMissing.length > 0) {
                    row.classList.add('missing-data-row');
                    missingItems.push(`Line ${lineNo || '?'}: Missing ${rowMissing.join(', ')}`);
                }
            });
            
            // Update missing data warning banner
            const warningBanner = document.getElementById('missingDataWarning');
            const missingList = document.getElementById('missingDataList');
            
            if (missingItems.length > 0) {
                missingList.innerHTML = '';
                missingItems.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    missingList.appendChild(li);
                });
                showElement('missingDataWarning');
            } else {
                hideElement('missingDataWarning');
            }
            
            return missingItems.length;
        }
        
        // Validate quantity discrepancies (Approved Qty vs sum of station quantities)
        function validateQuantityDiscrepancies() {
            const rows = document.querySelectorAll('#certItemsBody tr[data-index]');
            const discrepancies = [];
            
            rows.forEach((row) => {
                const lineNo = row.querySelector('[data-field="line_no"]')?.textContent.trim() || '';
                const approvedQtyText = row.querySelector('[data-field="approved_quantity"]')?.textContent.trim() || '';
                const portKlangText = row.querySelector('[data-field="port_klang_qty"]')?.textContent.trim() || '';
                const kliaText = row.querySelector('[data-field="klia_qty"]')?.textContent.trim() || '';
                const bukitKayuHitamText = row.querySelector('[data-field="bukit_kayu_hitam_qty"]')?.textContent.trim() || '';
                
                const approvedQty = parseFloat(approvedQtyText) || 0;
                const portKlang = parseFloat(portKlangText) || 0;
                const klia = parseFloat(kliaText) || 0;
                const bukitKayuHitam = parseFloat(bukitKayuHitamText) || 0;
                
                const stationSum = portKlang + klia + bukitKayuHitam;
                
                // Check if there's a discrepancy (allow small floating point tolerance)
                const tolerance = 0.001;
                const hasDiscrepancy = Math.abs(approvedQty - stationSum) > tolerance;
                
                // Also check if all station values are empty/zero but approved qty is not
                const allStationsEmpty = portKlangText === '' && kliaText === '' && bukitKayuHitamText === '';
                
                if (hasDiscrepancy && !allStationsEmpty) {
                    row.classList.add('discrepancy-row');
                    discrepancies.push({
                        lineNo: lineNo,
                        approvedQty: approvedQty,
                        stationSum: stationSum,
                        difference: approvedQty - stationSum
                    });
                } else {
                    row.classList.remove('discrepancy-row');
                }
            });
            
            // Update discrepancy warning banner
            const warningBanner = document.getElementById('discrepancyWarning');
            const discrepancyList = document.getElementById('discrepancyList');
            
            if (discrepancies.length > 0) {
                discrepancyList.innerHTML = '';
                discrepancies.forEach(d => {
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>Line ${d.lineNo}:</strong> Approved Qty (${d.approvedQty}) ≠ Station Sum (${d.stationSum.toFixed(2)}) — Difference: ${d.difference.toFixed(2)}`;
                    discrepancyList.appendChild(li);
                });
                showElement('discrepancyWarning');
            } else {
                hideElement('discrepancyWarning');
            }
            
            return discrepancies.length;
        }
        
        // Display parser warnings
        function displayParserWarnings(warnings) {
            showElement('parserWarnings');
            const container = document.getElementById('parserWarningsList');
            container.innerHTML = '';
            
            warnings.forEach(warning => {
                const div = document.createElement('div');
                div.className = 'warning-item warning';
                div.innerHTML = `<span class="reason">${escapeHtml(warning)}</span>`;
                container.appendChild(div);
            });
        }
        
        // Toggle edit mode
        function toggleEditMode() {
            isEditMode = !isEditMode;
            
            // Store current data before editing
            if (isEditMode) {
                originalCertificateData = JSON.parse(JSON.stringify(parsedCertificateData));
                // Track unsaved changes when entering edit mode
                workflowHistory.setUnsavedChanges(true, 'certificate editor');
            } else {
                // Clear unsaved changes when exiting edit mode
                workflowHistory.setUnsavedChanges(false);
            }
            
            // Handle non-date header fields (certificate number, company name, model number)
            const certNumberEl = document.getElementById('certNumber');
            const certCompanyEl = document.getElementById('certCompany');
            const certModelNumberEl = document.getElementById('certModelNumber');
            
            if (isEditMode) {
                certNumberEl.contentEditable = 'true';
                certNumberEl.classList.add('editable');
                certCompanyEl.contentEditable = 'true';
                certCompanyEl.classList.add('editable');
                certModelNumberEl.contentEditable = 'true';
                certModelNumberEl.classList.add('editable');
            } else {
                certNumberEl.contentEditable = 'false';
                certNumberEl.classList.remove('editable');
                certCompanyEl.contentEditable = 'false';
                certCompanyEl.classList.remove('editable');
                certModelNumberEl.contentEditable = 'false';
                certModelNumberEl.classList.remove('editable');
            }
            
            // Handle date fields with date input
            const startDateEl = document.getElementById('certStartDate');
            const endDateEl = document.getElementById('certEndDate');
            
            if (isEditMode) {
                // Replace text with date input for start date
                const startIso = startDateEl.dataset.isoDate || '';
                startDateEl.innerHTML = `<input type="date" id="startDateInput" value="${startIso}" style="width: 100%; padding: 0.4rem; border: 1px solid #3498db; border-radius: 4px;">`;
                startDateEl.classList.add('editable');
                
                // Replace text with date input for end date
                const endIso = endDateEl.dataset.isoDate || '';
                endDateEl.innerHTML = `<input type="date" id="endDateInput" value="${endIso}" style="width: 100%; padding: 0.4rem; border: 1px solid #3498db; border-radius: 4px;">`;
                endDateEl.classList.add('editable');
            } else {
                // Restore text display
                startDateEl.textContent = isoToDisplay(startDateEl.dataset.isoDate) || '-';
                startDateEl.classList.remove('editable');
                
                endDateEl.textContent = isoToDisplay(endDateEl.dataset.isoDate) || '-';
                endDateEl.classList.remove('editable');
            }
            
            // Make table cells editable
            const cells = document.querySelectorAll('#certItemsBody .editable-cell');
            cells.forEach(cell => {
                if (isEditMode) {
                    cell.contentEditable = 'true';
                    cell.classList.add('editing');
                } else {
                    cell.contentEditable = 'false';
                    cell.classList.remove('editing');
                }
            });
            
            // Show/hide actions column and row action buttons
            const actionsColumnHeader = document.getElementById('actionsColumnHeader');
            const actionsColumns = document.querySelectorAll('#certItemsBody .actions-column');
            const rowActions = document.querySelectorAll('#certItemsBody .row-actions');
            
            if (isEditMode) {
                // Show actions column
                if (actionsColumnHeader) actionsColumnHeader.classList.add('visible');
                actionsColumns.forEach(col => col.classList.add('visible'));
                rowActions.forEach(actions => actions.classList.add('visible'));
                
                // Update delete button states
                updateDeleteButtonStates();
            } else {
                // Hide actions column
                if (actionsColumnHeader) actionsColumnHeader.classList.remove('visible');
                actionsColumns.forEach(col => col.classList.remove('visible'));
                rowActions.forEach(actions => actions.classList.remove('visible'));
                
                // Dismiss any undo toast when exiting edit mode
                dismissUndoToast();
            }
            
            updateEditButtons();
            hideElement('saveSuccess');
        }
        
        // Update edit button visibility
        function updateEditButtons() {
            if (isEditMode) {
                hideElement('editBtn');
                hideElement('saveDatabaseBtn');
                showElement('saveBtn');
                showElement('cancelBtn');
            } else {
                showElement('editBtn');
                showElement('saveDatabaseBtn');
                hideElement('saveBtn');
                hideElement('cancelBtn');
            }
        }
        
        // Save changes
        function saveChanges() {
            // Collect data from header fields (use backend field names: mida_no, exemption_start, exemption_end)
            parsedCertificateData.mida_no = document.getElementById('certNumber').textContent.trim();
            parsedCertificateData.company_name = document.getElementById('certCompany').textContent.trim();
            parsedCertificateData.model_number = document.getElementById('certModelNumber').textContent.trim();
            
            // Get dates from date inputs (they return ISO format YYYY-MM-DD)
            const startDateInput = document.getElementById('startDateInput');
            const endDateInput = document.getElementById('endDateInput');
            
            const startDateValue = startDateInput ? startDateInput.value : '';
            const endDateValue = endDateInput ? endDateInput.value : '';
            
            // Update data attributes for display later
            document.getElementById('certStartDate').dataset.isoDate = startDateValue;
            document.getElementById('certEndDate').dataset.isoDate = endDateValue;
            
            parsedCertificateData.exemption_start = startDateValue || null;
            parsedCertificateData.exemption_end = endDateValue || null;
            
            // Collect data from items table
            const rows = document.querySelectorAll('#certItemsBody tr');
            parsedCertificateData.items = [];
            
            rows.forEach((row, index) => {
                if (row.dataset.index !== undefined) {
                    const portKlangVal = row.querySelector('[data-field="port_klang_qty"]').textContent.trim();
                    const kliaVal = row.querySelector('[data-field="klia_qty"]').textContent.trim();
                    const bukitKayuHitamVal = row.querySelector('[data-field="bukit_kayu_hitam_qty"]').textContent.trim();
                    
                    const item = {
                        line_no: parseInt(row.querySelector('[data-field="line_no"]').textContent.trim()) || index + 1,
                        hs_code: row.querySelector('[data-field="hs_code"]').textContent.trim(),
                        item_name: row.querySelector('[data-field="item_name"]').textContent.trim(),
                        approved_quantity: parseFloat(row.querySelector('[data-field="approved_quantity"]').textContent.trim()) || null,
                        uom: row.querySelector('[data-field="uom"]').textContent.trim(),
                        station_split: {
                            PORT_KLANG: portKlangVal ? parseFloat(portKlangVal) : null,
                            KLIA: kliaVal ? parseFloat(kliaVal) : null,
                            BUKIT_KAYU_HITAM: bukitKayuHitamVal ? parseFloat(bukitKayuHitamVal) : null
                        }
                    };
                    parsedCertificateData.items.push(item);
                }
            });
            
            // Exit edit mode (toggle will flip isEditMode from true to false)
            toggleEditMode();
            
            // Update raw JSON display
            document.getElementById('parserRawResult').textContent = JSON.stringify(parsedCertificateData, null, 2);
            
            // Validate missing required fields after save
            validateMissingRequiredFields();
            
            // Validate quantity discrepancies after save
            validateQuantityDiscrepancies();
            
            // Show success message
            showElement('saveSuccess');
            
            // Hide success after 3 seconds
            setTimeout(() => {
                hideElement('saveSuccess');
            }, 3000);
        }
        
        // Cancel edit - restore original data and exit edit mode
        function cancelEdit() {
            // Restore original data from the snapshot taken when edit mode started
            parsedCertificateData = JSON.parse(JSON.stringify(originalCertificateData));
            
            // Exit edit mode
            isEditMode = false;
            
            // Clear unsaved changes
            workflowHistory.setUnsavedChanges(false);
            
            // Re-render the display with the original data
            displayParsedCertificate(parsedCertificateData);
        }
        
        // ==========================================
        // Row Manipulation Functions
        // ==========================================
        
        // Track deleted row for undo
        let lastDeletedRow = null;
        let undoToastTimeout = null;
        
        // Insert a new empty row after the specified index
        function insertRowAfter(afterIndex) {
            const tbody = document.getElementById('certItemsBody');
            const rows = tbody.querySelectorAll('tr[data-index]');
            
            // Find the row to insert after
            let insertAfterRow = null;
            rows.forEach(row => {
                if (parseInt(row.dataset.index) === afterIndex) {
                    insertAfterRow = row;
                }
            });
            
            if (!insertAfterRow) {
                console.error('Could not find row with index:', afterIndex);
                return;
            }
            
            // Create a new empty row
            const newRow = document.createElement('tr');
            newRow.dataset.index = 'new'; // Temporary index
            
            // Calculate a new line number (after the current row's line number)
            const currentLineNo = parseInt(insertAfterRow.querySelector('[data-field="line_no"]')?.textContent.trim()) || 0;
            const newLineNo = currentLineNo + 1;
            
            newRow.innerHTML = `
                <td class="editable-cell editing" data-field="line_no" contenteditable="true">${newLineNo}</td>
                <td class="editable-cell editing" data-field="hs_code" contenteditable="true"></td>
                <td class="editable-cell editing" data-field="item_name" contenteditable="true"></td>
                <td class="editable-cell editing" data-field="approved_quantity" contenteditable="true"></td>
                <td class="editable-cell editing" data-field="uom" contenteditable="true"></td>
                <td class="editable-cell editing" data-field="port_klang_qty" contenteditable="true"></td>
                <td class="editable-cell editing" data-field="klia_qty" contenteditable="true"></td>
                <td class="editable-cell editing" data-field="bukit_kayu_hitam_qty" contenteditable="true"></td>
                <td class="actions-column visible">
                    <div class="row-actions visible">
                        <button class="row-action-btn btn-insert-row" onclick="insertRowAfter(this)" title="Insert row below">+</button>
                        <button class="row-action-btn btn-delete-row" onclick="deleteRow(this)" title="Delete row">🗑️</button>
                    </div>
                </td>
            `;
            
            // Insert after the target row
            insertAfterRow.after(newRow);
            
            // Re-index all rows
            reindexRows();
            
            // Update delete button states
            updateDeleteButtonStates();
            
            // Focus on the HS Code cell of the new row
            const hsCodeCell = newRow.querySelector('[data-field="hs_code"]');
            if (hsCodeCell) {
                hsCodeCell.focus();
            }
        }
        
        // Delete a row by index or element
        function deleteRow(indexOrElement) {
            const tbody = document.getElementById('certItemsBody');
            const rows = tbody.querySelectorAll('tr[data-index]');
            
            // Check minimum row constraint
            if (rows.length <= 1) {
                alert('Cannot delete the last row. At least one row is required.');
                return;
            }
            
            let rowToDelete = null;
            
            if (typeof indexOrElement === 'number') {
                // Find by index
                rows.forEach(row => {
                    if (parseInt(row.dataset.index) === indexOrElement) {
                        rowToDelete = row;
                    }
                });
            } else {
                // Find by button element (get parent row)
                rowToDelete = indexOrElement.closest('tr[data-index]');
            }
            
            if (!rowToDelete) {
                console.error('Could not find row to delete');
                return;
            }
            
            // Store for undo
            const deletedIndex = parseInt(rowToDelete.dataset.index);
            const deletedHtml = rowToDelete.outerHTML;
            const nextSibling = rowToDelete.nextElementSibling;
            
            lastDeletedRow = {
                html: deletedHtml,
                index: deletedIndex,
                nextSibling: nextSibling,
                parentElement: tbody
            };
            
            // Remove the row
            rowToDelete.remove();
            
            // Re-index remaining rows
            reindexRows();
            
            // Update delete button states
            updateDeleteButtonStates();
            
            // Show undo toast
            showUndoToast('Row deleted');
        }
        
        // Re-index all rows in the table
        function reindexRows() {
            const tbody = document.getElementById('certItemsBody');
            const rows = tbody.querySelectorAll('tr[data-index]');
            
            rows.forEach((row, index) => {
                row.dataset.index = index;
                
                // Update onclick handlers for the action buttons
                const insertBtn = row.querySelector('.btn-insert-row');
                const deleteBtn = row.querySelector('.btn-delete-row');
                
                if (insertBtn) {
                    insertBtn.onclick = () => insertRowAfter(index);
                }
                if (deleteBtn) {
                    deleteBtn.onclick = () => deleteRow(index);
                }
            });
        }
        
        // Update delete button states (disable if only one row)
        function updateDeleteButtonStates() {
            const tbody = document.getElementById('certItemsBody');
            const rows = tbody.querySelectorAll('tr[data-index]');
            const deleteButtons = tbody.querySelectorAll('.btn-delete-row');
            
            deleteButtons.forEach(btn => {
                if (rows.length <= 1) {
                    btn.disabled = true;
                    btn.title = 'Cannot delete - at least one row required';
                } else {
                    btn.disabled = false;
                    btn.title = 'Delete row';
                }
            });
        }
        
        // Show undo toast notification
        function showUndoToast(message) {
            // Remove existing toast if any
            const existingToast = document.querySelector('.undo-toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            // Clear existing timeout
            if (undoToastTimeout) {
                clearTimeout(undoToastTimeout);
            }
            
            // Create toast element
            const toast = document.createElement('div');
            toast.className = 'undo-toast';
            toast.innerHTML = `
                <span class="toast-message">${escapeHtml(message)}</span>
                <button class="btn-undo" onclick="undoDelete()">Undo</button>
                <button class="toast-dismiss" onclick="dismissUndoToast()">&times;</button>
            `;
            
            document.body.appendChild(toast);
            
            // Auto-dismiss after 5 seconds
            undoToastTimeout = setTimeout(() => {
                dismissUndoToast();
            }, 5000);
        }
        
        // Dismiss undo toast
        function dismissUndoToast() {
            const toast = document.querySelector('.undo-toast');
            if (toast) {
                toast.classList.add('hiding');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }
            lastDeletedRow = null;
            if (undoToastTimeout) {
                clearTimeout(undoToastTimeout);
                undoToastTimeout = null;
            }
        }
        
        // Undo the last delete action
        function undoDelete() {
            if (!lastDeletedRow) {
                console.error('No row to restore');
                return;
            }
            
            const { html, nextSibling, parentElement } = lastDeletedRow;
            
            // Create a temporary container to parse the HTML
            const temp = document.createElement('tbody');
            temp.innerHTML = html;
            const restoredRow = temp.firstElementChild;
            
            // Insert the restored row
            if (nextSibling && nextSibling.parentElement === parentElement) {
                parentElement.insertBefore(restoredRow, nextSibling);
            } else {
                parentElement.appendChild(restoredRow);
            }
            
            // Re-index all rows
            reindexRows();
            
            // Make sure the restored row is editable if we're in edit mode
            if (isEditMode) {
                const cells = restoredRow.querySelectorAll('.editable-cell');
                cells.forEach(cell => {
                    cell.contentEditable = 'true';
                    cell.classList.add('editing');
                });
                
                // Show action buttons
                const actionsCol = restoredRow.querySelector('.actions-column');
                const rowActions = restoredRow.querySelector('.row-actions');
                if (actionsCol) actionsCol.classList.add('visible');
                if (rowActions) rowActions.classList.add('visible');
            }
            
            // Update delete button states
            updateDeleteButtonStates();
            
            // Dismiss the toast
            dismissUndoToast();
        }
        
        // Check if a row is completely empty (all data cells are empty)
        function isRowEmpty(row) {
            const fields = ['line_no', 'hs_code', 'item_name', 'approved_quantity', 'uom', 'port_klang_qty', 'klia_qty', 'bukit_kayu_hitam_qty'];
            
            for (const field of fields) {
                const cell = row.querySelector(`[data-field="${field}"]`);
                if (cell && cell.textContent.trim() !== '') {
                    return false;
                }
            }
            return true;
        }
        
        // Remove empty rows from the table (used before save)
        function removeEmptyRows() {
            const tbody = document.getElementById('certItemsBody');
            const rows = tbody.querySelectorAll('tr[data-index]');
            let removedCount = 0;
            
            // Don't remove if it would leave no rows
            const nonEmptyRows = Array.from(rows).filter(row => !isRowEmpty(row));
            if (nonEmptyRows.length === 0 && rows.length > 0) {
                // Keep at least one row even if empty
                return 0;
            }
            
            rows.forEach(row => {
                if (isRowEmpty(row) && nonEmptyRows.length > 0) {
                    row.remove();
                    removedCount++;
                }
            });
            
            if (removedCount > 0) {
                reindexRows();
            }
            
            return removedCount;
        }
        
        // Show save to database confirmation modal
        async function showSaveConfirmation() {
            // First check for missing required fields - this blocks save completely
            const missingCount = validateMissingRequiredFields();
            
            if (missingCount > 0) {
                // Show error modal instead of confirmation
                document.getElementById('missingDataErrorModal').classList.add('active');
                return;
            }
            
            // Check if certificate number already exists in database
            const certNumber = document.getElementById('certNumber').textContent.trim();
            if (certNumber && certNumber !== '-') {
                showElement('parserLoading');
                try {
                    const response = await fetch(`${API_BASE}/api/mida/certificates/check/${encodeURIComponent(certNumber)}`);
                    const data = await response.json();
                    
                    if (data.exists) {
                        hideElement('parserLoading');
                        // Show duplicate certificate warning modal
                        document.getElementById('duplicateCertNumber').textContent = certNumber;
                        document.getElementById('duplicateCertStatus').textContent = data.status;
                        document.getElementById('duplicateCertCompany').textContent = data.company_name || 'N/A';
                        document.getElementById('duplicateCertModal').classList.add('active');
                        return;
                    }
                } catch (error) {
                    console.error('Error checking certificate:', error);
                    // Continue with save if check fails
                } finally {
                    hideElement('parserLoading');
                }
            }
            
            // No missing data and no duplicate, show normal confirmation
            document.getElementById('confirmModal').classList.add('active');
        }
        
        // Hide confirmation modal
        function hideConfirmModal() {
            document.getElementById('confirmModal').classList.remove('active');
        }
        
        // Hide missing data error modal
        function hideMissingDataModal() {
            document.getElementById('missingDataErrorModal').classList.remove('active');
        }
        
        // Hide duplicate certificate modal
        function hideDuplicateCertModal() {
            document.getElementById('duplicateCertModal').classList.remove('active');
        }
        
        // Hide discrepancy confirmation modal
        function hideDiscrepancyModal() {
            document.getElementById('discrepancyConfirmModal').classList.remove('active');
        }
        
        // Save to database after confirmation
        function saveToDatabaseConfirmed() {
            hideConfirmModal();
            
            // Check if there are discrepancies
            const discrepancyCount = validateQuantityDiscrepancies();
            
            if (discrepancyCount > 0) {
                // Show additional warning modal for discrepancies
                document.getElementById('discrepancyConfirmModal').classList.add('active');
                return;
            }
            
            // Proceed with database save
            proceedWithDatabaseSave();
        }
        
        // Final save after discrepancy warning acknowledged
        async function proceedWithDatabaseSave() {
            hideDiscrepancyModal();
            
            // Show loading state
            showElement('parserLoading');
            document.getElementById('saveDatabaseBtn').disabled = true;
            
            try {
                // Build the request payload in the format expected by the API
                const payload = buildDatabaseSavePayload();
                
                console.log('Saving to database:', payload);
                
                const response = await fetch(`${API_BASE}/api/mida/certificates/draft`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });
                
                // Handle non-JSON error responses (like plain text "Internal Server Error")
                let data;
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    const text = await response.text();
                    data = { detail: text || `Server error (${response.status})` };
                }
                
                if (!response.ok) {
                    // Handle specific error cases
                    if (response.status === 409) {
                        // Certificate already exists - duplicates not allowed
                        showDatabaseSaveError(
                            'Certificate Already Exists',
                            `Certificate "${payload.header.certificate_number}" already exists in the database. Duplicate certificates are not allowed. Please use a different certificate number or view the existing certificate in the Database View tab.`
                        );
                    } else if (response.status === 422) {
                        // Validation error
                        const errorMsg = data.detail?.[0]?.msg || data.detail || 'Validation error';
                        showDatabaseSaveError('Validation Error', errorMsg);
                    } else if (response.status === 500) {
                        // Internal server error - show more helpful message
                        console.error('Server error details:', data);
                        showDatabaseSaveError('Server Error', 'An internal server error occurred. Please check the server logs for details.');
                    } else {
                        showDatabaseSaveError('Save Failed', data.detail || 'An error occurred while saving to the database.');
                    }
                    return;
                }
                
                // Success! Show success modal
                showDatabaseSaveSuccess(data, false);  // Always a new certificate now
                
            } catch (error) {
                console.error('Error saving to database:', error);
                showDatabaseSaveError('Connection Error', 'Error connecting to server: ' + error.message);
            } finally {
                hideElement('parserLoading');
                document.getElementById('saveDatabaseBtn').disabled = false;
            }
        }
        
        // Build the payload for database save API
        function buildDatabaseSavePayload() {
            // Get header values
            const certNumber = document.getElementById('certNumber').textContent.trim();
            const company = document.getElementById('certCompany').textContent.trim();
            let modelNumber = document.getElementById('certModelNumber').textContent.trim();
            if (modelNumber === '-') modelNumber = '';  // Convert placeholder to empty for validation
            const startDateEl = document.getElementById('certStartDate');
            const endDateEl = document.getElementById('certEndDate');
            
            // Get dates from data attributes (ISO format)
            let startDate = startDateEl.dataset.isoDate || null;
            let endDate = endDateEl.dataset.isoDate || null;
            
            // If empty string, convert to null
            if (startDate === '') startDate = null;
            if (endDate === '') endDate = null;
            
            // Get source filename from the file input
            const fileInput = document.getElementById('pdfInput');
            const sourceFilename = fileInput.files[0]?.name || null;
            
            // Build items array from the table, filtering out completely empty rows
            const items = [];
            const rows = document.querySelectorAll('#certItemsBody tr[data-index]');
            let lineNumber = 1; // Sequential line numbering for non-empty rows
            
            rows.forEach((row) => {
                const lineNoText = row.querySelector('[data-field="line_no"]')?.textContent.trim() || '';
                const hsCode = row.querySelector('[data-field="hs_code"]')?.textContent.trim() || '';
                const itemName = row.querySelector('[data-field="item_name"]')?.textContent.trim() || '';
                const approvedQtyText = row.querySelector('[data-field="approved_quantity"]')?.textContent.trim() || '';
                const uom = row.querySelector('[data-field="uom"]')?.textContent.trim() || '';
                const portKlangText = row.querySelector('[data-field="port_klang_qty"]')?.textContent.trim() || '';
                const kliaText = row.querySelector('[data-field="klia_qty"]')?.textContent.trim() || '';
                const bukitKayuHitamText = row.querySelector('[data-field="bukit_kayu_hitam_qty"]')?.textContent.trim() || '';
                
                // Check if row is completely empty (all cells empty)
                const allFieldsEmpty = !lineNoText && !hsCode && !itemName && !approvedQtyText && 
                                       !uom && !portKlangText && !kliaText && !bukitKayuHitamText;
                
                // Skip completely empty rows
                if (allFieldsEmpty) {
                    return; // Skip this row
                }
                
                const item = {
                    line_no: lineNumber++, // Use sequential numbering (1, 2, 3...)
                    hs_code: hsCode,
                    item_name: itemName,
                    approved_quantity: approvedQtyText ? parseFloat(approvedQtyText) : null,
                    uom: uom,
                    port_klang_qty: portKlangText ? parseFloat(portKlangText) : null,
                    klia_qty: kliaText ? parseFloat(kliaText) : null,
                    bukit_kayu_hitam_qty: bukitKayuHitamText ? parseFloat(bukitKayuHitamText) : null,
                };
                
                items.push(item);
            });
            
            // Build the full payload
            return {
                header: {
                    certificate_number: certNumber,
                    company_name: company,
                    model_number: modelNumber,
                    exemption_start_date: startDate,
                    exemption_end_date: endDate,
                    source_filename: sourceFilename,
                },
                items: items,
                raw_ocr_json: parsedCertificateData, // Store the original OCR data for reference
            };
        }
        
        // Show database save success modal
        function showDatabaseSaveSuccess(savedCertificate, isUpdate) {
            const modal = document.getElementById('saveSuccessModal');
            const titleEl = document.getElementById('saveSuccessTitle');
            const messageEl = document.getElementById('saveSuccessMessage');
            const detailsEl = document.getElementById('saveSuccessDetails');
            
            titleEl.textContent = isUpdate ? '✅ Certificate Updated' : '✅ Certificate Saved';
            messageEl.textContent = isUpdate 
                ? 'The certificate has been updated in the database.'
                : 'The certificate has been saved to the database.';
            
            // Clear unsaved changes since data was saved to database
            workflowHistory.setUnsavedChanges(false);
            
            detailsEl.innerHTML = `
                <div class="info-card" style="margin-top: 1rem;">
                    <div class="info-card-grid">
                        <div class="info-card-item">
                            <span class="info-card-label">Certificate Number</span>
                            <span class="info-card-value">${escapeHtml(savedCertificate.certificate_number)}</span>
                        </div>
                        <div class="info-card-item">
                            <span class="info-card-label">Company Name</span>
                            <span class="info-card-value">${escapeHtml(savedCertificate.company_name)}</span>
                        </div>
                        <div class="info-card-item">
                            <span class="info-card-label">Status</span>
                            <span class="info-card-value"><span class="status-badge ${savedCertificate.status}">${savedCertificate.status}</span></span>
                        </div>
                        <div class="info-card-item">
                            <span class="info-card-label">Items Saved</span>
                            <span class="info-card-value">${savedCertificate.items?.length || 0}</span>
                        </div>
                    </div>
                </div>
                <p style="margin-top: 1rem; font-size: 0.9rem; color: #7f8c8d;">
                    You can view this certificate in the <strong>Database View</strong> tab.
                </p>
            `;
            
            modal.classList.add('active');
        }
        
        // Hide database save success modal
        function hideSaveSuccessModal() {
            document.getElementById('saveSuccessModal').classList.remove('active');
        }
        
        // Show database save error modal
        function showDatabaseSaveError(title, message) {
            const modal = document.getElementById('saveErrorModal');
            document.getElementById('saveErrorTitle').textContent = '❌ ' + title;
            document.getElementById('saveErrorMessage').textContent = message;
            modal.classList.add('active');
        }
        
        // Hide database save error modal
        function hideSaveErrorModal() {
            document.getElementById('saveErrorModal').classList.remove('active');
        }
        
        // Show parser error
        function showParserError(message) {
            document.getElementById('parserErrorText').textContent = message;
            showElement('parserError');
        }
        
        // ==========================================
        // Database View - Hierarchical Data Browser
        // ==========================================
        
        // State management for database view
        const dbState = {
            certificates: [],
            certificatesTotal: 0,
            certificatesPage: 1,
            certificatesPerPage: 100,
            
            selectedCertificate: null,
            items: [],
            itemsTotal: 0,
            itemsPage: 1,
            itemsPerPage: 100,
            quantityView: 'approved', // 'approved' or 'remaining'
            
            selectedItem: null,
            imports: [],
            importsTotal: 0,
            importsPage: 1,
            importsPerPage: 100,
            currentPort: 'all'
        };
        
        // Initialize database view when tab is switched
        function initDatabaseView() {
            loadCertificates();
        }
        
        // Format number with thousands separator and decimal places
        function formatNumber(value, decimals = 3) {
            if (value === null || value === undefined || value === '') return '-';
            const num = parseFloat(value);
            if (isNaN(num)) return '-';
            return num.toLocaleString('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: decimals
            });
        }
        
        // Format date from ISO to display format
        function formatDate(isoDate) {
            if (!isoDate) return '-';
            const date = new Date(isoDate);
            if (isNaN(date.getTime())) return isoDate;
            return date.toLocaleDateString('en-GB', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }
        
        // Get CSS class for quantity status
        function getStatusClass(status) {
            switch (status) {
                case 'normal': return 'qty-status-normal';
                case 'warning': return 'qty-status-warning';
                case 'depleted': return 'qty-status-depleted';
                case 'overdrawn': return 'qty-status-overdrawn';
                default: return '';
            }
        }
        
        // Get display name for port
        function getPortDisplayName(port) {
            switch (port) {
                case 'port_klang': return 'Port Klang';
                case 'klia': return 'KLIA';
                case 'bukit_kayu_hitam': return 'Bukit Kayu Hitam';
                default: return port;
            }
        }
        
        // Show database error
        function showDbError(message) {
            document.getElementById('dbErrorText').textContent = message;
            showElement('dbError');
        }
        
        // Hide database error
        function hideDbError() {
            hideElement('dbError');
        }
        
        // Update breadcrumb navigation
        function updateBreadcrumb(level, data = {}) {
            const breadcrumb = document.getElementById('dbBreadcrumb');
            let html = '';
            
            if (level === 'certificates') {
                html = '<span class="breadcrumb-item active">📋 Certificates</span>';
            } else if (level === 'items') {
                html = `
                    <span class="breadcrumb-item" onclick="dbNavigateToCertificates()">📋 Certificates</span>
                    <span class="breadcrumb-separator">›</span>
                    <span class="breadcrumb-item active">📦 ${escapeHtml(data.certificateNumber || 'Items')}</span>
                `;
            } else if (level === 'imports') {
                html = `
                    <span class="breadcrumb-item" onclick="dbNavigateToCertificates()">📋 Certificates</span>
                    <span class="breadcrumb-separator">›</span>
                    <span class="breadcrumb-item" onclick="dbNavigateToItems()">📦 ${escapeHtml(data.certificateNumber || 'Items')}</span>
                    <span class="breadcrumb-separator">›</span>
                    <span class="breadcrumb-item active">📥 ${escapeHtml(data.itemName || 'Imports')}</span>
                `;
            }
            
            breadcrumb.innerHTML = html;
        }
        
        // Render pagination controls
        function renderPagination(containerId, infoId, currentPage, totalItems, perPage, onPageChange) {
            const container = document.getElementById(containerId);
            const info = document.getElementById(infoId);
            const totalPages = Math.ceil(totalItems / perPage);
            
            // Always show pagination bar if there are items (for rows-per-page dropdown)
            if (totalItems === 0) {
                container.classList.add('hidden');
                return;
            }
            
            container.classList.remove('hidden');
            
            const startItem = (currentPage - 1) * perPage + 1;
            const endItem = Math.min(currentPage * perPage, totalItems);
            info.textContent = `Showing ${startItem}-${endItem} of ${totalItems}`;
            
            const controls = container.querySelector('.pagination-controls');
            let html = '';
            
            // Hide page controls if only one page
            if (totalPages <= 1) {
                controls.innerHTML = '';
                return;
            }
            
            // Previous button
            html += `<button class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="${onPageChange}(${currentPage - 1})">← Prev</button>`;
            
            // Page numbers
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            if (startPage > 1) {
                html += `<button class="pagination-page" onclick="${onPageChange}(1)">1</button>`;
                if (startPage > 2) html += '<span style="color: #7f8c8d;">...</span>';
            }
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="pagination-page ${i === currentPage ? 'active' : ''}" onclick="${onPageChange}(${i})">${i}</button>`;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) html += '<span style="color: #7f8c8d;">...</span>';
                html += `<button class="pagination-page" onclick="${onPageChange}(${totalPages})">${totalPages}</button>`;
            }
            
            // Next button
            html += `<button class="pagination-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="${onPageChange}(${currentPage + 1})">Next →</button>`;
            
            controls.innerHTML = html;
        }
        
        // Render empty state
        function renderEmptyState(tbodyId, colspan, icon, text, subtext) {
            const tbody = document.getElementById(tbodyId);
            tbody.innerHTML = `
                <tr>
                    <td colspan="${colspan}">
                        <div class="empty-state">
                            <div class="empty-state-icon">${icon}</div>
                            <div class="empty-state-text">${text}</div>
                            <div class="empty-state-subtext">${subtext}</div>
                        </div>
                    </td>
                </tr>
            `;
        }
        
        // ==========================================
        // Level 1: Certificates
        // ==========================================
        
        async function loadCertificates(page = 1) {
            dbState.certificatesPage = page;
            hideDbError();
            showElement('dbLoading');
            
            try {
                const offset = (page - 1) * dbState.certificatesPerPage;
                const response = await fetch(`${API_BASE}/api/mida/certificates?limit=${dbState.certificatesPerPage}&offset=${offset}`);
                
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.detail || 'Failed to load certificates');
                }
                
                const data = await response.json();
                dbState.certificates = data.items || [];
                dbState.certificatesTotal = data.total || 0;
                
                // Update the rows-per-page dropdown to reflect current setting
                const perPageSelect = document.getElementById('certificatesPerPageSelect');
                if (perPageSelect) perPageSelect.value = dbState.certificatesPerPage;
                
                renderCertificatesTable();
                renderPagination(
                    'certificatesPagination',
                    'certificatesPaginationInfo',
                    dbState.certificatesPage,
                    dbState.certificatesTotal,
                    dbState.certificatesPerPage,
                    'goToCertificatesPage'
                );
                
            } catch (error) {
                console.error('Error loading certificates:', error);
                showDbError('Error loading certificates: ' + error.message);
            } finally {
                hideElement('dbLoading');
            }
        }
        
        function goToCertificatesPage(page) {
            loadCertificates(page);
        }
        
        function changeCertificatesPerPage(value) {
            const newValue = parseInt(value);
            if (newValue === dbState.certificatesPerPage) return; // Prevent infinite loop
            dbState.certificatesPerPage = newValue;
            dbState.certificatesPage = 1; // Reset to first page
            loadCertificates(1);
        }
        
        function renderCertificatesTable() {
            const tbody = document.getElementById('certificatesTableBody');
            
            if (dbState.certificates.length === 0) {
                renderEmptyState(
                    'certificatesTableBody',
                    7,
                    '📋',
                    'No certificates found',
                    'Upload and parse a MIDA certificate to get started.'
                );
                return;
            }
            
            tbody.innerHTML = '';
            
            dbState.certificates.forEach((cert, index) => {
                const row = document.createElement('tr');
                row.className = 'clickable-row';
                row.dataset.id = cert.id;
                
                const statusBadge = `<span class="status-badge ${cert.status}">${cert.status}</span>`;
                const isExpired = cert.status === 'expired';
                
                row.innerHTML = `
                    <td onclick="selectCertificate(dbState.certificates[${index}])">${escapeHtml(cert.certificate_number || '-')}</td>
                    <td onclick="selectCertificate(dbState.certificates[${index}])">${escapeHtml(cert.company_name || '-')}</td>
                    <td onclick="selectCertificate(dbState.certificates[${index}])">${formatDate(cert.exemption_start_date)}</td>
                    <td onclick="selectCertificate(dbState.certificates[${index}])">${formatDate(cert.exemption_end_date)}</td>
                    <td onclick="selectCertificate(dbState.certificates[${index}])">${statusBadge}</td>
                    <td onclick="selectCertificate(dbState.certificates[${index}])">${cert.items?.length || '-'}</td>
                    <td>
                        <button class="btn-action btn-action-edit" onclick="event.stopPropagation(); selectAndEditCertificate(dbState.certificates[${index}])" title="Edit Certificate" style="margin-right: 0.25rem;" ${isExpired ? 'disabled' : ''}>✏️</button>
                        <button class="btn-action btn-action-delete" onclick="event.stopPropagation(); showDeleteCertModal('${cert.id}', '${escapeHtml(cert.certificate_number)}', '${escapeHtml(cert.company_name)}')" title="Delete Certificate">🗑️</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function selectAndEditCertificate(cert) {
            dbState.selectedCertificate = cert;
            showEditCertificateModal();
        }
        
        function selectCertificate(cert) {
            dbState.selectedCertificate = cert;
            dbState.itemsPage = 1;
            
            // Update info card
            document.getElementById('infoCertNumber').textContent = cert.certificate_number || '-';
            document.getElementById('infoCertCompany').textContent = cert.company_name || '-';
            document.getElementById('infoCertModelNumber').textContent = cert.model_number || '-';
            document.getElementById('infoCertPeriod').textContent = 
                `${formatDate(cert.exemption_start_date)} - ${formatDate(cert.exemption_end_date)}`;
            document.getElementById('infoCertStatus').innerHTML = 
                `<span class="status-badge ${cert.status}">${cert.status}</span>`;
            
            // Update breadcrumb
            updateBreadcrumb('items', { certificateNumber: cert.certificate_number });
            
            // Show items view
            hideElement('certificatesView');
            showElement('itemsView');
            
            // Track in workflow history
            workflowHistory.pushState({
                type: 'database-items',
                tab: 'database',
                label: `📦 ${cert.certificate_number || 'Items'}`,
                certificate: cert,
                quantityView: dbState.quantityView
            });
            
            // Load items for this certificate
            loadCertificateItems(cert.id);
        }
        
        // ==========================================
        // Level 2: Certificate Items
        // ==========================================
        
        async function loadCertificateItems(certificateId, page = 1) {
            dbState.itemsPage = page;
            hideDbError();
            showElement('dbLoading');
            
            try {
                // Use the balances endpoint with server-side pagination
                const offset = (page - 1) * dbState.itemsPerPage;
                const response = await fetch(`${API_BASE}/api/mida/imports/balances?certificate_id=${certificateId}&limit=${dbState.itemsPerPage}&offset=${offset}`);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `Server error: ${response.status}`);
                }
                
                const data = await response.json();
                dbState.items = data.items || data || [];
                dbState.itemsTotal = data.total || dbState.items.length;
                
                // Update the rows-per-page dropdown to reflect current setting (without triggering onchange)
                const perPageSelect = document.getElementById('itemsPerPageSelect');
                if (perPageSelect && perPageSelect.value !== String(dbState.itemsPerPage)) {
                    perPageSelect.value = dbState.itemsPerPage;
                }
                
                renderItemsTable();
                
                // Render pagination using server-side total
                renderPagination(
                    'itemsPagination',
                    'itemsPaginationInfo',
                    dbState.itemsPage,
                    dbState.itemsTotal,
                    dbState.itemsPerPage,
                    'goToItemsPage'
                );
                
            } catch (error) {
                console.error('Error loading items:', error);
                const errorMsg = error.message || (typeof error === 'string' ? error : 'Unknown error');
                showDbError('Error loading items: ' + errorMsg);
            } finally {
                hideElement('dbLoading');
            }
        }
        
        function goToItemsPage(page) {
            // Server-side pagination - re-fetch data from server
            loadCertificateItems(dbState.selectedCertificate.id, page);
        }
        
        function changeItemsPerPage(value) {
            const newValue = parseInt(value);
            if (newValue === dbState.itemsPerPage) return; // Prevent infinite loop
            dbState.itemsPerPage = newValue;
            dbState.itemsPage = 1; // Reset to first page
            loadCertificateItems(dbState.selectedCertificate.id, 1);
        }
        
        function paginateArray(array, page, perPage) {
            const start = (page - 1) * perPage;
            return array.slice(start, start + perPage);
        }
        
        function toggleQuantityView(view) {
            dbState.quantityView = view;
            
            // Update toggle buttons
            document.getElementById('toggleApproved').classList.toggle('active', view === 'approved');
            document.getElementById('toggleRemaining').classList.toggle('active', view === 'remaining');
            
            // Update table header
            const headerCell = document.querySelector('#itemsTable thead th:nth-child(5)');
            headerCell.textContent = view === 'approved' ? 'Total Qty' : 'Remaining Qty';
            
            // Re-render table
            renderItemsTable();
        }
        
        function renderItemsTable() {
            const tbody = document.getElementById('itemsTableBody');
            
            if (dbState.items.length === 0) {
                renderEmptyState(
                    'itemsTableBody',
                    10,
                    '📦',
                    'No items found for this certificate',
                    'This certificate has no associated items.'
                );
                return;
            }
            
            tbody.innerHTML = '';
            // Server-side pagination: items are already paginated by the API
            
            dbState.items.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = 'clickable-row';
                row.dataset.id = item.item_id;
                
                const statusClass = getStatusClass(item.quantity_status);
                const statusBadge = `<span class="status-badge ${item.quantity_status || 'normal'}">${item.quantity_status || 'normal'}</span>`;
                
                // Determine which quantities to show based on toggle
                const isApproved = dbState.quantityView === 'approved';
                const totalQty = isApproved ? item.approved_quantity : item.remaining_quantity;
                const portKlangQty = isApproved ? item.port_klang_qty : item.remaining_port_klang;
                const kliaQty = isApproved ? item.klia_qty : item.remaining_klia;
                const bukitQty = isApproved ? item.bukit_kayu_hitam_qty : item.remaining_bukit_kayu_hitam;
                
                // Apply status coloring to remaining values regardless of toggle view
                const applyStatusColor = (value, status) => {
                    const statusCls = getStatusClass(status);
                    return statusCls ? `<span class="${statusCls}">${formatNumber(value)}</span>` : formatNumber(value);
                };
                
                // Store item reference for action buttons
                const itemJson = JSON.stringify(item).replace(/'/g, "\\'").replace(/"/g, '&quot;');
                
                row.innerHTML = `
                    <td onclick="selectItem(dbState.items[${index}])">${item.line_no || '-'}</td>
                    <td onclick="selectItem(dbState.items[${index}])">${escapeHtml(item.hs_code || item.item_hs_code || '-')}</td>
                    <td onclick="selectItem(dbState.items[${index}])">${escapeHtml(item.item_name || '-')}</td>
                    <td onclick="selectItem(dbState.items[${index}])">${escapeHtml(item.uom || item.item_uom || '-')}</td>
                    <td class="number-cell ${statusClass}" onclick="selectItem(dbState.items[${index}])">${formatNumber(totalQty)}</td>
                    <td class="number-cell ${statusClass}" onclick="selectItem(dbState.items[${index}])">${formatNumber(portKlangQty)}</td>
                    <td class="number-cell ${statusClass}" onclick="selectItem(dbState.items[${index}])">${formatNumber(kliaQty)}</td>
                    <td class="number-cell ${statusClass}" onclick="selectItem(dbState.items[${index}])">${formatNumber(bukitQty)}</td>
                    <td onclick="selectItem(dbState.items[${index}])">${statusBadge}</td>
                    <td>
                        <button class="btn-action btn-action-edit" onclick="event.stopPropagation(); showEditItemModal(dbState.items[${index}])" title="Edit Item" style="margin-right: 0.25rem; padding: 0.25rem 0.5rem; font-size: 0.8rem;">✏️</button>
                        <button class="btn-action btn-action-delete" onclick="event.stopPropagation(); showDeleteItemModal(dbState.items[${index}])" title="Delete Item" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">🗑️</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function selectItem(item) {
            dbState.selectedItem = item;
            dbState.importsPage = 1;
            dbState.currentPort = 'all';
            
            // Update info card
            document.getElementById('infoItemCert').textContent = 
                dbState.selectedCertificate?.certificate_number || item.certificate_number || '-';
            document.getElementById('infoItemHsCode').textContent = item.hs_code || item.item_hs_code || '-';
            document.getElementById('infoItemName').textContent = item.item_name || '-';
            document.getElementById('infoItemUom').textContent = item.uom || item.item_uom || '-';
            
            // Update breadcrumb
            updateBreadcrumb('imports', {
                certificateNumber: dbState.selectedCertificate?.certificate_number || item.certificate_number,
                itemName: item.item_name || `Line ${item.line_no}`
            });
            
            // Reset port filter buttons
            document.querySelectorAll('.port-filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.port === 'all');
            });
            
            // Show imports view
            hideElement('itemsView');
            showElement('importsView');
            
            // Track in workflow history
            workflowHistory.pushState({
                type: 'database-imports',
                tab: 'database',
                label: `📥 ${item.item_name || 'Line ' + item.line_no}`,
                certificate: dbState.selectedCertificate,
                item: item,
                port: 'all'
            });
            
            // Load imports for this item
            loadImportRecords(item.item_id);
        }
        
        // ==========================================
        // Level 3: Import Records
        // ==========================================
        
        async function loadImportRecords(itemId, port = 'all', page = 1) {
            dbState.importsPage = page;
            dbState.currentPort = port;
            hideDbError();
            showElement('dbLoading');
            
            try {
                const offset = (page - 1) * dbState.importsPerPage;
                let url = `${API_BASE}/api/mida/imports/history/item/${itemId}`;
                const params = [`limit=${dbState.importsPerPage}`, `offset=${offset}`];
                
                if (port !== 'all') {
                    params.push(`port=${port}`);
                }
                
                url += '?' + params.join('&');
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.detail || 'Failed to load import records');
                }
                
                const data = await response.json();
                dbState.imports = data.imports || [];
                dbState.importsTotal = data.total || dbState.imports.length;
                
                // Update the rows-per-page dropdown to reflect current setting
                const perPageSelect = document.getElementById('importsPerPageSelect');
                if (perPageSelect) perPageSelect.value = dbState.importsPerPage;
                
                renderImportsTable();
                
                // Handle pagination
                renderPagination(
                    'importsPagination',
                    'importsPaginationInfo',
                    dbState.importsPage,
                    dbState.importsTotal,
                    dbState.importsPerPage,
                    'goToImportsPage'
                );
                
            } catch (error) {
                console.error('Error loading imports:', error);
                showDbError('Error loading import records: ' + error.message);
            } finally {
                hideElement('dbLoading');
            }
        }
        
        function goToImportsPage(page) {
            // Server-side pagination - re-fetch data from server
            loadImportRecords(dbState.selectedItem.item_id, dbState.currentPort, page);
        }
        
        function changeImportsPerPage(value) {
            const newValue = parseInt(value);
            if (newValue === dbState.importsPerPage) return; // Prevent infinite loop
            dbState.importsPerPage = newValue;
            dbState.importsPage = 1; // Reset to first page
            loadImportRecords(dbState.selectedItem.item_id, dbState.currentPort, 1);
        }
        
        function filterByPort(port) {
            // Update button states
            document.querySelectorAll('.port-filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.port === port);
            });
            
            // Reload with filter
            loadImportRecords(dbState.selectedItem.item_id, port, 1);
        }
        
        function renderImportsTable() {
            const tbody = document.getElementById('importsTableBody');
            
            if (dbState.imports.length === 0) {
                const portName = dbState.currentPort === 'all' ? 'any port' : getPortDisplayName(dbState.currentPort);
                renderEmptyState(
                    'importsTableBody',
                    8,
                    '📥',
                    'No import records found',
                    `There are no import records for this item from ${portName}.`
                );
                return;
            }
            
            tbody.innerHTML = '';
            // Server-side pagination: imports are already paginated by the API
            
            dbState.imports.forEach(record => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${formatDate(record.import_date)}</td>
                    <td>${escapeHtml(record.invoice_number || '-')}</td>
                    <td>${record.invoice_line || '-'}</td>
                    <td>${getPortDisplayName(record.port)}</td>
                    <td class="number-cell">${formatNumber(record.quantity_imported)}</td>
                    <td class="number-cell">${formatNumber(record.balance_before)}</td>
                    <td class="number-cell">${formatNumber(record.balance_after)}</td>
                    <td>${escapeHtml(record.remarks || '-')}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // ==========================================
        // Navigation
        // ==========================================
        
        function dbNavigateToCertificates() {
            dbState.selectedCertificate = null;
            dbState.selectedItem = null;
            
            updateBreadcrumb('certificates');
            
            hideElement('itemsView');
            hideElement('importsView');
            showElement('certificatesView');
            
            // Track in workflow history
            workflowHistory.pushState({
                type: 'database-certificates',
                tab: 'database',
                label: '📋 Certificates',
                subTab: 'active'
            });
            
            // Reload certificates to ensure fresh data
            loadCertificates(dbState.certificatesPage);
        }
        
        function dbNavigateToItems() {
            dbState.selectedItem = null;
            
            updateBreadcrumb('items', {
                certificateNumber: dbState.selectedCertificate?.certificate_number
            });
            
            hideElement('importsView');
            showElement('itemsView');
            
            // Track in workflow history (going back to items from imports)
            workflowHistory.pushState({
                type: 'database-items',
                tab: 'database',
                label: `📦 ${dbState.selectedCertificate?.certificate_number || 'Items'}`,
                certificate: dbState.selectedCertificate,
                quantityView: dbState.quantityView
            });
        }
        
        // Override switchTab to initialize database view and track history
        const originalSwitchTab = switchTab;
        switchTab = function(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            document.querySelector(`.tab-content#${tabName}-tab`).classList.add('active');
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            // Track in workflow history
            const tabLabels = {
                'converter': '📄 Invoice Converter',
                'parser': '🔍 Certificate Parser',
                'database': '🗄️ Database View'
            };
            
            // For database tab, push certificates state
            if (tabName === 'database') {
                workflowHistory.pushState({
                    type: 'database-certificates',
                    tab: 'database',
                    label: tabLabels[tabName],
                    subTab: 'active'
                });
                initDatabaseView();
            } else {
                workflowHistory.pushState({
                    type: 'tab',
                    tab: tabName,
                    label: tabLabels[tabName] || tabName
                });
            }
        };
        
        // ==========================================
        // Deleted Certificates Management
        // ==========================================
        
        // State for deleted certificates
        let deletedCertificatesState = {
            certificates: [],
            page: 1,
            perPage: 100,
            total: 0,
            pendingAction: null,  // { type: 'delete'|'restore'|'permanent', id, certNumber, company }
        };
        
        // Switch between Active and Deleted sub-tabs
        function switchDbSubTab(tab) {
            const activeTab = document.getElementById('activeCertsTab');
            const deletedTab = document.getElementById('deletedCertsTab');
            const activeSection = document.getElementById('activeCertificatesSection');
            const deletedSection = document.getElementById('deletedCertificatesSection');
            
            if (tab === 'active') {
                activeTab.classList.add('active');
                deletedTab.classList.remove('active');
                showElement('activeCertificatesSection');
                hideElement('deletedCertificatesSection');
                loadCertificates(dbState.certificatesPage);
            } else {
                activeTab.classList.remove('active');
                deletedTab.classList.add('active');
                hideElement('activeCertificatesSection');
                showElement('deletedCertificatesSection');
                loadDeletedCertificates(1);
            }
        }
        
        // Load deleted certificates
        async function loadDeletedCertificates(page = 1) {
            deletedCertificatesState.page = page;
            hideDbError();
            showElement('dbLoading');
            
            try {
                const offset = (page - 1) * deletedCertificatesState.perPage;
                const response = await fetch(`${API_BASE}/api/mida/certificates/deleted?limit=${deletedCertificatesState.perPage}&offset=${offset}`);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `HTTP error ${response.status}`);
                }
                
                const data = await response.json();
                deletedCertificatesState.certificates = data.items;
                deletedCertificatesState.total = data.total;
                
                renderDeletedCertificatesTable();
                renderDeletedCertificatesPagination();
                
            } catch (error) {
                console.error('Error loading deleted certificates:', error);
                showDbError(error.message);
            } finally {
                hideElement('dbLoading');
            }
        }
        
        function renderDeletedCertificatesTable() {
            const tbody = document.getElementById('deletedCertificatesTableBody');
            
            if (deletedCertificatesState.certificates.length === 0) {
                renderEmptyState(
                    'deletedCertificatesTableBody',
                    6,
                    '🗑️',
                    'No deleted certificates',
                    'Deleted certificates will appear here.'
                );
                return;
            }
            
            tbody.innerHTML = '';
            
            deletedCertificatesState.certificates.forEach(cert => {
                const row = document.createElement('tr');
                row.dataset.id = cert.id;
                
                const deletedAt = cert.deleted_at ? new Date(cert.deleted_at).toLocaleString() : '-';
                
                row.innerHTML = `
                    <td>${escapeHtml(cert.certificate_number || '-')}</td>
                    <td>${escapeHtml(cert.company_name || '-')}</td>
                    <td>${formatDate(cert.exemption_start_date)}</td>
                    <td>${formatDate(cert.exemption_end_date)}</td>
                    <td>${deletedAt}</td>
                    <td>
                        <button class="btn-action btn-action-restore" onclick="showRestoreCertModal('${cert.id}', '${escapeHtml(cert.certificate_number)}', '${escapeHtml(cert.company_name)}')" title="Restore Certificate">♻️</button>
                        <button class="btn-action btn-action-permanent" onclick="showPermanentDeleteCertModal('${cert.id}', '${escapeHtml(cert.certificate_number)}', '${escapeHtml(cert.company_name)}')" title="Permanently Delete">🗑️</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function renderDeletedCertificatesPagination() {
            const container = document.getElementById('deletedCertificatesPaginationControls');
            const info = document.getElementById('deletedCertificatesPaginationInfo');
            const total = deletedCertificatesState.total;
            const perPage = deletedCertificatesState.perPage;
            const page = deletedCertificatesState.page;
            
            if (total === 0) {
                hideElement('deletedCertificatesPagination');
                return;
            }
            
            showElement('deletedCertificatesPagination');
            
            const totalPages = Math.ceil(total / perPage);
            const start = (page - 1) * perPage + 1;
            const end = Math.min(page * perPage, total);
            
            info.textContent = `Showing ${start}-${end} of ${total} deleted certificates`;
            
            let paginationHtml = '';
            
            paginationHtml += `<button class="pagination-btn" onclick="loadDeletedCertificates(1)" ${page === 1 ? 'disabled' : ''}>«</button>`;
            paginationHtml += `<button class="pagination-btn" onclick="loadDeletedCertificates(${page - 1})" ${page === 1 ? 'disabled' : ''}>‹</button>`;
            
            const startPage = Math.max(1, page - 2);
            const endPage = Math.min(totalPages, page + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHtml += `<button class="pagination-btn ${i === page ? 'active' : ''}" onclick="loadDeletedCertificates(${i})">${i}</button>`;
            }
            
            paginationHtml += `<button class="pagination-btn" onclick="loadDeletedCertificates(${page + 1})" ${page === totalPages ? 'disabled' : ''}>›</button>`;
            paginationHtml += `<button class="pagination-btn" onclick="loadDeletedCertificates(${totalPages})" ${page === totalPages ? 'disabled' : ''}>»</button>`;
            
            container.innerHTML = paginationHtml;
        }
        
        function changeDeletedCertificatesPerPage(value) {
            const newValue = parseInt(value);
            if (newValue === deletedCertificatesState.perPage) return;
            deletedCertificatesState.perPage = newValue;
            deletedCertificatesState.page = 1;
            loadDeletedCertificates(1);
        }
        
        // ==========================================
        // Delete/Restore/Permanent Delete Modals
        // ==========================================
        
        function showDeleteCertModal(id, certNumber, company) {
            deletedCertificatesState.pendingAction = { type: 'delete', id, certNumber, company };
            document.getElementById('deleteCertNumber').textContent = certNumber;
            document.getElementById('deleteCertCompany').textContent = company;
            document.getElementById('deleteCertModal').classList.add('active');
        }
        
        function hideDeleteCertModal() {
            document.getElementById('deleteCertModal').classList.remove('active');
            deletedCertificatesState.pendingAction = null;
        }
        
        async function confirmDeleteCertificate() {
            const action = deletedCertificatesState.pendingAction;
            if (!action || action.type !== 'delete') return;
            
            hideDeleteCertModal();
            showElement('dbLoading');
            
            try {
                const response = await fetch(`${API_BASE}/api/mida/certificates/${action.id}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `HTTP error ${response.status}`);
                }
                
                // Reload active certificates
                loadCertificates(dbState.certificatesPage);
                
            } catch (error) {
                console.error('Error deleting certificate:', error);
                showDbError(error.message);
            } finally {
                hideElement('dbLoading');
            }
        }
        
        function showRestoreCertModal(id, certNumber, company) {
            deletedCertificatesState.pendingAction = { type: 'restore', id, certNumber, company };
            document.getElementById('restoreCertNumber').textContent = certNumber;
            document.getElementById('restoreCertCompany').textContent = company;
            document.getElementById('restoreCertModal').classList.add('active');
        }
        
        function hideRestoreCertModal() {
            document.getElementById('restoreCertModal').classList.remove('active');
            deletedCertificatesState.pendingAction = null;
        }
        
        async function confirmRestoreCertificate() {
            const action = deletedCertificatesState.pendingAction;
            if (!action || action.type !== 'restore') return;
            
            hideRestoreCertModal();
            showElement('dbLoading');
            
            try {
                const response = await fetch(`${API_BASE}/api/mida/certificates/${action.id}/restore`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    
                    // Check for conflict (certificate number already in use)
                    if (response.status === 409) {
                        hideElement('dbLoading');
                        document.getElementById('conflictCertNumber').textContent = action.certNumber;
                        document.getElementById('restoreConflictModal').classList.add('active');
                        return;
                    }
                    
                    throw new Error(errorData.detail || `HTTP error ${response.status}`);
                }
                
                // Reload deleted certificates
                loadDeletedCertificates(deletedCertificatesState.page);
                
            } catch (error) {
                console.error('Error restoring certificate:', error);
                showDbError(error.message);
            } finally {
                hideElement('dbLoading');
            }
        }
        
        function hideRestoreConflictModal() {
            document.getElementById('restoreConflictModal').classList.remove('active');
        }
        
        function showPermanentDeleteCertModal(id, certNumber, company) {
            deletedCertificatesState.pendingAction = { type: 'permanent', id, certNumber, company };
            document.getElementById('permanentDeleteCertNumber').textContent = certNumber;
            document.getElementById('permanentDeleteCertCompany').textContent = company;
            document.getElementById('permanentDeleteCertModal').classList.add('active');
        }
        
        function hidePermanentDeleteCertModal() {
            document.getElementById('permanentDeleteCertModal').classList.remove('active');
            deletedCertificatesState.pendingAction = null;
        }
        
        async function confirmPermanentDeleteCertificate() {
            const action = deletedCertificatesState.pendingAction;
            if (!action || action.type !== 'permanent') return;
            
            hidePermanentDeleteCertModal();
            showElement('dbLoading');
            
            try {
                const response = await fetch(`${API_BASE}/api/mida/certificates/${action.id}/permanent`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `HTTP error ${response.status}`);
                }
                
                // Reload deleted certificates
                loadDeletedCertificates(deletedCertificatesState.page);
                
            } catch (error) {
                console.error('Error permanently deleting certificate:', error);
                showDbError(error.message);
            } finally {
                hideElement('dbLoading');
            }
        }
        
        // ==========================================
        // Certificate CRUD Operations
        // ==========================================
        
        let addCertItemCounter = 0;
        let editCertItemCounter = 0;
        
        // --- Add Certificate ---
        function showAddCertificateModal() {
            // Reset form
            document.getElementById('addCertNumber').value = '';
            document.getElementById('addCertCompany').value = '';
            document.getElementById('addCertModelNumber').value = '';
            document.getElementById('addCertStartDate').value = '';
            document.getElementById('addCertEndDate').value = '';
            document.getElementById('addCertError').classList.add('hidden');
            
            // Clear and add one empty item row
            const tbody = document.getElementById('addCertItemsBody');
            tbody.innerHTML = '';
            addCertItemCounter = 0;
            addNewItemRowToAdd();
            
            document.getElementById('addCertificateModal').classList.add('active');
        }
        
        function hideAddCertificateModal() {
            document.getElementById('addCertificateModal').classList.remove('active');
        }
        
        function addNewItemRowToAdd() {
            addCertItemCounter++;
            const tbody = document.getElementById('addCertItemsBody');
            const row = document.createElement('tr');
            row.id = `addItemRow_${addCertItemCounter}`;
            row.innerHTML = `
                <td class="line-no-cell">
                    <input type="number" class="item-line-no" value="${addCertItemCounter}" min="1" style="width: 50px; text-align: center;">
                </td>
                <td><input type="text" class="item-hs-code" placeholder="HS Code"></td>
                <td><input type="text" class="item-name" placeholder="Item Name"></td>
                <td><input type="text" class="item-uom" placeholder="UOM" style="width: 70px;"></td>
                <td class="qty-cell"><input type="number" class="item-total-qty" step="0.001" min="0" placeholder="0"></td>
                <td class="qty-cell"><input type="number" class="item-pk-qty" step="0.001" min="0" placeholder="0"></td>
                <td class="qty-cell"><input type="number" class="item-klia-qty" step="0.001" min="0" placeholder="0"></td>
                <td class="qty-cell"><input type="number" class="item-bkh-qty" step="0.001" min="0" placeholder="0"></td>
                <td class="action-cell">
                    <button type="button" class="btn-row-delete" onclick="removeItemRow('addItemRow_${addCertItemCounter}', 'addCertItemsBody')">✕</button>
                </td>
            `;
            tbody.appendChild(row);
        }
        
        function removeItemRow(rowId, tbodyId) {
            const tbody = document.getElementById(tbodyId);
            const row = document.getElementById(rowId);
            if (row && tbody.children.length > 1) {
                row.remove();
            } else if (tbody.children.length === 1) {
                alert('You must have at least one item.');
            }
        }
        
        function collectItemsFromTable(tbodyId) {
            const tbody = document.getElementById(tbodyId);
            const rows = tbody.querySelectorAll('tr');
            const items = [];
            
            rows.forEach(row => {
                const lineNo = parseInt(row.querySelector('.item-line-no')?.value) || 0;
                const hsCode = row.querySelector('.item-hs-code')?.value?.trim() || '';
                const itemName = row.querySelector('.item-name')?.value?.trim() || '';
                const uom = row.querySelector('.item-uom')?.value?.trim() || '';
                const totalQty = parseFloat(row.querySelector('.item-total-qty')?.value) || null;
                const pkQty = parseFloat(row.querySelector('.item-pk-qty')?.value) || null;
                const kliaQty = parseFloat(row.querySelector('.item-klia-qty')?.value) || null;
                const bkhQty = parseFloat(row.querySelector('.item-bkh-qty')?.value) || null;
                
                items.push({
                    line_no: lineNo,
                    hs_code: hsCode,
                    item_name: itemName,
                    uom: uom,
                    approved_quantity: totalQty,
                    port_klang_qty: pkQty,
                    klia_qty: kliaQty,
                    bukit_kayu_hitam_qty: bkhQty
                });
            });
            
            return items;
        }
        
        function validateCertificateForm(certNumber, company, modelNumber, items) {
            const errors = [];
            
            if (!certNumber) errors.push('Certificate Number is required.');
            if (!company) errors.push('Company Name is required.');
            if (!modelNumber) errors.push('Model Number is required.');
            
            if (items.length === 0) {
                errors.push('At least one item is required.');
            } else {
                items.forEach((item, idx) => {
                    if (!item.hs_code) errors.push(`Item ${idx + 1}: HS Code is required.`);
                    if (!item.item_name) errors.push(`Item ${idx + 1}: Item Name is required.`);
                    if (!item.uom) errors.push(`Item ${idx + 1}: UOM is required.`);
                    if (item.line_no <= 0) errors.push(`Item ${idx + 1}: Line number must be positive.`);
                });
                
                // Check for duplicate line numbers
                const lineNos = items.map(i => i.line_no);
                const duplicates = lineNos.filter((v, i, a) => a.indexOf(v) !== i);
                if (duplicates.length > 0) {
                    errors.push(`Duplicate line numbers found: ${[...new Set(duplicates)].join(', ')}`);
                }
            }
            
            return errors;
        }
        
        async function submitAddCertificate() {
            const certNumber = document.getElementById('addCertNumber').value.trim();
            const company = document.getElementById('addCertCompany').value.trim();
            const modelNumber = document.getElementById('addCertModelNumber').value.trim();
            const startDate = document.getElementById('addCertStartDate').value || null;
            const endDate = document.getElementById('addCertEndDate').value || null;
            
            const items = collectItemsFromTable('addCertItemsBody');
            const errors = validateCertificateForm(certNumber, company, modelNumber, items);
            
            if (errors.length > 0) {
                document.getElementById('addCertErrorText').innerHTML = errors.join('<br>');
                document.getElementById('addCertError').classList.remove('hidden');
                return;
            }
            
            document.getElementById('addCertError').classList.add('hidden');
            
            const payload = {
                header: {
                    certificate_number: certNumber,
                    company_name: company,
                    model_number: modelNumber,
                    exemption_start_date: startDate,
                    exemption_end_date: endDate,
                    source_filename: null
                },
                items: items
            };
            
            try {
                showElement('dbLoading');
                hideAddCertificateModal();
                
                const response = await fetch(`${API_BASE}/api/mida/certificates/draft`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `HTTP error ${response.status}`);
                }
                
                const result = await response.json();
                showCrudSuccess('Certificate Added', `Certificate "${certNumber}" has been created successfully.`);
                loadCertificates(1);
                
            } catch (error) {
                console.error('Error adding certificate:', error);
                showDbError('Error adding certificate: ' + error.message);
            } finally {
                hideElement('dbLoading');
            }
        }
        
        // --- Edit Certificate ---
        function showEditCertificateModal() {
            const cert = dbState.selectedCertificate;
            if (!cert) {
                showDbError('No certificate selected.');
                return;
            }
            
            // Check if certificate is expired
            if (cert.status === 'expired') {
                showDbError('Expired certificates cannot be edited.');
                return;
            }
            
            // Populate header fields
            document.getElementById('editCertId').value = cert.id;
            document.getElementById('editCertNumber').value = cert.certificate_number || '';
            document.getElementById('editCertCompany').value = cert.company_name || '';
            document.getElementById('editCertModelNumber').value = cert.model_number || '';
            document.getElementById('editCertStartDate').value = cert.exemption_start_date || '';
            document.getElementById('editCertEndDate').value = cert.exemption_end_date || '';
            document.getElementById('editCertError').classList.add('hidden');
            
            // Populate items
            const tbody = document.getElementById('editCertItemsBody');
            tbody.innerHTML = '';
            editCertItemCounter = 0;
            
            const items = cert.items || [];
            if (items.length === 0) {
                addNewItemRowToEdit();
            } else {
                items.forEach(item => {
                    addItemRowToEdit(item);
                });
            }
            
            document.getElementById('editCertificateModal').classList.add('active');
        }
        
        function hideEditCertificateModal() {
            document.getElementById('editCertificateModal').classList.remove('active');
        }
        
        function addItemRowToEdit(item = null) {
            editCertItemCounter++;
            const tbody = document.getElementById('editCertItemsBody');
            const row = document.createElement('tr');
            row.id = `editItemRow_${editCertItemCounter}`;
            
            const lineNo = item?.line_no || editCertItemCounter;
            const hsCode = item?.hs_code || '';
            const itemName = item?.item_name || '';
            const uom = item?.uom || '';
            const totalQty = item?.approved_quantity ?? '';
            const pkQty = item?.port_klang_qty ?? '';
            const kliaQty = item?.klia_qty ?? '';
            const bkhQty = item?.bukit_kayu_hitam_qty ?? '';
            
            row.innerHTML = `
                <td class="line-no-cell">
                    <input type="number" class="item-line-no" value="${lineNo}" min="1" style="width: 50px; text-align: center;">
                </td>
                <td><input type="text" class="item-hs-code" value="${escapeHtml(hsCode)}" placeholder="HS Code"></td>
                <td><input type="text" class="item-name" value="${escapeHtml(itemName)}" placeholder="Item Name"></td>
                <td><input type="text" class="item-uom" value="${escapeHtml(uom)}" placeholder="UOM" style="width: 70px;"></td>
                <td class="qty-cell"><input type="number" class="item-total-qty" value="${totalQty}" step="0.001" min="0" placeholder="0"></td>
                <td class="qty-cell"><input type="number" class="item-pk-qty" value="${pkQty}" step="0.001" min="0" placeholder="0"></td>
                <td class="qty-cell"><input type="number" class="item-klia-qty" value="${kliaQty}" step="0.001" min="0" placeholder="0"></td>
                <td class="qty-cell"><input type="number" class="item-bkh-qty" value="${bkhQty}" step="0.001" min="0" placeholder="0"></td>
                <td class="action-cell">
                    <button type="button" class="btn-row-delete" onclick="removeItemRow('editItemRow_${editCertItemCounter}', 'editCertItemsBody')">✕</button>
                </td>
            `;
            tbody.appendChild(row);
        }
        
        function addNewItemRowToEdit() {
            addItemRowToEdit(null);
        }
        
        async function submitEditCertificate() {
            const certId = document.getElementById('editCertId').value;
            const certNumber = document.getElementById('editCertNumber').value.trim();
            const company = document.getElementById('editCertCompany').value.trim();
            const modelNumber = document.getElementById('editCertModelNumber').value.trim();
            const startDate = document.getElementById('editCertStartDate').value || null;
            const endDate = document.getElementById('editCertEndDate').value || null;
            
            const items = collectItemsFromTable('editCertItemsBody');
            const errors = validateCertificateForm(certNumber, company, modelNumber, items);
            
            if (errors.length > 0) {
                document.getElementById('editCertErrorText').innerHTML = errors.join('<br>');
                document.getElementById('editCertError').classList.remove('hidden');
                return;
            }
            
            document.getElementById('editCertError').classList.add('hidden');
            
            const payload = {
                header: {
                    certificate_number: certNumber,
                    company_name: company,
                    model_number: modelNumber,
                    exemption_start_date: startDate,
                    exemption_end_date: endDate,
                    source_filename: null
                },
                items: items
            };
            
            try {
                showElement('dbLoading');
                hideEditCertificateModal();
                
                const response = await fetch(`${API_BASE}/api/mida/certificates/${certId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `HTTP error ${response.status}`);
                }
                
                const result = await response.json();
                
                // Update the selected certificate in state
                dbState.selectedCertificate = result;
                
                // Update the info card
                document.getElementById('infoCertNumber').textContent = result.certificate_number || '-';
                document.getElementById('infoCertCompany').textContent = result.company_name || '-';
                document.getElementById('infoCertModelNumber').textContent = result.model_number || '-';
                document.getElementById('infoCertPeriod').textContent = 
                    `${formatDate(result.exemption_start_date)} - ${formatDate(result.exemption_end_date)}`;
                document.getElementById('infoCertStatus').innerHTML = 
                    `<span class="status-badge ${result.status}">${result.status}</span>`;
                
                showCrudSuccess('Certificate Updated', `Certificate "${certNumber}" has been updated successfully.`);
                loadCertificateItems(certId, 1);
                
            } catch (error) {
                console.error('Error updating certificate:', error);
                showDbError('Error updating certificate: ' + error.message);
            } finally {
                hideElement('dbLoading');
            }
        }
        
        // ==========================================
        // Item CRUD Operations (Single Item)
        // ==========================================
        
        // --- Add Single Item ---
        function showAddItemModal() {
            const cert = dbState.selectedCertificate;
            if (!cert) {
                showDbError('No certificate selected.');
                return;
            }
            
            if (cert.status === 'expired') {
                showDbError('Cannot add items to expired certificates.');
                return;
            }
            
            document.getElementById('addItemCertNumber').textContent = cert.certificate_number;
            
            // Calculate next line number
            const maxLineNo = dbState.items?.length > 0 
                ? Math.max(...dbState.items.map(i => i.line_no || 0)) 
                : 0;
            
            document.getElementById('addItemLineNo').value = maxLineNo + 1;
            document.getElementById('addItemHsCode').value = '';
            document.getElementById('addItemName').value = '';
            document.getElementById('addItemUom').value = '';
            document.getElementById('addItemTotalQty').value = '';
            document.getElementById('addItemPortKlang').value = '';
            document.getElementById('addItemKlia').value = '';
            document.getElementById('addItemBkh').value = '';
            document.getElementById('addItemError').classList.add('hidden');
            
            document.getElementById('addItemModal').classList.add('active');
        }
        
        function hideAddItemModal() {
            document.getElementById('addItemModal').classList.remove('active');
        }
        
        async function submitAddItem() {
            const cert = dbState.selectedCertificate;
            if (!cert) return;
            
            const lineNo = parseInt(document.getElementById('addItemLineNo').value) || 0;
            const hsCode = document.getElementById('addItemHsCode').value.trim();
            const itemName = document.getElementById('addItemName').value.trim();
            const uom = document.getElementById('addItemUom').value.trim();
            const totalQty = parseFloat(document.getElementById('addItemTotalQty').value) || null;
            const pkQty = parseFloat(document.getElementById('addItemPortKlang').value) || null;
            const kliaQty = parseFloat(document.getElementById('addItemKlia').value) || null;
            const bkhQty = parseFloat(document.getElementById('addItemBkh').value) || null;
            
            // Validate
            const errors = [];
            if (lineNo <= 0) errors.push('Line number must be positive.');
            if (!hsCode) errors.push('HS Code is required.');
            if (!itemName) errors.push('Item Name is required.');
            if (!uom) errors.push('UOM is required.');
            
            if (errors.length > 0) {
                document.getElementById('addItemErrorText').innerHTML = errors.join('<br>');
                document.getElementById('addItemError').classList.remove('hidden');
                return;
            }
            
            // To add a single item, we need to update the entire certificate
            // First, get the current certificate data
            try {
                showElement('dbLoading');
                hideAddItemModal();
                
                const certResponse = await fetch(`${API_BASE}/api/mida/certificates/${cert.id}`);
                if (!certResponse.ok) throw new Error('Failed to fetch certificate data');
                
                const currentCert = await certResponse.json();
                
                // Add new item to items array
                const newItem = {
                    line_no: lineNo,
                    hs_code: hsCode,
                    item_name: itemName,
                    uom: uom,
                    approved_quantity: totalQty,
                    port_klang_qty: pkQty,
                    klia_qty: kliaQty,
                    bukit_kayu_hitam_qty: bkhQty
                };
                
                const updatedItems = [...(currentCert.items || []).map(i => ({
                    line_no: i.line_no,
                    hs_code: i.hs_code,
                    item_name: i.item_name,
                    uom: i.uom,
                    approved_quantity: i.approved_quantity,
                    port_klang_qty: i.port_klang_qty,
                    klia_qty: i.klia_qty,
                    bukit_kayu_hitam_qty: i.bukit_kayu_hitam_qty
                })), newItem];
                
                const payload = {
                    header: {
                        certificate_number: currentCert.certificate_number,
                        company_name: currentCert.company_name,
                        model_number: currentCert.model_number,
                        exemption_start_date: currentCert.exemption_start_date,
                        exemption_end_date: currentCert.exemption_end_date,
                        source_filename: currentCert.source_filename
                    },
                    items: updatedItems
                };
                
                const response = await fetch(`${API_BASE}/api/mida/certificates/${cert.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `HTTP error ${response.status}`);
                }
                
                const result = await response.json();
                dbState.selectedCertificate = result;
                
                showCrudSuccess('Item Added', `Item "${itemName}" has been added to the certificate.`);
                loadCertificateItems(cert.id, 1);
                
            } catch (error) {
                console.error('Error adding item:', error);
                showDbError('Error adding item: ' + error.message);
            } finally {
                hideElement('dbLoading');
            }
        }
        
        // --- Edit Single Item ---
        function showEditItemModal(item) {
            const cert = dbState.selectedCertificate;
            if (!cert) {
                showDbError('No certificate selected.');
                return;
            }
            
            if (cert.status === 'expired') {
                showDbError('Cannot edit items in expired certificates.');
                return;
            }
            
            document.getElementById('editItemCertNumber').textContent = cert.certificate_number;
            document.getElementById('editItemId').value = item.item_id || item.id;
            document.getElementById('editItemLineNo').value = item.line_no || '';
            document.getElementById('editItemHsCode').value = item.hs_code || item.item_hs_code || '';
            document.getElementById('editItemName').value = item.item_name || '';
            document.getElementById('editItemUom').value = item.uom || item.item_uom || '';
            document.getElementById('editItemTotalQty').value = item.approved_quantity ?? '';
            document.getElementById('editItemPortKlang').value = item.port_klang_qty ?? '';
            document.getElementById('editItemKlia').value = item.klia_qty ?? '';
            document.getElementById('editItemBkh').value = item.bukit_kayu_hitam_qty ?? '';
            document.getElementById('editItemError').classList.add('hidden');
            
            document.getElementById('editItemModal').classList.add('active');
        }
        
        function hideEditItemModal() {
            document.getElementById('editItemModal').classList.remove('active');
        }
        
        async function submitEditItem() {
            const cert = dbState.selectedCertificate;
            if (!cert) return;
            
            const itemId = document.getElementById('editItemId').value;
            const lineNo = parseInt(document.getElementById('editItemLineNo').value) || 0;
            const hsCode = document.getElementById('editItemHsCode').value.trim();
            const itemName = document.getElementById('editItemName').value.trim();
            const uom = document.getElementById('editItemUom').value.trim();
            const totalQty = parseFloat(document.getElementById('editItemTotalQty').value) || null;
            const pkQty = parseFloat(document.getElementById('editItemPortKlang').value) || null;
            const kliaQty = parseFloat(document.getElementById('editItemKlia').value) || null;
            const bkhQty = parseFloat(document.getElementById('editItemBkh').value) || null;
            
            // Validate
            const errors = [];
            if (lineNo <= 0) errors.push('Line number must be positive.');
            if (!hsCode) errors.push('HS Code is required.');
            if (!itemName) errors.push('Item Name is required.');
            if (!uom) errors.push('UOM is required.');
            
            if (errors.length > 0) {
                document.getElementById('editItemErrorText').innerHTML = errors.join('<br>');
                document.getElementById('editItemError').classList.remove('hidden');
                return;
            }
            
            try {
                showElement('dbLoading');
                hideEditItemModal();
                
                const certResponse = await fetch(`${API_BASE}/api/mida/certificates/${cert.id}`);
                if (!certResponse.ok) throw new Error('Failed to fetch certificate data');
                
                const currentCert = await certResponse.json();
                
                // Update the specific item
                const updatedItems = (currentCert.items || []).map(i => {
                    if (i.id === itemId) {
                        return {
                            line_no: lineNo,
                            hs_code: hsCode,
                            item_name: itemName,
                            uom: uom,
                            approved_quantity: totalQty,
                            port_klang_qty: pkQty,
                            klia_qty: kliaQty,
                            bukit_kayu_hitam_qty: bkhQty
                        };
                    }
                    return {
                        line_no: i.line_no,
                        hs_code: i.hs_code,
                        item_name: i.item_name,
                        uom: i.uom,
                        approved_quantity: i.approved_quantity,
                        port_klang_qty: i.port_klang_qty,
                        klia_qty: i.klia_qty,
                        bukit_kayu_hitam_qty: i.bukit_kayu_hitam_qty
                    };
                });
                
                const payload = {
                    header: {
                        certificate_number: currentCert.certificate_number,
                        company_name: currentCert.company_name,
                        model_number: currentCert.model_number,
                        exemption_start_date: currentCert.exemption_start_date,
                        exemption_end_date: currentCert.exemption_end_date,
                        source_filename: currentCert.source_filename
                    },
                    items: updatedItems
                };
                
                const response = await fetch(`${API_BASE}/api/mida/certificates/${cert.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `HTTP error ${response.status}`);
                }
                
                const result = await response.json();
                dbState.selectedCertificate = result;
                
                showCrudSuccess('Item Updated', `Item "${itemName}" has been updated.`);
                loadCertificateItems(cert.id, dbState.itemsPage);
                
            } catch (error) {
                console.error('Error updating item:', error);
                showDbError('Error updating item: ' + error.message);
            } finally {
                hideElement('dbLoading');
            }
        }
        
        // --- Delete Single Item ---
        function showDeleteItemModal(item) {
            const cert = dbState.selectedCertificate;
            if (!cert) {
                showDbError('No certificate selected.');
                return;
            }
            
            if (cert.status === 'expired') {
                showDbError('Cannot delete items from expired certificates.');
                return;
            }
            
            document.getElementById('deleteItemId').value = item.item_id || item.id;
            document.getElementById('deleteItemLineNo').textContent = item.line_no || '-';
            document.getElementById('deleteItemHsCode').textContent = item.hs_code || item.item_hs_code || '-';
            document.getElementById('deleteItemName').textContent = item.item_name || '-';
            
            document.getElementById('deleteItemModal').classList.add('active');
        }
        
        function hideDeleteItemModal() {
            document.getElementById('deleteItemModal').classList.remove('active');
        }
        
        async function confirmDeleteItem() {
            const cert = dbState.selectedCertificate;
            if (!cert) return;
            
            const itemId = document.getElementById('deleteItemId').value;
            
            try {
                showElement('dbLoading');
                hideDeleteItemModal();
                
                const certResponse = await fetch(`${API_BASE}/api/mida/certificates/${cert.id}`);
                if (!certResponse.ok) throw new Error('Failed to fetch certificate data');
                
                const currentCert = await certResponse.json();
                
                // Remove the item
                const updatedItems = (currentCert.items || [])
                    .filter(i => i.id !== itemId)
                    .map(i => ({
                        line_no: i.line_no,
                        hs_code: i.hs_code,
                        item_name: i.item_name,
                        uom: i.uom,
                        approved_quantity: i.approved_quantity,
                        port_klang_qty: i.port_klang_qty,
                        klia_qty: i.klia_qty,
                        bukit_kayu_hitam_qty: i.bukit_kayu_hitam_qty
                    }));
                
                if (updatedItems.length === 0) {
                    showDbError('Cannot delete the last item. A certificate must have at least one item.');
                    hideElement('dbLoading');
                    return;
                }
                
                const payload = {
                    header: {
                        certificate_number: currentCert.certificate_number,
                        company_name: currentCert.company_name,
                        model_number: currentCert.model_number,
                        exemption_start_date: currentCert.exemption_start_date,
                        exemption_end_date: currentCert.exemption_end_date,
                        source_filename: currentCert.source_filename
                    },
                    items: updatedItems
                };
                
                const response = await fetch(`${API_BASE}/api/mida/certificates/${cert.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `HTTP error ${response.status}`);
                }
                
                const result = await response.json();
                dbState.selectedCertificate = result;
                
                showCrudSuccess('Item Deleted', 'The item has been deleted from the certificate.');
                loadCertificateItems(cert.id, dbState.itemsPage);
                
            } catch (error) {
                console.error('Error deleting item:', error);
                showDbError('Error deleting item: ' + error.message);
            } finally {
                hideElement('dbLoading');
            }
        }
        
        // --- Success Modal ---
        function showCrudSuccess(title, message) {
            document.getElementById('crudSuccessTitle').textContent = '✅ ' + title;
            document.getElementById('crudSuccessMessage').textContent = message;
            document.getElementById('crudSuccessModal').classList.add('active');
        }
        
        function hideCrudSuccessModal() {
            document.getElementById('crudSuccessModal').classList.remove('active');
        }
    </script>
    
    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal-overlay">
        <div class="modal-content">
            <h3>💾 Save to Database</h3>
            <p>Are you sure you want to save this certificate data to the database?</p>
            <p>Please confirm that all the information is correct before proceeding.</p>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="hideConfirmModal()">Cancel</button>
                <button class="btn-database" onclick="saveToDatabaseConfirmed()">Yes, Save to Database</button>
            </div>
        </div>
    </div>
    
    <!-- Missing Data Error Modal (Blocks Save) -->
    <div id="missingDataErrorModal" class="modal-overlay">
        <div class="modal-content">
            <h3>❌ Cannot Save - Required Data Missing</h3>
            <p style="color: #c0392b; font-weight: 600;">There are required fields that are missing.</p>
            <p>You cannot save to the database until all required fields are filled in:</p>
            <ul style="color: #721c24; margin: 0.5rem 0 1rem 1.5rem;">
                <li>Certificate Number</li>
                <li>Company Name</li>
                <li>Exemption Start Date</li>
                <li>Exemption End Date</li>
                <li>HS Code (for each item)</li>
                <li>Item Name (for each item)</li>
                <li>Approved Quantity (for each item)</li>
                <li>UOM (for each item)</li>
            </ul>
            <p>Please review and complete the missing fields (highlighted in red) before trying again.</p>
            <div class="modal-buttons">
                <button class="btn-edit" onclick="hideMissingDataModal()">OK, I'll Fix It</button>
            </div>
        </div>
    </div>
    
    <!-- Discrepancy Confirmation Modal -->
    <div id="discrepancyConfirmModal" class="modal-overlay">
        <div class="modal-content">
            <h3>⚠️ Quantity Discrepancies Detected</h3>
            <p style="color: #e74c3c; font-weight: 600;">There are unchecked quantity discrepancies in the certificate data.</p>
            <p>The Approved Quantity does not match the sum of station quantities (Port Klang + KLIA + Bukit Kayu Hitam) for one or more rows.</p>
            <p>Are you sure you want to proceed with saving to the database anyway?</p>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="hideDiscrepancyModal()">Cancel</button>
                <button class="btn-cancel" onclick="proceedWithDatabaseSave()">Yes, Save Anyway</button>
            </div>
        </div>
    </div>
    
    <!-- Database Save Success Modal -->
    <div id="saveSuccessModal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="saveSuccessTitle">✅ Certificate Saved</h3>
            <p id="saveSuccessMessage">The certificate has been saved to the database.</p>
            <div id="saveSuccessDetails"></div>
            <div class="modal-buttons">
                <button class="btn-database" onclick="hideSaveSuccessModal()">OK</button>
            </div>
        </div>
    </div>
    
    <!-- Database Save Error Modal -->
    <div id="saveErrorModal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="saveErrorTitle">❌ Save Failed</h3>
            <p id="saveErrorMessage">An error occurred while saving to the database.</p>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="hideSaveErrorModal()">OK</button>
            </div>
        </div>
    </div>
    
    <!-- Duplicate Certificate Warning Modal -->
    <div id="duplicateCertModal" class="modal-overlay">
        <div class="modal-content">
            <h3>⚠️ Certificate Already Exists</h3>
            <p style="color: #e74c3c; font-weight: 600;">A certificate with this number already exists in the database.</p>
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                <p style="margin: 0.25rem 0;"><strong>Certificate Number:</strong> <span id="duplicateCertNumber"></span></p>
                <p style="margin: 0.25rem 0;"><strong>Status:</strong> <span id="duplicateCertStatus"></span></p>
                <p style="margin: 0.25rem 0;"><strong>Company:</strong> <span id="duplicateCertCompany"></span></p>
            </div>
            <p>Please change the certificate number before saving, or view the existing certificate in the Database View tab.</p>
            <div class="modal-buttons">
                <button class="btn-edit" onclick="hideDuplicateCertModal()">OK, I'll Change It</button>
            </div>
        </div>
    </div>
    
    <!-- Delete Certificate Confirmation Modal -->
    <div id="deleteCertModal" class="modal-overlay">
        <div class="modal-content">
            <h3>🗑️ Delete Certificate</h3>
            <p>Are you sure you want to delete this certificate?</p>
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                <p style="margin: 0.25rem 0;"><strong>Certificate Number:</strong> <span id="deleteCertNumber"></span></p>
                <p style="margin: 0.25rem 0;"><strong>Company:</strong> <span id="deleteCertCompany"></span></p>
            </div>
            <p style="color: #7f8c8d; font-size: 0.9rem;">The certificate will be moved to Deleted Certificates and can be restored later.</p>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="hideDeleteCertModal()">Cancel</button>
                <button class="btn-action btn-action-delete" onclick="confirmDeleteCertificate()">🗑️ Delete</button>
            </div>
        </div>
    </div>
    
    <!-- Restore Certificate Confirmation Modal -->
    <div id="restoreCertModal" class="modal-overlay">
        <div class="modal-content">
            <h3>♻️ Restore Certificate</h3>
            <p>Are you sure you want to restore this certificate?</p>
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                <p style="margin: 0.25rem 0;"><strong>Certificate Number:</strong> <span id="restoreCertNumber"></span></p>
                <p style="margin: 0.25rem 0;"><strong>Company:</strong> <span id="restoreCertCompany"></span></p>
            </div>
            <p style="color: #7f8c8d; font-size: 0.9rem;">The certificate will be restored to Active Certificates.</p>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="hideRestoreCertModal()">Cancel</button>
                <button class="btn-action btn-action-restore" onclick="confirmRestoreCertificate()">♻️ Restore</button>
            </div>
        </div>
    </div>
    
    <!-- Permanent Delete Certificate Confirmation Modal -->
    <div id="permanentDeleteCertModal" class="modal-overlay">
        <div class="modal-content">
            <h3>⚠️ Permanently Delete Certificate</h3>
            <p style="color: #e74c3c; font-weight: 600;">This action cannot be undone!</p>
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                <p style="margin: 0.25rem 0;"><strong>Certificate Number:</strong> <span id="permanentDeleteCertNumber"></span></p>
                <p style="margin: 0.25rem 0;"><strong>Company:</strong> <span id="permanentDeleteCertCompany"></span></p>
            </div>
            <p>All certificate data including items and import records will be permanently deleted.</p>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="hidePermanentDeleteCertModal()">Cancel</button>
                <button class="btn-action btn-action-permanent" onclick="confirmPermanentDeleteCertificate()">🗑️ Permanently Delete</button>
            </div>
        </div>
    </div>
    
    <!-- Restore Conflict Error Modal -->
    <div id="restoreConflictModal" class="modal-overlay">
        <div class="modal-content">
            <h3>⚠️ Cannot Restore Certificate</h3>
            <p style="color: #e74c3c; font-weight: 600;">The certificate number is already in use.</p>
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                <p style="margin: 0.25rem 0;"><strong>Certificate Number:</strong> <span id="conflictCertNumber"></span></p>
            </div>
            <p>Another active certificate already uses this certificate number. You must delete or rename the active certificate before restoring this one.</p>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="hideRestoreConflictModal()">OK</button>
            </div>
        </div>
    </div>
    
    <!-- Add Certificate Modal -->
    <div id="addCertificateModal" class="modal-overlay">
        <div class="modal-content large">
            <h3>➕ Add New Certificate</h3>
            
            <!-- Header Section -->
            <div class="form-section">
                <div class="form-section-title">Certificate Header</div>
                <div class="form-grid">
                    <div class="form-field">
                        <label>Certificate Number <span style="color: #e74c3c;">*</span></label>
                        <input type="text" id="addCertNumber" placeholder="e.g., MIDA/2024/12345">
                    </div>
                    <div class="form-field">
                        <label>Company Name <span style="color: #e74c3c;">*</span></label>
                        <input type="text" id="addCertCompany" placeholder="Company name">
                    </div>
                    <div class="form-field">
                        <label>Model Number <span style="color: #e74c3c;">*</span></label>
                        <input type="text" id="addCertModelNumber" placeholder="e.g., MODEL-001">
                    </div>
                </div>
                <div class="form-grid" style="margin-top: 0.5rem;">
                    <div class="form-field">
                        <label>Start Date</label>
                        <input type="date" id="addCertStartDate">
                    </div>
                    <div class="form-field">
                        <label>End Date</label>
                        <input type="date" id="addCertEndDate">
                    </div>
                </div>
            </div>
            
            <!-- Items Section -->
            <div class="form-section">
                <div class="form-section-title">Certificate Items</div>
                <div class="items-form-container">
                    <table class="items-form-table">
                        <thead>
                            <tr>
                                <th class="line-no-cell">Line</th>
                                <th>HS Code *</th>
                                <th>Item Name *</th>
                                <th>UOM *</th>
                                <th class="qty-cell">Total Qty</th>
                                <th class="qty-cell">Port Klang</th>
                                <th class="qty-cell">KLIA</th>
                                <th class="qty-cell">BKH</th>
                                <th class="action-cell"></th>
                            </tr>
                        </thead>
                        <tbody id="addCertItemsBody">
                        </tbody>
                    </table>
                    <button type="button" class="btn-add-row" onclick="addNewItemRowToAdd()">➕ Add Item Row</button>
                </div>
            </div>
            
            <div id="addCertError" class="error-message hidden" style="margin-top: 1rem;">
                <p id="addCertErrorText"></p>
            </div>
            
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="hideAddCertificateModal()">Cancel</button>
                <button class="btn-add" onclick="submitAddCertificate()">💾 Save Certificate</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Certificate Modal -->
    <div id="editCertificateModal" class="modal-overlay">
        <div class="modal-content large">
            <h3>✏️ Edit Certificate</h3>
            <input type="hidden" id="editCertId">
            
            <!-- Header Section -->
            <div class="form-section">
                <div class="form-section-title">Certificate Header</div>
                <div class="form-grid">
                    <div class="form-field">
                        <label>Certificate Number <span style="color: #e74c3c;">*</span></label>
                        <input type="text" id="editCertNumber" placeholder="e.g., MIDA/2024/12345">
                    </div>
                    <div class="form-field">
                        <label>Company Name <span style="color: #e74c3c;">*</span></label>
                        <input type="text" id="editCertCompany" placeholder="Company name">
                    </div>
                    <div class="form-field">
                        <label>Model Number <span style="color: #e74c3c;">*</span></label>
                        <input type="text" id="editCertModelNumber" placeholder="e.g., MODEL-001">
                    </div>
                </div>
                <div class="form-grid" style="margin-top: 0.5rem;">
                    <div class="form-field">
                        <label>Start Date</label>
                        <input type="date" id="editCertStartDate">
                    </div>
                    <div class="form-field">
                        <label>End Date</label>
                        <input type="date" id="editCertEndDate">
                    </div>
                </div>
            </div>
            
            <!-- Items Section -->
            <div class="form-section">
                <div class="form-section-title">Certificate Items</div>
                <div class="items-form-container">
                    <table class="items-form-table">
                        <thead>
                            <tr>
                                <th class="line-no-cell">Line</th>
                                <th>HS Code *</th>
                                <th>Item Name *</th>
                                <th>UOM *</th>
                                <th class="qty-cell">Total Qty</th>
                                <th class="qty-cell">Port Klang</th>
                                <th class="qty-cell">KLIA</th>
                                <th class="qty-cell">BKH</th>
                                <th class="action-cell"></th>
                            </tr>
                        </thead>
                        <tbody id="editCertItemsBody">
                        </tbody>
                    </table>
                    <button type="button" class="btn-add-row" onclick="addNewItemRowToEdit()">➕ Add Item Row</button>
                </div>
            </div>
            
            <div id="editCertError" class="error-message hidden" style="margin-top: 1rem;">
                <p id="editCertErrorText"></p>
            </div>
            
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="hideEditCertificateModal()">Cancel</button>
                <button class="btn-action btn-action-edit" onclick="submitEditCertificate()">💾 Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- Add Item Modal (Single Item) -->
    <div id="addItemModal" class="modal-overlay">
        <div class="modal-content">
            <h3>➕ Add New Item</h3>
            <p style="color: #7f8c8d; margin-bottom: 1rem;">Adding item to certificate: <strong id="addItemCertNumber"></strong></p>
            
            <div class="form-grid">
                <div class="form-field">
                    <label>Line Number <span style="color: #e74c3c;">*</span></label>
                    <input type="number" id="addItemLineNo" min="1" placeholder="1">
                </div>
                <div class="form-field">
                    <label>HS Code <span style="color: #e74c3c;">*</span></label>
                    <input type="text" id="addItemHsCode" placeholder="e.g., 8471.30.10">
                </div>
            </div>
            <div class="form-field">
                <label>Item Name <span style="color: #e74c3c;">*</span></label>
                <input type="text" id="addItemName" placeholder="Item description">
            </div>
            <div class="form-grid form-grid-4">
                <div class="form-field">
                    <label>UOM <span style="color: #e74c3c;">*</span></label>
                    <input type="text" id="addItemUom" placeholder="e.g., UNIT">
                </div>
                <div class="form-field">
                    <label>Total Quantity</label>
                    <input type="number" id="addItemTotalQty" step="0.001" min="0" placeholder="0">
                </div>
            </div>
            <div class="form-grid form-grid-3">
                <div class="form-field">
                    <label>Port Klang Qty</label>
                    <input type="number" id="addItemPortKlang" step="0.001" min="0" placeholder="0">
                </div>
                <div class="form-field">
                    <label>KLIA Qty</label>
                    <input type="number" id="addItemKlia" step="0.001" min="0" placeholder="0">
                </div>
                <div class="form-field">
                    <label>Bukit Kayu Hitam Qty</label>
                    <input type="number" id="addItemBkh" step="0.001" min="0" placeholder="0">
                </div>
            </div>
            
            <div id="addItemError" class="error-message hidden" style="margin-top: 1rem;">
                <p id="addItemErrorText"></p>
            </div>
            
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="hideAddItemModal()">Cancel</button>
                <button class="btn-add" onclick="submitAddItem()">💾 Add Item</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Item Modal -->
    <div id="editItemModal" class="modal-overlay">
        <div class="modal-content">
            <h3>✏️ Edit Item</h3>
            <input type="hidden" id="editItemId">
            <p style="color: #7f8c8d; margin-bottom: 1rem;">Editing item in certificate: <strong id="editItemCertNumber"></strong></p>
            
            <div class="form-grid">
                <div class="form-field">
                    <label>Line Number <span style="color: #e74c3c;">*</span></label>
                    <input type="number" id="editItemLineNo" min="1" placeholder="1">
                </div>
                <div class="form-field">
                    <label>HS Code <span style="color: #e74c3c;">*</span></label>
                    <input type="text" id="editItemHsCode" placeholder="e.g., 8471.30.10">
                </div>
            </div>
            <div class="form-field">
                <label>Item Name <span style="color: #e74c3c;">*</span></label>
                <input type="text" id="editItemName" placeholder="Item description">
            </div>
            <div class="form-grid form-grid-4">
                <div class="form-field">
                    <label>UOM <span style="color: #e74c3c;">*</span></label>
                    <input type="text" id="editItemUom" placeholder="e.g., UNIT">
                </div>
                <div class="form-field">
                    <label>Total Quantity</label>
                    <input type="number" id="editItemTotalQty" step="0.001" min="0" placeholder="0">
                </div>
            </div>
            <div class="form-grid form-grid-3">
                <div class="form-field">
                    <label>Port Klang Qty</label>
                    <input type="number" id="editItemPortKlang" step="0.001" min="0" placeholder="0">
                </div>
                <div class="form-field">
                    <label>KLIA Qty</label>
                    <input type="number" id="editItemKlia" step="0.001" min="0" placeholder="0">
                </div>
                <div class="form-field">
                    <label>Bukit Kayu Hitam Qty</label>
                    <input type="number" id="editItemBkh" step="0.001" min="0" placeholder="0">
                </div>
            </div>
            
            <div id="editItemError" class="error-message hidden" style="margin-top: 1rem;">
                <p id="editItemErrorText"></p>
            </div>
            
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="hideEditItemModal()">Cancel</button>
                <button class="btn-action btn-action-edit" onclick="submitEditItem()">💾 Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- Delete Item Confirmation Modal -->
    <div id="deleteItemModal" class="modal-overlay">
        <div class="modal-content">
            <h3>🗑️ Delete Item</h3>
            <p>Are you sure you want to delete this item?</p>
            <div class="item-delete-info">
                <p><strong>Line:</strong> <span id="deleteItemLineNo"></span></p>
                <p><strong>HS Code:</strong> <span id="deleteItemHsCode"></span></p>
                <p><strong>Item Name:</strong> <span id="deleteItemName"></span></p>
            </div>
            <p style="color: #e74c3c; font-weight: 600;">⚠️ This will also delete all import records for this item!</p>
            <input type="hidden" id="deleteItemId">
            
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="hideDeleteItemModal()">Cancel</button>
                <button class="btn-action btn-action-delete" onclick="confirmDeleteItem()">🗑️ Delete Item</button>
            </div>
        </div>
    </div>
    
    <!-- Success Toast/Modal -->
    <div id="crudSuccessModal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="crudSuccessTitle">✅ Success</h3>
            <p id="crudSuccessMessage"></p>
            <div class="modal-buttons">
                <button class="btn-add" onclick="hideCrudSuccessModal()">OK</button>
            </div>
        </div>
    </div>
</body>
</html>
