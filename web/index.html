<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIDA Certificate OCR & Converter</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            max-width: 1000px; 
            margin: 2rem auto; 
            padding: 0 1rem;
            background: #f5f5f5;
            color: #333;
        }
        h1 { color: #2c3e50; margin-bottom: 0.5rem; }
        h2 { color: #34495e; border-bottom: 2px solid #3498db; padding-bottom: 0.5rem; margin-top: 2rem; }
        h3 { color: #2c3e50; margin-top: 1.5rem; }
        
        .container { 
            background: white;
            border: 1px solid #ddd; 
            padding: 2rem; 
            border-radius: 8px; 
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #555;
        }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
        }
        .form-group input[type="file"] {
            padding: 0.5rem 0;
        }
        .form-group small {
            display: block;
            margin-top: 0.25rem;
            color: #888;
            font-style: italic;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        
        .row {
            display: flex;
            gap: 1rem;
        }
        .row .form-group {
            flex: 1;
        }
        
        pre { 
            background: #f8f9fa; 
            padding: 1rem; 
            overflow-x: auto; 
            border-radius: 4px;
            border: 1px solid #e9ecef;
            font-size: 0.85rem;
        }
        
        button { 
            padding: 0.75rem 1.5rem; 
            cursor: pointer;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: 600;
            transition: background 0.2s;
        }
        button:hover { background: #2980b9; }
        button:disabled { background: #bdc3c7; cursor: not-allowed; }
        
        .btn-secondary {
            background: #95a5a6;
        }
        .btn-secondary:hover { background: #7f8c8d; }
        
        /* Results section */
        .results-section { margin-top: 2rem; }
        
        .summary-stats {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .stat-card {
            flex: 1;
            background: #ecf0f1;
            padding: 1rem;
            border-radius: 4px;
            text-align: center;
        }
        .stat-card .number {
            font-size: 2rem;
            font-weight: bold;
            color: #2c3e50;
        }
        .stat-card .label {
            color: #7f8c8d;
            font-size: 0.85rem;
        }
        .stat-card.matched { background: #d5f4e6; }
        .stat-card.matched .number { color: #27ae60; }
        .stat-card.unmatched { background: #fdecea; }
        .stat-card.unmatched .number { color: #e74c3c; }
        
        /* Table styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 0.9rem;
        }
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #3498db;
            color: white;
            font-weight: 600;
        }
        tr:hover { background: #f8f9fa; }
        tr:nth-child(even) { background: #fafafa; }
        tr:nth-child(even):hover { background: #f0f0f0; }
        
        .match-score {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.85rem;
        }
        .match-score.high { background: #d5f4e6; color: #27ae60; }
        .match-score.medium { background: #fef3cd; color: #856404; }
        .match-score.low { background: #fdecea; color: #e74c3c; }
        
        /* Warnings section */
        .warnings-section {
            margin-top: 1.5rem;
        }
        .warning-item {
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
            border-left: 4px solid;
        }
        .warning-item.error {
            background: #fdecea;
            border-color: #e74c3c;
        }
        .warning-item.warning {
            background: #fef3cd;
            border-color: #f39c12;
        }
        .warning-item.info {
            background: #d6eaf8;
            border-color: #3498db;
        }
        .warning-item .invoice-item {
            font-weight: 600;
            color: #2c3e50;
        }
        .warning-item .reason {
            margin-top: 0.25rem;
            color: #555;
        }
        .warning-item .severity-badge {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            border-radius: 3px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
            margin-left: 0.5rem;
        }
        .severity-badge.error { background: #e74c3c; color: white; }
        .severity-badge.warning { background: #f39c12; color: white; }
        .severity-badge.info { background: #3498db; color: white; }
        
        /* Error message */
        .error-message {
            background: #fdecea;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
        }
        .error-message h4 {
            margin: 0 0 0.5rem 0;
            color: #721c24;
        }
        
        /* Loading state */
        .loading {
            text-align: center;
            padding: 2rem;
            color: #7f8c8d;
        }
        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #3498db;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 0.5rem;
            vertical-align: middle;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 0;
            margin-bottom: 0;
        }
        .tab {
            padding: 0.75rem 1.5rem;
            background: #ecf0f1;
            border: 1px solid #ddd;
            border-bottom: none;
            cursor: pointer;
            font-weight: 600;
            color: #7f8c8d;
            border-radius: 4px 4px 0 0;
        }
        .tab.active {
            background: white;
            color: #3498db;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        /* Hidden */
        .hidden { display: none; }
        
        /* View toggle buttons */
        .view-toggle {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .toggle-btn {
            padding: 0.5rem 1rem;
            background: #ecf0f1;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .toggle-btn:hover {
            background: #d5dbdb;
        }
        .toggle-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        /* Form flag badge */
        .form-flag-badge {
            display: inline-block;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        .form-flag-badge.form-d {
            background: #fdecea;
            color: #e74c3c;
        }
        .form-flag-badge.empty {
            background: #d5f4e6;
            color: #27ae60;
        }
        
        /* Total row styling */
        tr.total-row {
            background: #f8f9fa !important;
            font-weight: bold;
            border-top: 2px solid #3498db;
        }
        tr.total-row:hover {
            background: #f0f0f0 !important;
        }
        
        /* Certificate Parser Styles */
        .cert-header {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        .cert-header-field {
            display: flex;
            flex-direction: column;
        }
        .cert-header-field label {
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 0.25rem;
            font-weight: 600;
        }
        .cert-header-field .value {
            font-size: 1rem;
            color: #2c3e50;
            padding: 0.5rem;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            min-height: 38px;
        }
        .cert-header-field .value.editable {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        .cert-header-field input {
            font-size: 1rem;
            padding: 0.5rem;
            border: 1px solid #3498db;
            border-radius: 4px;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        /* Editable table cells */
        .editable-cell {
            transition: all 0.2s;
        }
        .editable-cell.editing {
            background: #fff3cd !important;
            border: 2px solid #3498db !important;
            padding: 0.5rem;
        }
        td[contenteditable="true"] {
            background: #fff3cd;
            border: 2px solid #3498db;
            outline: none;
        }
        td[contenteditable="true"]:focus {
            background: #fffef0;
        }
        
        /* Action buttons group */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        .btn-edit {
            background: #f39c12;
        }
        .btn-edit:hover { background: #e67e22; }
        .btn-save {
            background: #27ae60;
        }
        .btn-save:hover { background: #219a52; }
        .btn-cancel {
            background: #e74c3c;
        }
        .btn-cancel:hover { background: #c0392b; }
        .btn-database {
            background: #27ae60;
        }
        .btn-database:hover { background: #1e8449; }
        
        /* Confirmation Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        .modal-content h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        .modal-content p {
            color: #555;
            line-height: 1.6;
        }
        .modal-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }
        
        /* Parser results container */
        .parser-results {
            margin-top: 1.5rem;
        }
        
        /* Items table for parser */
        .items-table-container {
            overflow-x: auto;
            margin-top: 1rem;
        }
        .items-table th {
            white-space: nowrap;
        }
        .items-table td {
            min-width: 80px;
        }
        .items-table td:nth-child(3) {
            min-width: 200px;
        }
        
        /* Success message */
        .success-message {
            background: #d5f4e6;
            border: 1px solid #27ae60;
            color: #155724;
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
        }
        .success-message h4 {
            margin: 0 0 0.5rem 0;
            color: #155724;
        }
        
        /* Warnings badge */
        .warnings-badge {
            background: #fef3cd;
            color: #856404;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.85rem;
            margin-left: 0.5rem;
        }
        
        /* Discrepancy highlighting */
        tr.discrepancy-row {
            background: #fdecea !important;
        }
        tr.discrepancy-row:hover {
            background: #f5c6cb !important;
        }
        tr.discrepancy-row td {
            border-color: #e74c3c;
        }
        /* Ensure discrepancy rows can still be edited */
        tr.discrepancy-row td[contenteditable="true"] {
            background: #fff3cd !important;
            border: 2px solid #3498db !important;
        }
        tr.discrepancy-row td.editing {
            background: #fff3cd !important;
            border: 2px solid #3498db !important;
        }
        
        /* Missing data highlighting (more severe - blocks save) */
        tr.missing-data-row {
            background: #f8d7da !important;
        }
        tr.missing-data-row:hover {
            background: #f1b0b7 !important;
        }
        tr.missing-data-row td.missing-field {
            background: #e74c3c !important;
            color: white;
            border-color: #c0392b;
        }
        tr.missing-data-row td[contenteditable="true"].missing-field {
            background: #fff3cd !important;
            color: #333;
            border: 2px solid #e74c3c !important;
        }
        
        /* Missing header field highlighting */
        .cert-header-field .value.missing-field {
            background: #f8d7da !important;
            border: 2px solid #e74c3c !important;
            color: #721c24;
        }
        .cert-header-field .value.missing-field.editable {
            background: #fff3cd !important;
            border: 2px solid #e74c3c !important;
            color: #333;
        }
        
        /* Missing data warning banner (error level) */
        .missing-data-warning {
            background: #f8d7da;
            border: 1px solid #c0392b;
            border-left: 4px solid #c0392b;
            color: #721c24;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        .missing-data-warning h4 {
            margin: 0 0 0.5rem 0;
            color: #721c24;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .missing-data-warning ul {
            margin: 0.5rem 0 0 1.5rem;
            padding: 0;
        }
        .missing-data-warning li {
            margin-bottom: 0.25rem;
        }
        
        /* Discrepancy warning banner */
        .discrepancy-warning {
            background: #fdecea;
            border: 1px solid #e74c3c;
            border-left: 4px solid #e74c3c;
            color: #721c24;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        .discrepancy-warning h4 {
            margin: 0 0 0.5rem 0;
            color: #721c24;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .discrepancy-warning ul {
            margin: 0.5rem 0 0 1.5rem;
            padding: 0;
        }
        .discrepancy-warning li {
            margin-bottom: 0.25rem;
        }
        
        /* ==========================================
           Database View Tab Styles
           ========================================== */
        
        /* Breadcrumb navigation */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        .breadcrumb-item {
            color: #3498db;
            cursor: pointer;
            text-decoration: none;
        }
        .breadcrumb-item:hover {
            text-decoration: underline;
        }
        .breadcrumb-item.active {
            color: #2c3e50;
            cursor: default;
            font-weight: 600;
        }
        .breadcrumb-separator {
            color: #7f8c8d;
        }
        
        /* Clickable table rows */
        .clickable-row {
            cursor: pointer;
            transition: background 0.15s;
        }
        .clickable-row:hover {
            background: #e8f4fc !important;
        }
        .clickable-row.selected {
            background: #d4edfc !important;
            border-left: 3px solid #3498db;
        }
        
        /* Quantity status colors */
        .qty-status-normal {
            color: #27ae60;
            font-weight: 600;
        }
        .qty-status-warning {
            color: #f39c12;
            font-weight: 600;
        }
        .qty-status-depleted {
            color: #e74c3c;
            font-weight: 600;
        }
        .qty-status-overdrawn {
            color: #c0392b;
            font-weight: bold;
            background: #fdecea;
        }
        
        /* Status badge */
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: capitalize;
        }
        .status-badge.active {
            background: #d5f4e6;
            color: #27ae60;
        }
        .status-badge.expired {
            background: #fdecea;
            color: #e74c3c;
        }
        /* Legacy support for any remaining draft/confirmed badges */
        .status-badge.draft {
            background: #fef3cd;
            color: #856404;
        }
        .status-badge.confirmed {
            background: #d5f4e6;
            color: #27ae60;
        }
        
        /* Quantity toggle */
        .qty-toggle-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            background: #ecf0f1;
            border-radius: 4px;
        }
        .qty-toggle-label {
            font-weight: 600;
            color: #2c3e50;
        }
        .qty-toggle-switch {
            display: flex;
            background: white;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #bdc3c7;
        }
        .qty-toggle-btn {
            padding: 0.5rem 1rem;
            background: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.2s;
            color: #7f8c8d;
        }
        .qty-toggle-btn:hover {
            background: #f8f9fa;
        }
        .qty-toggle-btn.active {
            background: #3498db;
            color: white;
        }
        .qty-toggle-btn:first-child {
            border-right: 1px solid #bdc3c7;
        }
        
        /* Port filter buttons */
        .port-filter-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .port-filter-btn {
            padding: 0.5rem 1rem;
            background: #ecf0f1;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .port-filter-btn:hover {
            background: #d5dbdb;
        }
        .port-filter-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #7f8c8d;
        }
        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        .empty-state-text {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        .empty-state-subtext {
            font-size: 0.9rem;
            color: #95a5a6;
        }
        
        /* Pagination */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            padding: 0.75rem 0;
            border-top: 1px solid #e9ecef;
        }
        .pagination-left {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        .pagination-info {
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        .rows-per-page {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: #7f8c8d;
        }
        .rows-per-page select {
            padding: 0.3rem 0.5rem;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 0.85rem;
            cursor: pointer;
        }
        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .pagination-btn {
            padding: 0.4rem 0.75rem;
            background: #ecf0f1;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.15s;
        }
        .pagination-btn:hover:not(:disabled) {
            background: #d5dbdb;
        }
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pagination-page {
            padding: 0.4rem 0.6rem;
            min-width: 35px;
            text-align: center;
            background: white;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        .pagination-page.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        /* Back button */
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.5rem 1rem;
            background: #ecf0f1;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.15s;
        }
        .back-btn:hover {
            background: #d5dbdb;
        }
        
        /* Info card */
        .info-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .info-card-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        .info-card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
        }
        .info-card-item {
            display: flex;
            flex-direction: column;
        }
        .info-card-label {
            font-size: 0.8rem;
            color: #7f8c8d;
        }
        .info-card-value {
            font-weight: 600;
            color: #2c3e50;
        }
        
        /* Table number formatting */
        .number-cell {
            font-family: 'Consolas', 'Monaco', monospace;
            text-align: right;
        }
    </style>
</head>
<body>
    <h1>üè≠ MIDA Certificate System</h1>
    
    <!-- Tabs -->
    <div class="tabs">
        <div class="tab active" onclick="switchTab('converter')">Invoice Converter</div>
        <div class="tab" onclick="switchTab('parser')">Certificate Parser</div>
        <div class="tab" onclick="switchTab('database')">Database View</div>
    </div>
    
    <!-- Converter Tab -->
    <div id="converter-tab" class="tab-content active">
        <div class="container">
            <h2>üìÑ Invoice to MIDA Converter</h2>
            <p>Upload an invoice file (Excel .xls or .xlsx) and optionally match against a MIDA certificate.</p>
            
            <div class="form-group">
                <label for="invoiceFile">Invoice File</label>
                <input type="file" id="invoiceFile" accept=".xls,.xlsx">
            </div>
            
            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="midaMode" onchange="toggleMidaMode()">
                    <label for="midaMode" style="display: inline; margin-bottom: 0;">Enable MIDA Matching Mode</label>
                </div>
            </div>
            
            <div id="midaOptions" class="hidden">
                <div class="form-group">
                    <label for="midaCertNumber">MIDA Certificate Number</label>
                    <select id="midaCertNumber" style="width: 100%; padding: 0.6rem; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 1rem;">
                        <option value="">-- Select Certificate --</option>
                    </select>
                    <small id="certLoadingText" class="hidden">‚è≥ Loading certificates...</small>
                </div>
            </div>
            
            <button onclick="convertInvoice()" id="convertBtn">Convert Invoice</button>
            
            <!-- Import Metadata Fields (always visible) -->
            <div id="importMetadataSection" style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px;">
                <h4 style="margin: 0 0 0.75rem 0; color: #2c3e50;">üìã Import Details</h4>
                <div class="row" style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1; min-width: 150px;">
                        <label for="countrySelect" style="font-weight: 600; color: #555;">Country</label>
                        <select id="countrySelect" style="width: 100%; padding: 0.5rem; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 0.9rem;">
                            <option value="AF">Afghanistan (AF)</option>
                            <option value="AL">Albania (AL)</option>
                            <option value="DZ">Algeria (DZ)</option>
                            <option value="AR">Argentina (AR)</option>
                            <option value="AU">Australia (AU)</option>
                            <option value="AT">Austria (AT)</option>
                            <option value="BD">Bangladesh (BD)</option>
                            <option value="BE">Belgium (BE)</option>
                            <option value="BR">Brazil (BR)</option>
                            <option value="BN">Brunei Darussalam (BN)</option>
                            <option value="KH">Cambodia (KH)</option>
                            <option value="CA">Canada (CA)</option>
                            <option value="CN">China (CN)</option>
                            <option value="CO">Colombia (CO)</option>
                            <option value="CZ">Czechia (CZ)</option>
                            <option value="DK">Denmark (DK)</option>
                            <option value="EG">Egypt (EG)</option>
                            <option value="FI">Finland (FI)</option>
                            <option value="FR">France (FR)</option>
                            <option value="DE">Germany (DE)</option>
                            <option value="GR">Greece (GR)</option>
                            <option value="HK">Hong Kong (HK)</option>
                            <option value="HU">Hungary (HU)</option>
                            <option value="IN">India (IN)</option>
                            <option value="ID">Indonesia (ID)</option>
                            <option value="IR">Iran (IR)</option>
                            <option value="IQ">Iraq (IQ)</option>
                            <option value="IE">Ireland (IE)</option>
                            <option value="IL">Israel (IL)</option>
                            <option value="IT">Italy (IT)</option>
                            <option value="JP" selected>Japan (JP)</option>
                            <option value="JO">Jordan (JO)</option>
                            <option value="KZ">Kazakhstan (KZ)</option>
                            <option value="KE">Kenya (KE)</option>
                            <option value="KR">Korea, Republic of (KR)</option>
                            <option value="KW">Kuwait (KW)</option>
                            <option value="LA">Lao PDR (LA)</option>
                            <option value="LB">Lebanon (LB)</option>
                            <option value="MY">Malaysia (MY)</option>
                            <option value="MX">Mexico (MX)</option>
                            <option value="MM">Myanmar (MM)</option>
                            <option value="NL">Netherlands (NL)</option>
                            <option value="NZ">New Zealand (NZ)</option>
                            <option value="NG">Nigeria (NG)</option>
                            <option value="NO">Norway (NO)</option>
                            <option value="PK">Pakistan (PK)</option>
                            <option value="PH">Philippines (PH)</option>
                            <option value="PL">Poland (PL)</option>
                            <option value="PT">Portugal (PT)</option>
                            <option value="QA">Qatar (QA)</option>
                            <option value="RO">Romania (RO)</option>
                            <option value="RU">Russia (RU)</option>
                            <option value="SA">Saudi Arabia (SA)</option>
                            <option value="SG">Singapore (SG)</option>
                            <option value="ZA">South Africa (ZA)</option>
                            <option value="ES">Spain (ES)</option>
                            <option value="LK">Sri Lanka (LK)</option>
                            <option value="SE">Sweden (SE)</option>
                            <option value="CH">Switzerland (CH)</option>
                            <option value="TW">Taiwan (TW)</option>
                            <option value="TH">Thailand (TH)</option>
                            <option value="TR">Turkey (TR)</option>
                            <option value="AE">United Arab Emirates (AE)</option>
                            <option value="GB">United Kingdom (GB)</option>
                            <option value="US">United States (US)</option>
                            <option value="VN">Vietnam (VN)</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 150px;">
                        <label for="portSelect" style="font-weight: 600; color: #555;">Import Port</label>
                        <select id="portSelect" style="width: 100%; padding: 0.5rem; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 0.9rem;">
                            <option value="port_klang" selected>Port Klang</option>
                            <option value="klia">KLIA</option>
                            <option value="bukit_kayu_hitam">Bukit Kayu Hitam</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 150px;">
                        <label for="importDate" style="font-weight: 600; color: #555;">Import Date</label>
                        <input type="date" id="importDate" style="width: 100%; padding: 0.5rem; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 0.9rem;">
                    </div>
                </div>
            </div>
            
            <!-- Results -->
            <div id="converterResults" class="results-section hidden">
                <!-- Summary Stats -->
                <div id="summaryStats" class="summary-stats"></div>
                
                <!-- Matched Items Table -->
                <div id="matchedItemsSection" class="hidden">
                    <h3>‚úÖ Matched Items (MIDA-Eligible)</h3>
                    <div style="overflow-x: auto;">
                        <table id="matchedItemsTable">
                            <thead>
                                <tr>
                                    <th>Line</th>
                                    <th>Invoice Part Name</th>
                                    <th>Qty</th>
                                    <th>MIDA Line</th>
                                    <th>MIDA Item</th>
                                    <th>MIDA HS Code</th>
                                    <th>Remaining</th>
                                    <th>Score</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- All Invoice Items (Normal Mode) -->
                <div id="allItemsSection" class="hidden">
                    <div class="view-toggle">
                        <button id="viewFilteredBtn" class="toggle-btn active" onclick="switchToFilteredView()">
                            üìã Non-FORM-D Items Only
                        </button>
                        <button id="viewFullBtn" class="toggle-btn" onclick="switchToFullView()">
                            üìÑ All Items (incl. FORM-D & Total)
                        </button>
                    </div>
                    <h3 id="itemsTableTitle">üìã Invoice Items with Empty Form Flag (Non-FORM-D)</h3>
                    <div style="overflow-x: auto;">
                        <table id="allItemsTable">
                            <thead id="allItemsTableHead">
                                <tr>
                                    <th>Line</th>
                                    <th>Parts No</th>
                                    <th>Parts Name</th>
                                    <th>HS Code</th>
                                    <th>Qty</th>
                                    <th>Amount (USD)</th>
                                    <th>Net Wt (Kg)</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div id="tableActionButtons" style="margin-top: 1rem; display: flex; gap: 0.75rem; justify-content: flex-end; align-items: flex-end; flex-wrap: wrap;">
                        <button id="exportK1Btn" class="toggle-btn" style="background: #27ae60; color: white; border-color: #27ae60; padding: 0.6rem 1.2rem;" onclick="exportK1Xls()">
                            üì• Export K1 XLS
                        </button>
                        <div id="databaseUpdateSection" class="hidden" style="display: flex; gap: 0.75rem; align-items: flex-end;">
                            <div class="form-group" style="margin: 0;">
                                <label for="declarationNumber" style="font-weight: 600; color: #555; font-size: 0.85rem;">Declaration Form Reg No</label>
                                <input type="text" id="declarationNumber" placeholder="e.g., Bxxxxxx" style="width: 160px; padding: 0.5rem; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 0.9rem;">
                            </div>
                            <button id="updateDatabaseBtn" style="background: #3498db; color: white; border: 1px solid #3498db; border-radius: 4px; padding: 0.6rem 1.2rem; cursor: pointer;" onclick="updateDatabase()">
                                üíæ Update Database
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Warnings Section -->
                <div id="warningsSection" class="warnings-section hidden">
                    <h3>‚ö†Ô∏è Warnings</h3>
                    <div id="warningsList"></div>
                </div>
                
                <!-- Raw JSON -->
                <details style="margin-top: 1.5rem;">
                    <summary style="cursor: pointer; color: #7f8c8d;">Show Raw JSON Response</summary>
                    <pre id="rawResult"></pre>
                </details>
            </div>
            
            <!-- Error Display -->
            <div id="converterError" class="error-message hidden">
                <h4>‚ùå Error</h4>
                <p id="errorText"></p>
            </div>
            
            <!-- Loading -->
            <div id="converterLoading" class="loading hidden">Processing invoice...</div>
        </div>
    </div>
    
    <!-- Parser Tab -->
    <div id="parser-tab" class="tab-content">
        <div class="container">
            <h2>üîç MIDA Certificate Parser</h2>
            <p>Upload a MIDA certificate PDF to parse and extract data into an editable table.</p>
            
            <div class="form-group">
                <label for="pdfInput">Certificate PDF</label>
                <input type="file" id="pdfInput" accept=".pdf">
            </div>
            
            <button onclick="parseCertificate()" id="parseBtn">Parse Certificate</button>
            
            <!-- Loading -->
            <div id="parserLoading" class="loading hidden">Processing certificate...</div>
            
            <!-- Error Display -->
            <div id="parserError" class="error-message hidden">
                <h4>‚ùå Error</h4>
                <p id="parserErrorText"></p>
            </div>
            
            <!-- Parser Results -->
            <div id="parserResults" class="parser-results hidden">
                <!-- Discrepancy Warning Banner -->
                <div id="discrepancyWarning" class="discrepancy-warning hidden">
                    <h4>‚ö†Ô∏è Quantity Discrepancies Detected</h4>
                    <p>The following rows have a mismatch between Approved Quantity and the sum of station quantities (Port Klang + KLIA + Bukit Kayu Hitam):</p>
                    <ul id="discrepancyList"></ul>
                    <p style="margin-top: 0.5rem; font-size: 0.9rem;">Please review and correct these values before saving to database.</p>
                </div>
                
                <!-- Missing Data Warning Banner (Blocks Save) -->
                <div id="missingDataWarning" class="missing-data-warning hidden">
                    <h4>‚ùå Required Data Missing</h4>
                    <p>The following required fields are missing. You must fill in all required data before saving to database:</p>
                    <ul id="missingDataList"></ul>
                </div>
                
                <h3>üìã Certificate Data 
                    <span id="warningsBadge" class="warnings-badge hidden"></span>
                </h3>
                
                <!-- Certificate Header Fields -->
                <div class="cert-header" id="certHeader">
                    <div class="cert-header-field">
                        <label>Certificate Number</label>
                        <div class="value" id="certNumber" data-field="certificate_number">-</div>
                    </div>
                    <div class="cert-header-field">
                        <label>Company Name</label>
                        <div class="value" id="certCompany" data-field="company_name">-</div>
                    </div>
                    <div class="cert-header-field">
                        <label>Exemption Start Date</label>
                        <div class="value" id="certStartDate" data-field="exemption_start_date">-</div>
                    </div>
                    <div class="cert-header-field">
                        <label>Exemption End Date</label>
                        <div class="value" id="certEndDate" data-field="exemption_end_date">-</div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button id="editBtn" class="btn-edit" onclick="toggleEditMode()">‚úèÔ∏è Edit Data</button>
                    <button id="saveDatabaseBtn" class="btn-database" onclick="showSaveConfirmation()">üíæ Save to Database</button>
                    <button id="saveBtn" class="btn-save hidden" onclick="saveChanges()">‚úÖ Save Changes</button>
                    <button id="cancelBtn" class="btn-cancel hidden" onclick="cancelEdit()">‚ùå Cancel</button>
                </div>
                
                <!-- Items Table -->
                <h3>üì¶ Certificate Items</h3>
                <div class="items-table-container">
                    <table class="items-table" id="certItemsTable">
                        <thead>
                            <tr>
                                <th>Line No</th>
                                <th>HS Code</th>
                                <th>Item Name</th>
                                <th>Approved Qty</th>
                                <th>UOM</th>
                                <th>Port Klang</th>
                                <th>KLIA</th>
                                <th>Bukit Kayu Hitam</th>
                            </tr>
                        </thead>
                        <tbody id="certItemsBody">
                        </tbody>
                    </table>
                </div>
                
                <!-- Success message -->
                <div id="saveSuccess" class="success-message hidden">
                    <h4>‚úÖ Changes Saved</h4>
                    <p>Your edits have been saved successfully.</p>
                </div>
                
                <!-- Warnings Section -->
                <div id="parserWarnings" class="warnings-section hidden">
                    <h3>‚ö†Ô∏è OCR Warnings</h3>
                    <div id="parserWarningsList"></div>
                </div>
                
                <!-- Raw JSON -->
                <details style="margin-top: 1.5rem;">
                    <summary style="cursor: pointer; color: #7f8c8d;">Show Raw JSON Response</summary>
                    <pre id="parserRawResult"></pre>
                </details>
            </div>
        </div>
    </div>
    
    <!-- Database View Tab -->
    <div id="database-tab" class="tab-content">
        <div class="container">
            <h2>üóÑÔ∏è Database View</h2>
            <p>Browse MIDA certificates, items, and import records stored in the database.</p>
            
            <!-- Breadcrumb Navigation -->
            <div class="breadcrumb" id="dbBreadcrumb">
                <span class="breadcrumb-item active" onclick="dbNavigateToCertificates()">üìã Certificates</span>
            </div>
            
            <!-- Loading -->
            <div id="dbLoading" class="loading hidden">Loading data...</div>
            
            <!-- Error Display -->
            <div id="dbError" class="error-message hidden">
                <h4>‚ùå Error</h4>
                <p id="dbErrorText"></p>
            </div>
            
            <!-- Certificates View (Level 1) -->
            <div id="certificatesView">
                <h3>üìã MIDA Certificates</h3>
                <div style="overflow-x: auto;">
                    <table id="certificatesTable">
                        <thead>
                            <tr>
                                <th>Certificate Number</th>
                                <th>Company Name</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Status</th>
                                <th>Items</th>
                            </tr>
                        </thead>
                        <tbody id="certificatesTableBody">
                        </tbody>
                    </table>
                </div>
                <div id="certificatesPagination" class="pagination-container hidden">
                    <div class="pagination-left">
                        <div class="pagination-info" id="certificatesPaginationInfo"></div>
                        <div class="rows-per-page">
                            <label>Rows per page:</label>
                            <select id="certificatesPerPageSelect" onchange="changeCertificatesPerPage(this.value)">
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100" selected>100</option>
                                <option value="200">200</option>
                            </select>
                        </div>
                    </div>
                    <div class="pagination-controls" id="certificatesPaginationControls"></div>
                </div>
            </div>
            
            <!-- Certificate Items View (Level 2) -->
            <div id="itemsView" class="hidden">
                <button class="back-btn" onclick="dbNavigateToCertificates()">‚Üê Back to Certificates</button>
                
                <!-- Selected Certificate Info Card -->
                <div class="info-card" id="selectedCertificateInfo">
                    <div class="info-card-title">Selected Certificate</div>
                    <div class="info-card-grid">
                        <div class="info-card-item">
                            <span class="info-card-label">Certificate Number</span>
                            <span class="info-card-value" id="infoCertNumber">-</span>
                        </div>
                        <div class="info-card-item">
                            <span class="info-card-label">Company Name</span>
                            <span class="info-card-value" id="infoCertCompany">-</span>
                        </div>
                        <div class="info-card-item">
                            <span class="info-card-label">Valid Period</span>
                            <span class="info-card-value" id="infoCertPeriod">-</span>
                        </div>
                        <div class="info-card-item">
                            <span class="info-card-label">Status</span>
                            <span class="info-card-value" id="infoCertStatus">-</span>
                        </div>
                    </div>
                </div>
                
                <h3>üì¶ Certificate Items</h3>
                
                <!-- Quantity Toggle -->
                <div class="qty-toggle-container">
                    <span class="qty-toggle-label">Display Quantities:</span>
                    <div class="qty-toggle-switch">
                        <button class="qty-toggle-btn active" id="toggleApproved" onclick="toggleQuantityView('approved')">Approved (Total)</button>
                        <button class="qty-toggle-btn" id="toggleRemaining" onclick="toggleQuantityView('remaining')">Remaining</button>
                    </div>
                    <span style="font-size: 0.85rem; color: #7f8c8d;">
                        <span class="qty-status-normal">‚óè</span> Normal &nbsp;
                        <span class="qty-status-warning">‚óè</span> Depleting &nbsp;
                        <span class="qty-status-depleted">‚óè</span> Depleted &nbsp;
                        <span class="qty-status-overdrawn">‚óè</span> Overdrawn
                    </span>
                </div>
                
                <div style="overflow-x: auto;">
                    <table id="itemsTable">
                        <thead>
                            <tr>
                                <th>Line</th>
                                <th>HS Code</th>
                                <th>Item Name</th>
                                <th>UOM</th>
                                <th class="number-cell">Total Qty</th>
                                <th class="number-cell">Port Klang</th>
                                <th class="number-cell">KLIA</th>
                                <th class="number-cell">Bukit Kayu Hitam</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="itemsTableBody">
                        </tbody>
                    </table>
                </div>
                <div id="itemsPagination" class="pagination-container hidden">
                    <div class="pagination-left">
                        <div class="pagination-info" id="itemsPaginationInfo"></div>
                        <div class="rows-per-page">
                            <label>Rows per page:</label>
                            <select id="itemsPerPageSelect" onchange="changeItemsPerPage(this.value)">
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100" selected>100</option>
                                <option value="200">200</option>
                            </select>
                        </div>
                    </div>
                    <div class="pagination-controls" id="itemsPaginationControls"></div>
                </div>
            </div>
            
            <!-- Import Records View (Level 3) -->
            <div id="importsView" class="hidden">
                <button class="back-btn" onclick="dbNavigateToItems()">‚Üê Back to Items</button>
                
                <!-- Selected Item Info Card -->
                <div class="info-card" id="selectedItemInfo">
                    <div class="info-card-title">Selected Item</div>
                    <div class="info-card-grid">
                        <div class="info-card-item">
                            <span class="info-card-label">Certificate</span>
                            <span class="info-card-value" id="infoItemCert">-</span>
                        </div>
                        <div class="info-card-item">
                            <span class="info-card-label">HS Code</span>
                            <span class="info-card-value" id="infoItemHsCode">-</span>
                        </div>
                        <div class="info-card-item">
                            <span class="info-card-label">Item Name</span>
                            <span class="info-card-value" id="infoItemName">-</span>
                        </div>
                        <div class="info-card-item">
                            <span class="info-card-label">UOM</span>
                            <span class="info-card-value" id="infoItemUom">-</span>
                        </div>
                    </div>
                </div>
                
                <h3>üì• Import Records</h3>
                
                <!-- Port Filter -->
                <div class="port-filter-container">
                    <button class="port-filter-btn active" data-port="all" onclick="filterByPort('all')">üåê All Ports</button>
                    <button class="port-filter-btn" data-port="port_klang" onclick="filterByPort('port_klang')">üö¢ Port Klang</button>
                    <button class="port-filter-btn" data-port="klia" onclick="filterByPort('klia')">‚úàÔ∏è KLIA</button>
                    <button class="port-filter-btn" data-port="bukit_kayu_hitam" onclick="filterByPort('bukit_kayu_hitam')">üöõ Bukit Kayu Hitam</button>
                </div>
                
                <div style="overflow-x: auto;">
                    <table id="importsTable">
                        <thead>
                            <tr>
                                <th>Import Date</th>
                                <th>Invoice Number</th>
                                <th>Invoice Line</th>
                                <th>Port</th>
                                <th class="number-cell">Qty Imported</th>
                                <th class="number-cell">Before Balance</th>
                                <th class="number-cell">After Balance</th>
                                <th>Remarks</th>
                            </tr>
                        </thead>
                        <tbody id="importsTableBody">
                        </tbody>
                    </table>
                </div>
                <div id="importsPagination" class="pagination-container hidden">
                    <div class="pagination-left">
                        <div class="pagination-info" id="importsPaginationInfo"></div>
                        <div class="rows-per-page">
                            <label>Rows per page:</label>
                            <select id="importsPerPageSelect" onchange="changeImportsPerPage(this.value)">
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100" selected>100</option>
                                <option value="200">200</option>
                            </select>
                        </div>
                    </div>
                    <div class="pagination-controls" id="importsPaginationControls"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Use relative URL when served from same origin, or localhost for local file access
        const API_BASE = window.location.protocol === 'file:' ? 'http://localhost:8000' : '';
        
        // Set default import date to today
        document.addEventListener('DOMContentLoaded', function() {
            const importDateInput = document.getElementById('importDate');
            if (importDateInput) {
                const today = new Date().toISOString().split('T')[0];
                importDateInput.value = today;
            }
        });
        
        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            document.querySelector(`.tab-content#${tabName}-tab`).classList.add('active');
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
        }
        
        // Toggle MIDA mode options
        async function toggleMidaMode() {
            const midaMode = document.getElementById('midaMode').checked;
            const midaOptions = document.getElementById('midaOptions');
            const databaseUpdateSection = document.getElementById('databaseUpdateSection');
            
            if (midaMode) {
                midaOptions.classList.remove('hidden');
                if (databaseUpdateSection) {
                    databaseUpdateSection.classList.remove('hidden');
                    databaseUpdateSection.style.display = 'flex';
                }
                
                // Fetch and populate certificate dropdown
                await loadMidaCertificates();
            } else {
                midaOptions.classList.add('hidden');
                if (databaseUpdateSection) {
                    databaseUpdateSection.classList.add('hidden');
                    databaseUpdateSection.style.display = 'none';
                }
            }
        }
        
        // Load certificates from database for MIDA matching dropdown
        async function loadMidaCertificates() {
            console.log('loadMidaCertificates called');
            const certSelect = document.getElementById('midaCertNumber');
            const loadingText = document.getElementById('certLoadingText');
            
            console.log('certSelect:', certSelect);
            console.log('loadingText:', loadingText);
            
            // Show loading
            loadingText.classList.remove('hidden');
            certSelect.disabled = true;
            
            try {
                const url = `${API_BASE}/api/mida/certificates?limit=100&status=active`;
                console.log('Fetching certificates from:', url);
                const response = await fetch(url);
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    console.error('Failed to fetch certificates, status:', response.status);
                    loadingText.textContent = '‚ùå Failed to load certificates';
                    return;
                }
                
                const data = await response.json();
                console.log('Certificates data:', data);
                
                // Clear existing options (except placeholder)
                certSelect.innerHTML = '<option value="">-- Select Certificate --</option>';
                
                // Add certificate options
                if (data.items && data.items.length > 0) {
                    console.log('Found', data.items.length, 'certificates');
                    data.items.forEach(cert => {
                        const option = document.createElement('option');
                        option.value = cert.certificate_number;
                        option.textContent = `${cert.certificate_number} - ${cert.company_name}`;
                        option.dataset.certId = cert.id;
                        certSelect.appendChild(option);
                    });
                    loadingText.classList.add('hidden');
                } else {
                    console.log('No certificates found in response');
                    loadingText.textContent = 'üì≠ No active certificates found';
                }
                
            } catch (error) {
                console.error('Error loading certificates:', error);
                loadingText.textContent = '‚ùå Error connecting to database';
            } finally {
                certSelect.disabled = false;
            }
        }
        
        // Store matched items data for database update
        let matchedItemsForDatabase = [];
        
        // Store matched items for MIDA export (with MIDA HS codes)
        let matchedItemsForExport = [];
        
        // Update database with matched import records
        async function updateDatabase() {
            const certNumber = document.getElementById('midaCertNumber').value.trim();
            const declarationNumber = document.getElementById('declarationNumber').value.trim();
            const importDate = document.getElementById('importDate').value;
            const port = document.getElementById('portSelect').value;
            
            // Validation
            if (!certNumber) {
                showError('Please select a MIDA certificate.');
                return;
            }
            
            if (!importDate) {
                showError('Please enter an import date.');
                return;
            }
            
            if (!matchedItemsForDatabase || matchedItemsForDatabase.length === 0) {
                showError('No matched items to save. Please convert an invoice with MIDA matching first.');
                return;
            }
            
            const updateBtn = document.getElementById('updateDatabaseBtn');
            const originalText = updateBtn.textContent;
            updateBtn.disabled = true;
            updateBtn.textContent = '‚è≥ Saving...';
            
            try {
                // Build import records from matched items
                const importRecords = matchedItemsForDatabase.map(item => ({
                    certificate_item_id: item.mida_item_id,
                    import_date: importDate,
                    declaration_form_reg_no: declarationNumber || null,
                    invoice_number: item.invoice_number || 'UNKNOWN',
                    invoice_line: item.invoice_line,
                    quantity_imported: item.quantity,
                    port: port,
                    remarks: `Matched with score ${item.match_score}`
                }));
                
                const response = await fetch(`${API_BASE}/api/mida/imports/bulk`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(importRecords)
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    const errorDetail = data.detail;
                    if (typeof errorDetail === 'object') {
                        showError(errorDetail.detail || 'Failed to update database');
                    } else {
                        showError(errorDetail || 'Failed to update database');
                    }
                    return;
                }
                
                // Success
                alert(`‚úÖ Successfully saved ${data.length} import records to the database!`);
                updateBtn.textContent = '‚úÖ Saved!';
                
                // Reset after 2 seconds
                setTimeout(() => {
                    updateBtn.textContent = originalText;
                }, 2000);
                
            } catch (error) {
                console.error('Database update error:', error);
                showError('Error updating database: ' + error.message);
            } finally {
                updateBtn.disabled = false;
                if (updateBtn.textContent === '‚è≥ Saving...') {
                    updateBtn.textContent = originalText;
                }
            }
        }
        
        // Convert Invoice
        async function convertInvoice() {
            const fileInput = document.getElementById('invoiceFile');
            const midaMode = document.getElementById('midaMode').checked;
            const certNumber = document.getElementById('midaCertNumber').value.trim();
            // Match mode and threshold are developer-controlled defaults
            const matchMode = 'fuzzy';
            const matchThreshold = 0.88;
            
            // Reset UI
            hideElement('converterResults');
            hideElement('converterError');
            hideElement('matchedItemsSection');
            hideElement('allItemsSection');
            hideElement('warningsSection');
            
            // Validation
            if (!fileInput.files[0]) {
                showError('Please select an invoice file first.');
                return;
            }
            
            if (midaMode && !certNumber) {
                showError('Please select a MIDA certificate from the dropdown.');
                return;
            }
            
            // Show loading
            showElement('converterLoading');
            document.getElementById('convertBtn').disabled = true;
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('match_mode', matchMode);
            formData.append('match_threshold', matchThreshold);
            
            if (midaMode && certNumber) {
                formData.append('mida_certificate_number', certNumber);
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/convert`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    // Handle error responses
                    const errorDetail = data.detail;
                    if (typeof errorDetail === 'object') {
                        if (errorDetail.detail === 'Invalid MIDA certificate number') {
                            showError(`Certificate not found: "${certNumber}" is not a valid MIDA certificate number. Please check the certificate number and try again.`);
                        } else {
                            showError(errorDetail.detail || 'An error occurred');
                        }
                    } else {
                        showError(errorDetail || 'An error occurred');
                    }
                    return;
                }
                
                // Display results
                displayResults(data, midaMode);
                
            } catch (error) {
                console.error('Error:', error);
                showError('Error connecting to server: ' + error.message);
            } finally {
                hideElement('converterLoading');
                document.getElementById('convertBtn').disabled = false;
            }
        }
        
        // Export K1 XLS
        async function exportK1Xls() {
            const exportBtn = document.getElementById('exportK1Btn');
            const originalText = exportBtn.textContent;
            exportBtn.disabled = true;
            exportBtn.textContent = '‚è≥ Exporting...';
            
            const country = document.getElementById('countrySelect').value;
            const midaMode = document.getElementById('midaMatchingMode').checked;
            
            try {
                let response;
                
                if (midaMode && matchedItemsForExport && matchedItemsForExport.length > 0) {
                    // MIDA mode: Use the new endpoint with MIDA HS codes from certificate
                    response = await fetch(`${API_BASE}/api/convert/export-mida`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            items: matchedItemsForExport,
                            country: country
                        })
                    });
                } else {
                    // Normal mode: Use the original endpoint (parses invoice file)
                    const fileInput = document.getElementById('invoiceFile');
                    
                    if (!fileInput.files[0]) {
                        showError('Please select an invoice file first.');
                        return;
                    }
                    
                    const formData = new FormData();
                    formData.append('file', fileInput.files[0]);
                    formData.append('country', country);
                    
                    response = await fetch(`${API_BASE}/api/convert/export`, {
                        method: 'POST',
                        body: formData
                    });
                }
                
                if (!response.ok) {
                    const data = await response.json();
                    const errorDetail = data.detail;
                    if (typeof errorDetail === 'object') {
                        showError(errorDetail.detail || 'Export failed');
                    } else {
                        showError(errorDetail || 'Export failed');
                    }
                    return;
                }
                
                // Download the file
                const blob = await response.blob();
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'mida-k1-import.xls';
                if (contentDisposition) {
                    const match = contentDisposition.match(/filename="(.+)"/);
                    if (match) filename = match[1];
                }
                
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
            } catch (error) {
                console.error('Export error:', error);
                showError('Error exporting K1 XLS: ' + error.message);
            } finally {
                exportBtn.disabled = false;
                exportBtn.textContent = originalText;
            }
        }
        
        // Display results
        function displayResults(data, midaMode) {
            showElement('converterResults');
            
            // Summary stats
            const statsHtml = `
                <div class="stat-card">
                    <div class="number">${data.total_invoice_items}</div>
                    <div class="label">Total Items</div>
                </div>
                <div class="stat-card matched">
                    <div class="number">${data.matched_item_count}</div>
                    <div class="label">Matched</div>
                </div>
                <div class="stat-card unmatched">
                    <div class="number">${data.unmatched_item_count}</div>
                    <div class="label">Unmatched</div>
                </div>
            `;
            document.getElementById('summaryStats').innerHTML = statsHtml;
            
            // Raw JSON
            document.getElementById('rawResult').textContent = JSON.stringify(data, null, 2);
            
            if (midaMode && data.mida_matched_items && data.mida_matched_items.length > 0) {
                // Store matched items for database update
                matchedItemsForDatabase = data.mida_matched_items.map(item => ({
                    mida_item_id: item.mida_item_id,
                    invoice_number: data.mida_certificate_number || 'UNKNOWN',
                    invoice_line: item.line_no,
                    quantity: parseFloat(item.quantity) || 0,
                    match_score: item.match_score
                }));
                
                // Store matched items for export (with MIDA HS codes)
                matchedItemsForExport = data.mida_matched_items.map(item => ({
                    hs_code: item.mida_hs_code,  // Use MIDA certificate HS code, not invoice HS code
                    description: item.description,
                    quantity: parseFloat(item.quantity) || 0,
                    uom: item.uom || 'UNT',
                    amount: item.amount ? parseFloat(item.amount) : null,
                    net_weight_kg: item.net_weight_kg ? parseFloat(item.net_weight_kg) : null
                }));
                
                // Display matched items table
                displayMatchedItems(data.mida_matched_items);
            } else if (!midaMode && data.all_invoice_items && data.all_invoice_items.length > 0) {
                // Clear matched items when not in MIDA mode
                matchedItemsForDatabase = [];
                matchedItemsForExport = [];
                
                // Display all items table (normal mode) - start with filtered view
                cachedResponseData = data;
                currentViewMode = 'filtered';
                updateToggleUI();
                displayAllItems(data.all_invoice_items, false);
            }
            
            // Display warnings (only in full view for normal mode, since filtered view won't match totals)
            if (data.warnings && data.warnings.length > 0) {
                if (midaMode) {
                    displayWarnings(data.warnings);
                }
                // For normal mode, warnings shown only when switching to full view
            }
        }
        
        // Cache response data for toggle functionality
        let cachedResponseData = null;
        let currentViewMode = 'filtered'; // 'filtered' or 'full'
        
        // Switch to filtered view (non-FORM-D only)
        function switchToFilteredView() {
            if (!cachedResponseData) return;
            currentViewMode = 'filtered';
            updateToggleUI();
            displayAllItems(cachedResponseData.all_invoice_items, false);
            document.getElementById('itemsTableTitle').textContent = 'üìã Invoice Items with Empty Form Flag (Non-FORM-D)';
            
            // Hide warnings in filtered view (totals won't match since FORM-D items are excluded)
            hideElement('warningsSection');
        }
        
        // Switch to full view (all items including FORM-D and Total)
        function switchToFullView() {
            if (!cachedResponseData) return;
            currentViewMode = 'full';
            updateToggleUI();
            
            if (cachedResponseData.full_invoice_items && cachedResponseData.full_invoice_items.length > 0) {
                displayAllItems(cachedResponseData.full_invoice_items, true);
            } else {
                console.warn('full_invoice_items is empty or undefined');
                // Fallback: show message
                const tbody = document.querySelector('#allItemsTable tbody');
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #7f8c8d;">No items available in full view</td></tr>';
            }
            document.getElementById('itemsTableTitle').textContent = 'üìÑ All Invoice Items (Including FORM-D & Total)';
            
            // Show warnings in full view (Total Row Validation)
            if (cachedResponseData.warnings && cachedResponseData.warnings.length > 0) {
                displayWarnings(cachedResponseData.warnings);
            } else {
                hideElement('warningsSection');
            }
        }
        
        // Update toggle button UI
        function updateToggleUI() {
            document.getElementById('viewFilteredBtn').classList.toggle('active', currentViewMode === 'filtered');
            document.getElementById('viewFullBtn').classList.toggle('active', currentViewMode === 'full');
        }
        
        // Display matched items table
        function displayMatchedItems(items) {
            showElement('matchedItemsSection');
            const tbody = document.querySelector('#matchedItemsTable tbody');
            tbody.innerHTML = '';
            
            items.forEach(item => {
                const scoreClass = item.match_score >= 0.95 ? 'high' : 
                                   item.match_score >= 0.8 ? 'medium' : 'low';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.line_no}</td>
                    <td>${escapeHtml(item.description)}</td>
                    <td>${item.quantity}</td>
                    <td>${item.mida_line_no}</td>
                    <td>${escapeHtml(item.mida_item_name)}</td>
                    <td><code>${escapeHtml(item.mida_hs_code)}</code></td>
                    <td>${item.remaining_qty} ${item.remaining_uom}</td>
                    <td><span class="match-score ${scoreClass}">${(item.match_score * 100).toFixed(0)}%</span></td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Display all items table (normal mode)
        function displayAllItems(items, showFormFlag = false) {
            showElement('allItemsSection');
            
            // Update table header based on view mode
            const thead = document.getElementById('allItemsTableHead');
            if (showFormFlag) {
                thead.innerHTML = `
                    <tr>
                        <th>Line</th>
                        <th>Parts No</th>
                        <th>Parts Name</th>
                        <th>HS Code</th>
                        <th>Form Flag</th>
                        <th>Qty</th>
                        <th>Amount (USD)</th>
                        <th>Net Wt (Kg)</th>
                    </tr>
                `;
            } else {
                thead.innerHTML = `
                    <tr>
                        <th>Line</th>
                        <th>Parts No</th>
                        <th>Parts Name</th>
                        <th>HS Code</th>
                        <th>Qty</th>
                        <th>Amount (USD)</th>
                        <th>Net Wt (Kg)</th>
                    </tr>
                `;
            }
            
            const tbody = document.querySelector('#allItemsTable tbody');
            tbody.innerHTML = '';
            
            items.forEach(item => {
                const row = document.createElement('tr');
                const isTotal = item.is_total_row === true;
                const isFormD = item.form_flag === 'FORM-D';
                
                if (isTotal) {
                    row.className = 'total-row';
                }
                
                if (showFormFlag) {
                    // Full view with Form Flag column
                    const formFlagBadge = isTotal ? '' : 
                        isFormD ? '<span class="form-flag-badge form-d">FORM-D</span>' :
                        '<span class="form-flag-badge empty">Non-FORM-D</span>';
                    
                    row.innerHTML = `
                        <td>${isTotal ? '' : item.line_no}</td>
                        <td>${escapeHtml(item.parts_no || '')}</td>
                        <td>${isTotal ? '<strong>Total</strong>' : escapeHtml(item.description)}</td>
                        <td>${escapeHtml(item.hs_code || '')}</td>
                        <td>${formFlagBadge}</td>
                        <td>${item.quantity}</td>
                        <td>${item.amount ? '$' + item.amount.toFixed(2) : '-'}</td>
                        <td>${item.net_weight_kg ? item.net_weight_kg.toFixed(2) : '-'}</td>
                    `;
                } else {
                    // Filtered view without Form Flag column
                    row.innerHTML = `
                        <td>${item.line_no}</td>
                        <td>${escapeHtml(item.parts_no || '')}</td>
                        <td>${escapeHtml(item.description)}</td>
                        <td>${escapeHtml(item.hs_code || '')}</td>
                        <td>${item.quantity}</td>
                        <td>${item.amount ? '$' + item.amount.toFixed(2) : '-'}</td>
                        <td>${item.net_weight_kg ? item.net_weight_kg.toFixed(2) : '-'}</td>
                    `;
                }
                tbody.appendChild(row);
            });
        }
        
        // Display warnings
        function displayWarnings(warnings) {
            showElement('warningsSection');
            const container = document.getElementById('warningsList');
            container.innerHTML = '';
            
            warnings.forEach(warning => {
                const div = document.createElement('div');
                div.className = `warning-item ${warning.severity}`;
                div.innerHTML = `
                    <span class="invoice-item">${escapeHtml(warning.invoice_item)}</span>
                    <span class="severity-badge ${warning.severity}">${warning.severity}</span>
                    <div class="reason">${escapeHtml(warning.reason)}</div>
                `;
                container.appendChild(div);
            });
        }
        
        // Show error message
        function showError(message) {
            document.getElementById('errorText').textContent = message;
            showElement('converterError');
        }
        
        // Helper functions
        function showElement(id) {
            document.getElementById(id).classList.remove('hidden');
        }
        
        function hideElement(id) {
            document.getElementById(id).classList.add('hidden');
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Certificate Parser (existing functionality)
        async function uploadFile() {
            const fileInput = document.getElementById('pdfInput');
            const resultDisplay = document.getElementById('result');
            
            if (!fileInput.files[0]) {
                alert('Please select a PDF file first.');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            resultDisplay.textContent = 'Uploading and processing...';

            try {
                const response = await fetch(`${API_BASE}/api/mida/certificate/parse`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                resultDisplay.textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                console.error('Error:', error);
                resultDisplay.textContent = 'Error processing request: ' + error.message;
            }
        }
        
        // ==========================================
        // Certificate Parser - Interactive Table
        // ==========================================
        
        let parsedCertificateData = null;
        let originalCertificateData = null;
        let isEditMode = false;
        
        // Parse Certificate
        async function parseCertificate() {
            const fileInput = document.getElementById('pdfInput');
            
            // Reset UI
            hideElement('parserResults');
            hideElement('parserError');
            hideElement('saveSuccess');
            hideElement('parserWarnings');
            
            if (!fileInput.files[0]) {
                showParserError('Please select a PDF file first.');
                return;
            }
            
            // Show loading
            showElement('parserLoading');
            document.getElementById('parseBtn').disabled = true;
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            try {
                const response = await fetch(`${API_BASE}/api/mida/certificate/parse`, {
                    method: 'POST',
                    body: formData
                });
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    showParserError(`Server error: ${text || response.statusText}`);
                    return;
                }
                
                const data = await response.json();
                
                if (!response.ok) {
                    const errorMsg = data.detail || 'Failed to parse certificate';
                    showParserError(typeof errorMsg === 'object' ? JSON.stringify(errorMsg) : errorMsg);
                    return;
                }
                
                // Store data
                parsedCertificateData = JSON.parse(JSON.stringify(data));
                originalCertificateData = JSON.parse(JSON.stringify(data));
                
                // Display results
                displayParsedCertificate(data);
                
            } catch (error) {
                console.error('Error:', error);
                showParserError('Error connecting to server: ' + error.message);
            } finally {
                hideElement('parserLoading');
                document.getElementById('parseBtn').disabled = false;
            }
        }
        
        // Date format conversion utilities
        function isoToDisplay(isoDate) {
            // Convert YYYY-MM-DD to DD/MM/YYYY
            if (!isoDate || isoDate === '-') return '-';
            const parts = isoDate.split('-');
            if (parts.length !== 3) return isoDate;
            return `${parts[2]}/${parts[1]}/${parts[0]}`;
        }
        
        function displayToIso(displayDate) {
            // Convert DD/MM/YYYY to YYYY-MM-DD
            if (!displayDate || displayDate === '-') return null;
            const parts = displayDate.split('/');
            if (parts.length !== 3) return displayDate;
            return `${parts[2]}-${parts[1]}-${parts[0]}`;
        }
        
        function isoToInputValue(isoDate) {
            // Convert YYYY-MM-DD to input date value (YYYY-MM-DD for HTML date input)
            if (!isoDate || isoDate === '-') return '';
            return isoDate;
        }
        
        // Display parsed certificate data
        function displayParsedCertificate(data) {
            showElement('parserResults');
            
            // Populate header fields (note: backend uses mida_no, exemption_start, exemption_end)
            document.getElementById('certNumber').textContent = data.mida_no || '-';
            document.getElementById('certCompany').textContent = data.company_name || '-';
            
            // Store ISO dates as data attributes and display in DD/MM/YYYY format
            const startDateEl = document.getElementById('certStartDate');
            const endDateEl = document.getElementById('certEndDate');
            
            startDateEl.dataset.isoDate = data.exemption_start || '';
            startDateEl.textContent = isoToDisplay(data.exemption_start) || '-';
            
            endDateEl.dataset.isoDate = data.exemption_end || '';
            endDateEl.textContent = isoToDisplay(data.exemption_end) || '-';
            
            // Populate items table
            const tbody = document.getElementById('certItemsBody');
            tbody.innerHTML = '';
            
            if (data.items && data.items.length > 0) {
                data.items.forEach((item, index) => {
                    const row = document.createElement('tr');
                    row.dataset.index = index;
                    
                    // Extract station quantities from nested station_split object
                    const stationSplit = item.station_split || {};
                    const portKlangQty = stationSplit.PORT_KLANG ?? '';
                    const kliaQty = stationSplit.KLIA ?? '';
                    const bukitKayuHitamQty = stationSplit.BUKIT_KAYU_HITAM ?? '';
                    
                    row.innerHTML = `
                        <td class="editable-cell" data-field="line_no">${item.line_no || ''}</td>
                        <td class="editable-cell" data-field="hs_code">${escapeHtml(item.hs_code || '')}</td>
                        <td class="editable-cell" data-field="item_name">${escapeHtml(item.item_name || '')}</td>
                        <td class="editable-cell" data-field="approved_quantity">${item.approved_quantity ?? ''}</td>
                        <td class="editable-cell" data-field="uom">${escapeHtml(item.uom || '')}</td>
                        <td class="editable-cell" data-field="port_klang_qty">${portKlangQty}</td>
                        <td class="editable-cell" data-field="klia_qty">${kliaQty}</td>
                        <td class="editable-cell" data-field="bukit_kayu_hitam_qty">${bukitKayuHitamQty}</td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #7f8c8d;">No items found in certificate</td></tr>';
            }
            
            // Show warnings if any
            if (data.warnings && data.warnings.length > 0) {
                document.getElementById('warningsBadge').textContent = `${data.warnings.length} warning(s)`;
                showElement('warningsBadge');
                displayParserWarnings(data.warnings);
            } else {
                hideElement('warningsBadge');
            }
            
            // Show raw JSON
            document.getElementById('parserRawResult').textContent = JSON.stringify(data, null, 2);
            
            // Reset edit mode
            isEditMode = false;
            updateEditButtons();
            
            // Validate missing required fields after parse
            validateMissingRequiredFields();
            
            // Validate quantity discrepancies after parse
            validateQuantityDiscrepancies();
        }
        
        // Validate missing required fields (blocks save to database)
        function validateMissingRequiredFields() {
            const missingItems = [];
            
            // Check header fields
            const certNumber = document.getElementById('certNumber').textContent.trim();
            const company = document.getElementById('certCompany').textContent.trim();
            const startDateEl = document.getElementById('certStartDate');
            const endDateEl = document.getElementById('certEndDate');
            
            // Get date values (check both text content and data attribute)
            let startDate = startDateEl.dataset.isoDate || '';
            let endDate = endDateEl.dataset.isoDate || '';
            
            // If in view mode, also check text content
            if (!startDate && startDateEl.textContent.trim() !== '-') {
                startDate = startDateEl.textContent.trim();
            }
            if (!endDate && endDateEl.textContent.trim() !== '-') {
                endDate = endDateEl.textContent.trim();
            }
            
            // Clear previous header highlighting
            document.getElementById('certNumber').classList.remove('missing-field');
            document.getElementById('certCompany').classList.remove('missing-field');
            startDateEl.classList.remove('missing-field');
            endDateEl.classList.remove('missing-field');
            
            // Check each required header field
            if (!certNumber || certNumber === '-') {
                missingItems.push('Certificate Number is missing');
                document.getElementById('certNumber').classList.add('missing-field');
            }
            if (!company || company === '-') {
                missingItems.push('Company Name is missing');
                document.getElementById('certCompany').classList.add('missing-field');
            }
            if (!startDate) {
                missingItems.push('Exemption Start Date is missing');
                startDateEl.classList.add('missing-field');
            }
            if (!endDate) {
                missingItems.push('Exemption End Date is missing');
                endDateEl.classList.add('missing-field');
            }
            
            // Check table rows for required fields
            const rows = document.querySelectorAll('#certItemsBody tr[data-index]');
            
            rows.forEach((row) => {
                const lineNo = row.querySelector('[data-field="line_no"]')?.textContent.trim() || '';
                const hsCode = row.querySelector('[data-field="hs_code"]')?.textContent.trim() || '';
                const itemName = row.querySelector('[data-field="item_name"]')?.textContent.trim() || '';
                const approvedQty = row.querySelector('[data-field="approved_quantity"]')?.textContent.trim() || '';
                const uom = row.querySelector('[data-field="uom"]')?.textContent.trim() || '';
                
                // Clear previous cell highlighting
                row.classList.remove('missing-data-row');
                row.querySelectorAll('.missing-field').forEach(cell => cell.classList.remove('missing-field'));
                
                const rowMissing = [];
                
                if (!hsCode) {
                    rowMissing.push('HS Code');
                    row.querySelector('[data-field="hs_code"]')?.classList.add('missing-field');
                }
                if (!itemName) {
                    rowMissing.push('Item Name');
                    row.querySelector('[data-field="item_name"]')?.classList.add('missing-field');
                }
                if (!approvedQty) {
                    rowMissing.push('Approved Quantity');
                    row.querySelector('[data-field="approved_quantity"]')?.classList.add('missing-field');
                }
                if (!uom) {
                    rowMissing.push('UOM');
                    row.querySelector('[data-field="uom"]')?.classList.add('missing-field');
                }
                
                if (rowMissing.length > 0) {
                    row.classList.add('missing-data-row');
                    missingItems.push(`Line ${lineNo || '?'}: Missing ${rowMissing.join(', ')}`);
                }
            });
            
            // Update missing data warning banner
            const warningBanner = document.getElementById('missingDataWarning');
            const missingList = document.getElementById('missingDataList');
            
            if (missingItems.length > 0) {
                missingList.innerHTML = '';
                missingItems.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    missingList.appendChild(li);
                });
                showElement('missingDataWarning');
            } else {
                hideElement('missingDataWarning');
            }
            
            return missingItems.length;
        }
        
        // Validate quantity discrepancies (Approved Qty vs sum of station quantities)
        function validateQuantityDiscrepancies() {
            const rows = document.querySelectorAll('#certItemsBody tr[data-index]');
            const discrepancies = [];
            
            rows.forEach((row) => {
                const lineNo = row.querySelector('[data-field="line_no"]')?.textContent.trim() || '';
                const approvedQtyText = row.querySelector('[data-field="approved_quantity"]')?.textContent.trim() || '';
                const portKlangText = row.querySelector('[data-field="port_klang_qty"]')?.textContent.trim() || '';
                const kliaText = row.querySelector('[data-field="klia_qty"]')?.textContent.trim() || '';
                const bukitKayuHitamText = row.querySelector('[data-field="bukit_kayu_hitam_qty"]')?.textContent.trim() || '';
                
                const approvedQty = parseFloat(approvedQtyText) || 0;
                const portKlang = parseFloat(portKlangText) || 0;
                const klia = parseFloat(kliaText) || 0;
                const bukitKayuHitam = parseFloat(bukitKayuHitamText) || 0;
                
                const stationSum = portKlang + klia + bukitKayuHitam;
                
                // Check if there's a discrepancy (allow small floating point tolerance)
                const tolerance = 0.001;
                const hasDiscrepancy = Math.abs(approvedQty - stationSum) > tolerance;
                
                // Also check if all station values are empty/zero but approved qty is not
                const allStationsEmpty = portKlangText === '' && kliaText === '' && bukitKayuHitamText === '';
                
                if (hasDiscrepancy && !allStationsEmpty) {
                    row.classList.add('discrepancy-row');
                    discrepancies.push({
                        lineNo: lineNo,
                        approvedQty: approvedQty,
                        stationSum: stationSum,
                        difference: approvedQty - stationSum
                    });
                } else {
                    row.classList.remove('discrepancy-row');
                }
            });
            
            // Update discrepancy warning banner
            const warningBanner = document.getElementById('discrepancyWarning');
            const discrepancyList = document.getElementById('discrepancyList');
            
            if (discrepancies.length > 0) {
                discrepancyList.innerHTML = '';
                discrepancies.forEach(d => {
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>Line ${d.lineNo}:</strong> Approved Qty (${d.approvedQty}) ‚â† Station Sum (${d.stationSum.toFixed(2)}) ‚Äî Difference: ${d.difference.toFixed(2)}`;
                    discrepancyList.appendChild(li);
                });
                showElement('discrepancyWarning');
            } else {
                hideElement('discrepancyWarning');
            }
            
            return discrepancies.length;
        }
        
        // Display parser warnings
        function displayParserWarnings(warnings) {
            showElement('parserWarnings');
            const container = document.getElementById('parserWarningsList');
            container.innerHTML = '';
            
            warnings.forEach(warning => {
                const div = document.createElement('div');
                div.className = 'warning-item warning';
                div.innerHTML = `<span class="reason">${escapeHtml(warning)}</span>`;
                container.appendChild(div);
            });
        }
        
        // Toggle edit mode
        function toggleEditMode() {
            isEditMode = !isEditMode;
            
            // Store current data before editing
            if (isEditMode) {
                originalCertificateData = JSON.parse(JSON.stringify(parsedCertificateData));
            }
            
            // Handle non-date header fields (certificate number, company name)
            const certNumberEl = document.getElementById('certNumber');
            const certCompanyEl = document.getElementById('certCompany');
            
            if (isEditMode) {
                certNumberEl.contentEditable = 'true';
                certNumberEl.classList.add('editable');
                certCompanyEl.contentEditable = 'true';
                certCompanyEl.classList.add('editable');
            } else {
                certNumberEl.contentEditable = 'false';
                certNumberEl.classList.remove('editable');
                certCompanyEl.contentEditable = 'false';
                certCompanyEl.classList.remove('editable');
            }
            
            // Handle date fields with date input
            const startDateEl = document.getElementById('certStartDate');
            const endDateEl = document.getElementById('certEndDate');
            
            if (isEditMode) {
                // Replace text with date input for start date
                const startIso = startDateEl.dataset.isoDate || '';
                startDateEl.innerHTML = `<input type="date" id="startDateInput" value="${startIso}" style="width: 100%; padding: 0.4rem; border: 1px solid #3498db; border-radius: 4px;">`;
                startDateEl.classList.add('editable');
                
                // Replace text with date input for end date
                const endIso = endDateEl.dataset.isoDate || '';
                endDateEl.innerHTML = `<input type="date" id="endDateInput" value="${endIso}" style="width: 100%; padding: 0.4rem; border: 1px solid #3498db; border-radius: 4px;">`;
                endDateEl.classList.add('editable');
            } else {
                // Restore text display
                startDateEl.textContent = isoToDisplay(startDateEl.dataset.isoDate) || '-';
                startDateEl.classList.remove('editable');
                
                endDateEl.textContent = isoToDisplay(endDateEl.dataset.isoDate) || '-';
                endDateEl.classList.remove('editable');
            }
            
            // Make table cells editable
            const cells = document.querySelectorAll('#certItemsBody .editable-cell');
            cells.forEach(cell => {
                if (isEditMode) {
                    cell.contentEditable = 'true';
                    cell.classList.add('editing');
                } else {
                    cell.contentEditable = 'false';
                    cell.classList.remove('editing');
                }
            });
            
            updateEditButtons();
            hideElement('saveSuccess');
        }
        
        // Update edit button visibility
        function updateEditButtons() {
            if (isEditMode) {
                hideElement('editBtn');
                hideElement('saveDatabaseBtn');
                showElement('saveBtn');
                showElement('cancelBtn');
            } else {
                showElement('editBtn');
                showElement('saveDatabaseBtn');
                hideElement('saveBtn');
                hideElement('cancelBtn');
            }
        }
        
        // Save changes
        function saveChanges() {
            // Collect data from header fields (use backend field names: mida_no, exemption_start, exemption_end)
            parsedCertificateData.mida_no = document.getElementById('certNumber').textContent.trim();
            parsedCertificateData.company_name = document.getElementById('certCompany').textContent.trim();
            
            // Get dates from date inputs (they return ISO format YYYY-MM-DD)
            const startDateInput = document.getElementById('startDateInput');
            const endDateInput = document.getElementById('endDateInput');
            
            const startDateValue = startDateInput ? startDateInput.value : '';
            const endDateValue = endDateInput ? endDateInput.value : '';
            
            // Update data attributes for display later
            document.getElementById('certStartDate').dataset.isoDate = startDateValue;
            document.getElementById('certEndDate').dataset.isoDate = endDateValue;
            
            parsedCertificateData.exemption_start = startDateValue || null;
            parsedCertificateData.exemption_end = endDateValue || null;
            
            // Collect data from items table
            const rows = document.querySelectorAll('#certItemsBody tr');
            parsedCertificateData.items = [];
            
            rows.forEach((row, index) => {
                if (row.dataset.index !== undefined) {
                    const portKlangVal = row.querySelector('[data-field="port_klang_qty"]').textContent.trim();
                    const kliaVal = row.querySelector('[data-field="klia_qty"]').textContent.trim();
                    const bukitKayuHitamVal = row.querySelector('[data-field="bukit_kayu_hitam_qty"]').textContent.trim();
                    
                    const item = {
                        line_no: parseInt(row.querySelector('[data-field="line_no"]').textContent.trim()) || index + 1,
                        hs_code: row.querySelector('[data-field="hs_code"]').textContent.trim(),
                        item_name: row.querySelector('[data-field="item_name"]').textContent.trim(),
                        approved_quantity: parseFloat(row.querySelector('[data-field="approved_quantity"]').textContent.trim()) || null,
                        uom: row.querySelector('[data-field="uom"]').textContent.trim(),
                        station_split: {
                            PORT_KLANG: portKlangVal ? parseFloat(portKlangVal) : null,
                            KLIA: kliaVal ? parseFloat(kliaVal) : null,
                            BUKIT_KAYU_HITAM: bukitKayuHitamVal ? parseFloat(bukitKayuHitamVal) : null
                        }
                    };
                    parsedCertificateData.items.push(item);
                }
            });
            
            // Exit edit mode (toggle will flip isEditMode from true to false)
            toggleEditMode();
            
            // Update raw JSON display
            document.getElementById('parserRawResult').textContent = JSON.stringify(parsedCertificateData, null, 2);
            
            // Validate missing required fields after save
            validateMissingRequiredFields();
            
            // Validate quantity discrepancies after save
            validateQuantityDiscrepancies();
            
            // Show success message
            showElement('saveSuccess');
            
            // Hide success after 3 seconds
            setTimeout(() => {
                hideElement('saveSuccess');
            }, 3000);
        }
        
        // Cancel edit - restore original data and exit edit mode
        function cancelEdit() {
            // Restore original data from the snapshot taken when edit mode started
            parsedCertificateData = JSON.parse(JSON.stringify(originalCertificateData));
            
            // Exit edit mode
            isEditMode = false;
            
            // Re-render the display with the original data
            displayParsedCertificate(parsedCertificateData);
        }
        
        // Show save to database confirmation modal
        async function showSaveConfirmation() {
            // First check for missing required fields - this blocks save completely
            const missingCount = validateMissingRequiredFields();
            
            if (missingCount > 0) {
                // Show error modal instead of confirmation
                document.getElementById('missingDataErrorModal').classList.add('active');
                return;
            }
            
            // Check if certificate number already exists in database
            const certNumber = document.getElementById('certNumber').textContent.trim();
            if (certNumber && certNumber !== '-') {
                showElement('parserLoading');
                try {
                    const response = await fetch(`${API_BASE}/api/mida/certificates/check/${encodeURIComponent(certNumber)}`);
                    const data = await response.json();
                    
                    if (data.exists) {
                        hideElement('parserLoading');
                        // Show duplicate certificate warning modal
                        document.getElementById('duplicateCertNumber').textContent = certNumber;
                        document.getElementById('duplicateCertStatus').textContent = data.status;
                        document.getElementById('duplicateCertCompany').textContent = data.company_name || 'N/A';
                        document.getElementById('duplicateCertModal').classList.add('active');
                        return;
                    }
                } catch (error) {
                    console.error('Error checking certificate:', error);
                    // Continue with save if check fails
                } finally {
                    hideElement('parserLoading');
                }
            }
            
            // No missing data and no duplicate, show normal confirmation
            document.getElementById('confirmModal').classList.add('active');
        }
        
        // Hide confirmation modal
        function hideConfirmModal() {
            document.getElementById('confirmModal').classList.remove('active');
        }
        
        // Hide missing data error modal
        function hideMissingDataModal() {
            document.getElementById('missingDataErrorModal').classList.remove('active');
        }
        
        // Hide duplicate certificate modal
        function hideDuplicateCertModal() {
            document.getElementById('duplicateCertModal').classList.remove('active');
        }
        
        // Hide discrepancy confirmation modal
        function hideDiscrepancyModal() {
            document.getElementById('discrepancyConfirmModal').classList.remove('active');
        }
        
        // Save to database after confirmation
        function saveToDatabaseConfirmed() {
            hideConfirmModal();
            
            // Check if there are discrepancies
            const discrepancyCount = validateQuantityDiscrepancies();
            
            if (discrepancyCount > 0) {
                // Show additional warning modal for discrepancies
                document.getElementById('discrepancyConfirmModal').classList.add('active');
                return;
            }
            
            // Proceed with database save
            proceedWithDatabaseSave();
        }
        
        // Final save after discrepancy warning acknowledged
        async function proceedWithDatabaseSave() {
            hideDiscrepancyModal();
            
            // Show loading state
            showElement('parserLoading');
            document.getElementById('saveDatabaseBtn').disabled = true;
            
            try {
                // Build the request payload in the format expected by the API
                const payload = buildDatabaseSavePayload();
                
                console.log('Saving to database:', payload);
                
                const response = await fetch(`${API_BASE}/api/mida/certificates/draft`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });
                
                // Handle non-JSON error responses (like plain text "Internal Server Error")
                let data;
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    const text = await response.text();
                    data = { detail: text || `Server error (${response.status})` };
                }
                
                if (!response.ok) {
                    // Handle specific error cases
                    if (response.status === 409) {
                        // Certificate already exists - duplicates not allowed
                        showDatabaseSaveError(
                            'Certificate Already Exists',
                            `Certificate "${payload.header.certificate_number}" already exists in the database. Duplicate certificates are not allowed. Please use a different certificate number or view the existing certificate in the Database View tab.`
                        );
                    } else if (response.status === 422) {
                        // Validation error
                        const errorMsg = data.detail?.[0]?.msg || data.detail || 'Validation error';
                        showDatabaseSaveError('Validation Error', errorMsg);
                    } else if (response.status === 500) {
                        // Internal server error - show more helpful message
                        console.error('Server error details:', data);
                        showDatabaseSaveError('Server Error', 'An internal server error occurred. Please check the server logs for details.');
                    } else {
                        showDatabaseSaveError('Save Failed', data.detail || 'An error occurred while saving to the database.');
                    }
                    return;
                }
                
                // Success! Show success modal
                showDatabaseSaveSuccess(data, false);  // Always a new certificate now
                
            } catch (error) {
                console.error('Error saving to database:', error);
                showDatabaseSaveError('Connection Error', 'Error connecting to server: ' + error.message);
            } finally {
                hideElement('parserLoading');
                document.getElementById('saveDatabaseBtn').disabled = false;
            }
        }
        
        // Build the payload for database save API
        function buildDatabaseSavePayload() {
            // Get header values
            const certNumber = document.getElementById('certNumber').textContent.trim();
            const company = document.getElementById('certCompany').textContent.trim();
            const startDateEl = document.getElementById('certStartDate');
            const endDateEl = document.getElementById('certEndDate');
            
            // Get dates from data attributes (ISO format)
            let startDate = startDateEl.dataset.isoDate || null;
            let endDate = endDateEl.dataset.isoDate || null;
            
            // If empty string, convert to null
            if (startDate === '') startDate = null;
            if (endDate === '') endDate = null;
            
            // Get source filename from the file input
            const fileInput = document.getElementById('pdfInput');
            const sourceFilename = fileInput.files[0]?.name || null;
            
            // Build items array from the table
            const items = [];
            const rows = document.querySelectorAll('#certItemsBody tr[data-index]');
            
            rows.forEach((row) => {
                const lineNoText = row.querySelector('[data-field="line_no"]')?.textContent.trim() || '';
                const hsCode = row.querySelector('[data-field="hs_code"]')?.textContent.trim() || '';
                const itemName = row.querySelector('[data-field="item_name"]')?.textContent.trim() || '';
                const approvedQtyText = row.querySelector('[data-field="approved_quantity"]')?.textContent.trim() || '';
                const uom = row.querySelector('[data-field="uom"]')?.textContent.trim() || '';
                const portKlangText = row.querySelector('[data-field="port_klang_qty"]')?.textContent.trim() || '';
                const kliaText = row.querySelector('[data-field="klia_qty"]')?.textContent.trim() || '';
                const bukitKayuHitamText = row.querySelector('[data-field="bukit_kayu_hitam_qty"]')?.textContent.trim() || '';
                
                const item = {
                    line_no: parseInt(lineNoText) || (items.length + 1),
                    hs_code: hsCode,
                    item_name: itemName,
                    approved_quantity: approvedQtyText ? parseFloat(approvedQtyText) : null,
                    uom: uom,
                    port_klang_qty: portKlangText ? parseFloat(portKlangText) : null,
                    klia_qty: kliaText ? parseFloat(kliaText) : null,
                    bukit_kayu_hitam_qty: bukitKayuHitamText ? parseFloat(bukitKayuHitamText) : null,
                };
                
                items.push(item);
            });
            
            // Build the full payload
            return {
                header: {
                    certificate_number: certNumber,
                    company_name: company,
                    exemption_start_date: startDate,
                    exemption_end_date: endDate,
                    source_filename: sourceFilename,
                },
                items: items,
                raw_ocr_json: parsedCertificateData, // Store the original OCR data for reference
            };
        }
        
        // Show database save success modal
        function showDatabaseSaveSuccess(savedCertificate, isUpdate) {
            const modal = document.getElementById('saveSuccessModal');
            const titleEl = document.getElementById('saveSuccessTitle');
            const messageEl = document.getElementById('saveSuccessMessage');
            const detailsEl = document.getElementById('saveSuccessDetails');
            
            titleEl.textContent = isUpdate ? '‚úÖ Certificate Updated' : '‚úÖ Certificate Saved';
            messageEl.textContent = isUpdate 
                ? 'The certificate has been updated in the database.'
                : 'The certificate has been saved to the database.';
            
            detailsEl.innerHTML = `
                <div class="info-card" style="margin-top: 1rem;">
                    <div class="info-card-grid">
                        <div class="info-card-item">
                            <span class="info-card-label">Certificate Number</span>
                            <span class="info-card-value">${escapeHtml(savedCertificate.certificate_number)}</span>
                        </div>
                        <div class="info-card-item">
                            <span class="info-card-label">Company Name</span>
                            <span class="info-card-value">${escapeHtml(savedCertificate.company_name)}</span>
                        </div>
                        <div class="info-card-item">
                            <span class="info-card-label">Status</span>
                            <span class="info-card-value"><span class="status-badge ${savedCertificate.status}">${savedCertificate.status}</span></span>
                        </div>
                        <div class="info-card-item">
                            <span class="info-card-label">Items Saved</span>
                            <span class="info-card-value">${savedCertificate.items?.length || 0}</span>
                        </div>
                    </div>
                </div>
                <p style="margin-top: 1rem; font-size: 0.9rem; color: #7f8c8d;">
                    You can view this certificate in the <strong>Database View</strong> tab.
                </p>
            `;
            
            modal.classList.add('active');
        }
        
        // Hide database save success modal
        function hideSaveSuccessModal() {
            document.getElementById('saveSuccessModal').classList.remove('active');
        }
        
        // Show database save error modal
        function showDatabaseSaveError(title, message) {
            const modal = document.getElementById('saveErrorModal');
            document.getElementById('saveErrorTitle').textContent = '‚ùå ' + title;
            document.getElementById('saveErrorMessage').textContent = message;
            modal.classList.add('active');
        }
        
        // Hide database save error modal
        function hideSaveErrorModal() {
            document.getElementById('saveErrorModal').classList.remove('active');
        }
        
        // Show parser error
        function showParserError(message) {
            document.getElementById('parserErrorText').textContent = message;
            showElement('parserError');
        }
        
        // ==========================================
        // Database View - Hierarchical Data Browser
        // ==========================================
        
        // State management for database view
        const dbState = {
            certificates: [],
            certificatesTotal: 0,
            certificatesPage: 1,
            certificatesPerPage: 100,
            
            selectedCertificate: null,
            items: [],
            itemsTotal: 0,
            itemsPage: 1,
            itemsPerPage: 100,
            quantityView: 'approved', // 'approved' or 'remaining'
            
            selectedItem: null,
            imports: [],
            importsTotal: 0,
            importsPage: 1,
            importsPerPage: 100,
            currentPort: 'all'
        };
        
        // Initialize database view when tab is switched
        function initDatabaseView() {
            loadCertificates();
        }
        
        // Format number with thousands separator and decimal places
        function formatNumber(value, decimals = 3) {
            if (value === null || value === undefined || value === '') return '-';
            const num = parseFloat(value);
            if (isNaN(num)) return '-';
            return num.toLocaleString('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: decimals
            });
        }
        
        // Format date from ISO to display format
        function formatDate(isoDate) {
            if (!isoDate) return '-';
            const date = new Date(isoDate);
            if (isNaN(date.getTime())) return isoDate;
            return date.toLocaleDateString('en-GB', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }
        
        // Get CSS class for quantity status
        function getStatusClass(status) {
            switch (status) {
                case 'normal': return 'qty-status-normal';
                case 'warning': return 'qty-status-warning';
                case 'depleted': return 'qty-status-depleted';
                case 'overdrawn': return 'qty-status-overdrawn';
                default: return '';
            }
        }
        
        // Get display name for port
        function getPortDisplayName(port) {
            switch (port) {
                case 'port_klang': return 'Port Klang';
                case 'klia': return 'KLIA';
                case 'bukit_kayu_hitam': return 'Bukit Kayu Hitam';
                default: return port;
            }
        }
        
        // Show database error
        function showDbError(message) {
            document.getElementById('dbErrorText').textContent = message;
            showElement('dbError');
        }
        
        // Hide database error
        function hideDbError() {
            hideElement('dbError');
        }
        
        // Update breadcrumb navigation
        function updateBreadcrumb(level, data = {}) {
            const breadcrumb = document.getElementById('dbBreadcrumb');
            let html = '';
            
            if (level === 'certificates') {
                html = '<span class="breadcrumb-item active">üìã Certificates</span>';
            } else if (level === 'items') {
                html = `
                    <span class="breadcrumb-item" onclick="dbNavigateToCertificates()">üìã Certificates</span>
                    <span class="breadcrumb-separator">‚Ä∫</span>
                    <span class="breadcrumb-item active">üì¶ ${escapeHtml(data.certificateNumber || 'Items')}</span>
                `;
            } else if (level === 'imports') {
                html = `
                    <span class="breadcrumb-item" onclick="dbNavigateToCertificates()">üìã Certificates</span>
                    <span class="breadcrumb-separator">‚Ä∫</span>
                    <span class="breadcrumb-item" onclick="dbNavigateToItems()">üì¶ ${escapeHtml(data.certificateNumber || 'Items')}</span>
                    <span class="breadcrumb-separator">‚Ä∫</span>
                    <span class="breadcrumb-item active">üì• ${escapeHtml(data.itemName || 'Imports')}</span>
                `;
            }
            
            breadcrumb.innerHTML = html;
        }
        
        // Render pagination controls
        function renderPagination(containerId, infoId, currentPage, totalItems, perPage, onPageChange) {
            const container = document.getElementById(containerId);
            const info = document.getElementById(infoId);
            const totalPages = Math.ceil(totalItems / perPage);
            
            // Always show pagination bar if there are items (for rows-per-page dropdown)
            if (totalItems === 0) {
                container.classList.add('hidden');
                return;
            }
            
            container.classList.remove('hidden');
            
            const startItem = (currentPage - 1) * perPage + 1;
            const endItem = Math.min(currentPage * perPage, totalItems);
            info.textContent = `Showing ${startItem}-${endItem} of ${totalItems}`;
            
            const controls = container.querySelector('.pagination-controls');
            let html = '';
            
            // Hide page controls if only one page
            if (totalPages <= 1) {
                controls.innerHTML = '';
                return;
            }
            
            // Previous button
            html += `<button class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="${onPageChange}(${currentPage - 1})">‚Üê Prev</button>`;
            
            // Page numbers
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            if (startPage > 1) {
                html += `<button class="pagination-page" onclick="${onPageChange}(1)">1</button>`;
                if (startPage > 2) html += '<span style="color: #7f8c8d;">...</span>';
            }
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="pagination-page ${i === currentPage ? 'active' : ''}" onclick="${onPageChange}(${i})">${i}</button>`;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) html += '<span style="color: #7f8c8d;">...</span>';
                html += `<button class="pagination-page" onclick="${onPageChange}(${totalPages})">${totalPages}</button>`;
            }
            
            // Next button
            html += `<button class="pagination-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="${onPageChange}(${currentPage + 1})">Next ‚Üí</button>`;
            
            controls.innerHTML = html;
        }
        
        // Render empty state
        function renderEmptyState(tbodyId, colspan, icon, text, subtext) {
            const tbody = document.getElementById(tbodyId);
            tbody.innerHTML = `
                <tr>
                    <td colspan="${colspan}">
                        <div class="empty-state">
                            <div class="empty-state-icon">${icon}</div>
                            <div class="empty-state-text">${text}</div>
                            <div class="empty-state-subtext">${subtext}</div>
                        </div>
                    </td>
                </tr>
            `;
        }
        
        // ==========================================
        // Level 1: Certificates
        // ==========================================
        
        async function loadCertificates(page = 1) {
            dbState.certificatesPage = page;
            hideDbError();
            showElement('dbLoading');
            
            try {
                const offset = (page - 1) * dbState.certificatesPerPage;
                const response = await fetch(`${API_BASE}/api/mida/certificates?limit=${dbState.certificatesPerPage}&offset=${offset}`);
                
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.detail || 'Failed to load certificates');
                }
                
                const data = await response.json();
                dbState.certificates = data.items || [];
                dbState.certificatesTotal = data.total || 0;
                
                // Update the rows-per-page dropdown to reflect current setting
                const perPageSelect = document.getElementById('certificatesPerPageSelect');
                if (perPageSelect) perPageSelect.value = dbState.certificatesPerPage;
                
                renderCertificatesTable();
                renderPagination(
                    'certificatesPagination',
                    'certificatesPaginationInfo',
                    dbState.certificatesPage,
                    dbState.certificatesTotal,
                    dbState.certificatesPerPage,
                    'goToCertificatesPage'
                );
                
            } catch (error) {
                console.error('Error loading certificates:', error);
                showDbError('Error loading certificates: ' + error.message);
            } finally {
                hideElement('dbLoading');
            }
        }
        
        function goToCertificatesPage(page) {
            loadCertificates(page);
        }
        
        function changeCertificatesPerPage(value) {
            const newValue = parseInt(value);
            if (newValue === dbState.certificatesPerPage) return; // Prevent infinite loop
            dbState.certificatesPerPage = newValue;
            dbState.certificatesPage = 1; // Reset to first page
            loadCertificates(1);
        }
        
        function renderCertificatesTable() {
            const tbody = document.getElementById('certificatesTableBody');
            
            if (dbState.certificates.length === 0) {
                renderEmptyState(
                    'certificatesTableBody',
                    6,
                    'üìã',
                    'No certificates found',
                    'Upload and parse a MIDA certificate to get started.'
                );
                return;
            }
            
            tbody.innerHTML = '';
            
            dbState.certificates.forEach(cert => {
                const row = document.createElement('tr');
                row.className = 'clickable-row';
                row.dataset.id = cert.id;
                row.onclick = () => selectCertificate(cert);
                
                const statusBadge = `<span class="status-badge ${cert.status}">${cert.status}</span>`;
                
                row.innerHTML = `
                    <td>${escapeHtml(cert.certificate_number || '-')}</td>
                    <td>${escapeHtml(cert.company_name || '-')}</td>
                    <td>${formatDate(cert.exemption_start_date)}</td>
                    <td>${formatDate(cert.exemption_end_date)}</td>
                    <td>${statusBadge}</td>
                    <td>${cert.items?.length || '-'}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function selectCertificate(cert) {
            dbState.selectedCertificate = cert;
            dbState.itemsPage = 1;
            
            // Update info card
            document.getElementById('infoCertNumber').textContent = cert.certificate_number || '-';
            document.getElementById('infoCertCompany').textContent = cert.company_name || '-';
            document.getElementById('infoCertPeriod').textContent = 
                `${formatDate(cert.exemption_start_date)} - ${formatDate(cert.exemption_end_date)}`;
            document.getElementById('infoCertStatus').innerHTML = 
                `<span class="status-badge ${cert.status}">${cert.status}</span>`;
            
            // Update breadcrumb
            updateBreadcrumb('items', { certificateNumber: cert.certificate_number });
            
            // Show items view
            hideElement('certificatesView');
            showElement('itemsView');
            
            // Load items for this certificate
            loadCertificateItems(cert.id);
        }
        
        // ==========================================
        // Level 2: Certificate Items
        // ==========================================
        
        async function loadCertificateItems(certificateId, page = 1) {
            dbState.itemsPage = page;
            hideDbError();
            showElement('dbLoading');
            
            try {
                // Use the balances endpoint with server-side pagination
                const offset = (page - 1) * dbState.itemsPerPage;
                const response = await fetch(`${API_BASE}/api/mida/imports/balances?certificate_id=${certificateId}&limit=${dbState.itemsPerPage}&offset=${offset}`);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `Server error: ${response.status}`);
                }
                
                const data = await response.json();
                dbState.items = data.items || data || [];
                dbState.itemsTotal = data.total || dbState.items.length;
                
                // Update the rows-per-page dropdown to reflect current setting (without triggering onchange)
                const perPageSelect = document.getElementById('itemsPerPageSelect');
                if (perPageSelect && perPageSelect.value !== String(dbState.itemsPerPage)) {
                    perPageSelect.value = dbState.itemsPerPage;
                }
                
                renderItemsTable();
                
                // Render pagination using server-side total
                renderPagination(
                    'itemsPagination',
                    'itemsPaginationInfo',
                    dbState.itemsPage,
                    dbState.itemsTotal,
                    dbState.itemsPerPage,
                    'goToItemsPage'
                );
                
            } catch (error) {
                console.error('Error loading items:', error);
                const errorMsg = error.message || (typeof error === 'string' ? error : 'Unknown error');
                showDbError('Error loading items: ' + errorMsg);
            } finally {
                hideElement('dbLoading');
            }
        }
        
        function goToItemsPage(page) {
            // Server-side pagination - re-fetch data from server
            loadCertificateItems(dbState.selectedCertificate.id, page);
        }
        
        function changeItemsPerPage(value) {
            const newValue = parseInt(value);
            if (newValue === dbState.itemsPerPage) return; // Prevent infinite loop
            dbState.itemsPerPage = newValue;
            dbState.itemsPage = 1; // Reset to first page
            loadCertificateItems(dbState.selectedCertificate.id, 1);
        }
        
        function paginateArray(array, page, perPage) {
            const start = (page - 1) * perPage;
            return array.slice(start, start + perPage);
        }
        
        function toggleQuantityView(view) {
            dbState.quantityView = view;
            
            // Update toggle buttons
            document.getElementById('toggleApproved').classList.toggle('active', view === 'approved');
            document.getElementById('toggleRemaining').classList.toggle('active', view === 'remaining');
            
            // Update table header
            const headerCell = document.querySelector('#itemsTable thead th:nth-child(5)');
            headerCell.textContent = view === 'approved' ? 'Total Qty' : 'Remaining Qty';
            
            // Re-render table
            renderItemsTable();
        }
        
        function renderItemsTable() {
            const tbody = document.getElementById('itemsTableBody');
            
            if (dbState.items.length === 0) {
                renderEmptyState(
                    'itemsTableBody',
                    9,
                    'üì¶',
                    'No items found for this certificate',
                    'This certificate has no associated items.'
                );
                return;
            }
            
            tbody.innerHTML = '';
            // Server-side pagination: items are already paginated by the API
            
            dbState.items.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'clickable-row';
                row.dataset.id = item.item_id;
                row.onclick = () => selectItem(item);
                
                const statusClass = getStatusClass(item.quantity_status);
                const statusBadge = `<span class="status-badge ${item.quantity_status || 'normal'}">${item.quantity_status || 'normal'}</span>`;
                
                // Determine which quantities to show based on toggle
                const isApproved = dbState.quantityView === 'approved';
                const totalQty = isApproved ? item.approved_quantity : item.remaining_quantity;
                const portKlangQty = isApproved ? item.port_klang_qty : item.remaining_port_klang;
                const kliaQty = isApproved ? item.klia_qty : item.remaining_klia;
                const bukitQty = isApproved ? item.bukit_kayu_hitam_qty : item.remaining_bukit_kayu_hitam;
                
                // Apply status coloring to remaining values regardless of toggle view
                const applyStatusColor = (value, status) => {
                    const statusCls = getStatusClass(status);
                    return statusCls ? `<span class="${statusCls}">${formatNumber(value)}</span>` : formatNumber(value);
                };
                
                row.innerHTML = `
                    <td>${item.line_no || '-'}</td>
                    <td>${escapeHtml(item.hs_code || item.item_hs_code || '-')}</td>
                    <td>${escapeHtml(item.item_name || '-')}</td>
                    <td>${escapeHtml(item.uom || item.item_uom || '-')}</td>
                    <td class="number-cell ${statusClass}">${formatNumber(totalQty)}</td>
                    <td class="number-cell ${statusClass}">${formatNumber(portKlangQty)}</td>
                    <td class="number-cell ${statusClass}">${formatNumber(kliaQty)}</td>
                    <td class="number-cell ${statusClass}">${formatNumber(bukitQty)}</td>
                    <td>${statusBadge}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function selectItem(item) {
            dbState.selectedItem = item;
            dbState.importsPage = 1;
            dbState.currentPort = 'all';
            
            // Update info card
            document.getElementById('infoItemCert').textContent = 
                dbState.selectedCertificate?.certificate_number || item.certificate_number || '-';
            document.getElementById('infoItemHsCode').textContent = item.hs_code || item.item_hs_code || '-';
            document.getElementById('infoItemName').textContent = item.item_name || '-';
            document.getElementById('infoItemUom').textContent = item.uom || item.item_uom || '-';
            
            // Update breadcrumb
            updateBreadcrumb('imports', {
                certificateNumber: dbState.selectedCertificate?.certificate_number || item.certificate_number,
                itemName: item.item_name || `Line ${item.line_no}`
            });
            
            // Reset port filter buttons
            document.querySelectorAll('.port-filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.port === 'all');
            });
            
            // Show imports view
            hideElement('itemsView');
            showElement('importsView');
            
            // Load imports for this item
            loadImportRecords(item.item_id);
        }
        
        // ==========================================
        // Level 3: Import Records
        // ==========================================
        
        async function loadImportRecords(itemId, port = 'all', page = 1) {
            dbState.importsPage = page;
            dbState.currentPort = port;
            hideDbError();
            showElement('dbLoading');
            
            try {
                const offset = (page - 1) * dbState.importsPerPage;
                let url = `${API_BASE}/api/mida/imports/history/item/${itemId}`;
                const params = [`limit=${dbState.importsPerPage}`, `offset=${offset}`];
                
                if (port !== 'all') {
                    params.push(`port=${port}`);
                }
                
                url += '?' + params.join('&');
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.detail || 'Failed to load import records');
                }
                
                const data = await response.json();
                dbState.imports = data.imports || [];
                dbState.importsTotal = data.total || dbState.imports.length;
                
                // Update the rows-per-page dropdown to reflect current setting
                const perPageSelect = document.getElementById('importsPerPageSelect');
                if (perPageSelect) perPageSelect.value = dbState.importsPerPage;
                
                renderImportsTable();
                
                // Handle pagination
                renderPagination(
                    'importsPagination',
                    'importsPaginationInfo',
                    dbState.importsPage,
                    dbState.importsTotal,
                    dbState.importsPerPage,
                    'goToImportsPage'
                );
                
            } catch (error) {
                console.error('Error loading imports:', error);
                showDbError('Error loading import records: ' + error.message);
            } finally {
                hideElement('dbLoading');
            }
        }
        
        function goToImportsPage(page) {
            // Server-side pagination - re-fetch data from server
            loadImportRecords(dbState.selectedItem.item_id, dbState.currentPort, page);
        }
        
        function changeImportsPerPage(value) {
            const newValue = parseInt(value);
            if (newValue === dbState.importsPerPage) return; // Prevent infinite loop
            dbState.importsPerPage = newValue;
            dbState.importsPage = 1; // Reset to first page
            loadImportRecords(dbState.selectedItem.item_id, dbState.currentPort, 1);
        }
        
        function filterByPort(port) {
            // Update button states
            document.querySelectorAll('.port-filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.port === port);
            });
            
            // Reload with filter
            loadImportRecords(dbState.selectedItem.item_id, port, 1);
        }
        
        function renderImportsTable() {
            const tbody = document.getElementById('importsTableBody');
            
            if (dbState.imports.length === 0) {
                const portName = dbState.currentPort === 'all' ? 'any port' : getPortDisplayName(dbState.currentPort);
                renderEmptyState(
                    'importsTableBody',
                    8,
                    'üì•',
                    'No import records found',
                    `There are no import records for this item from ${portName}.`
                );
                return;
            }
            
            tbody.innerHTML = '';
            // Server-side pagination: imports are already paginated by the API
            
            dbState.imports.forEach(record => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${formatDate(record.import_date)}</td>
                    <td>${escapeHtml(record.invoice_number || '-')}</td>
                    <td>${record.invoice_line || '-'}</td>
                    <td>${getPortDisplayName(record.port)}</td>
                    <td class="number-cell">${formatNumber(record.quantity_imported)}</td>
                    <td class="number-cell">${formatNumber(record.balance_before)}</td>
                    <td class="number-cell">${formatNumber(record.balance_after)}</td>
                    <td>${escapeHtml(record.remarks || '-')}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // ==========================================
        // Navigation
        // ==========================================
        
        function dbNavigateToCertificates() {
            dbState.selectedCertificate = null;
            dbState.selectedItem = null;
            
            updateBreadcrumb('certificates');
            
            hideElement('itemsView');
            hideElement('importsView');
            showElement('certificatesView');
            
            // Reload certificates to ensure fresh data
            loadCertificates(dbState.certificatesPage);
        }
        
        function dbNavigateToItems() {
            dbState.selectedItem = null;
            
            updateBreadcrumb('items', {
                certificateNumber: dbState.selectedCertificate?.certificate_number
            });
            
            hideElement('importsView');
            showElement('itemsView');
        }
        
        // Override switchTab to initialize database view
        const originalSwitchTab = switchTab;
        switchTab = function(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            document.querySelector(`.tab-content#${tabName}-tab`).classList.add('active');
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            // Initialize database view when switching to it
            if (tabName === 'database') {
                initDatabaseView();
            }
        };
    </script>
    
    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal-overlay">
        <div class="modal-content">
            <h3>üíæ Save to Database</h3>
            <p>Are you sure you want to save this certificate data to the database?</p>
            <p>Please confirm that all the information is correct before proceeding.</p>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="hideConfirmModal()">Cancel</button>
                <button class="btn-database" onclick="saveToDatabaseConfirmed()">Yes, Save to Database</button>
            </div>
        </div>
    </div>
    
    <!-- Missing Data Error Modal (Blocks Save) -->
    <div id="missingDataErrorModal" class="modal-overlay">
        <div class="modal-content">
            <h3>‚ùå Cannot Save - Required Data Missing</h3>
            <p style="color: #c0392b; font-weight: 600;">There are required fields that are missing.</p>
            <p>You cannot save to the database until all required fields are filled in:</p>
            <ul style="color: #721c24; margin: 0.5rem 0 1rem 1.5rem;">
                <li>Certificate Number</li>
                <li>Company Name</li>
                <li>Exemption Start Date</li>
                <li>Exemption End Date</li>
                <li>HS Code (for each item)</li>
                <li>Item Name (for each item)</li>
                <li>Approved Quantity (for each item)</li>
                <li>UOM (for each item)</li>
            </ul>
            <p>Please review and complete the missing fields (highlighted in red) before trying again.</p>
            <div class="modal-buttons">
                <button class="btn-edit" onclick="hideMissingDataModal()">OK, I'll Fix It</button>
            </div>
        </div>
    </div>
    
    <!-- Discrepancy Confirmation Modal -->
    <div id="discrepancyConfirmModal" class="modal-overlay">
        <div class="modal-content">
            <h3>‚ö†Ô∏è Quantity Discrepancies Detected</h3>
            <p style="color: #e74c3c; font-weight: 600;">There are unchecked quantity discrepancies in the certificate data.</p>
            <p>The Approved Quantity does not match the sum of station quantities (Port Klang + KLIA + Bukit Kayu Hitam) for one or more rows.</p>
            <p>Are you sure you want to proceed with saving to the database anyway?</p>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="hideDiscrepancyModal()">Cancel</button>
                <button class="btn-cancel" onclick="proceedWithDatabaseSave()">Yes, Save Anyway</button>
            </div>
        </div>
    </div>
    
    <!-- Database Save Success Modal -->
    <div id="saveSuccessModal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="saveSuccessTitle">‚úÖ Certificate Saved</h3>
            <p id="saveSuccessMessage">The certificate has been saved to the database.</p>
            <div id="saveSuccessDetails"></div>
            <div class="modal-buttons">
                <button class="btn-database" onclick="hideSaveSuccessModal()">OK</button>
            </div>
        </div>
    </div>
    
    <!-- Database Save Error Modal -->
    <div id="saveErrorModal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="saveErrorTitle">‚ùå Save Failed</h3>
            <p id="saveErrorMessage">An error occurred while saving to the database.</p>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="hideSaveErrorModal()">OK</button>
            </div>
        </div>
    </div>
    
    <!-- Duplicate Certificate Warning Modal -->
    <div id="duplicateCertModal" class="modal-overlay">
        <div class="modal-content">
            <h3>‚ö†Ô∏è Certificate Already Exists</h3>
            <p style="color: #e74c3c; font-weight: 600;">A certificate with this number already exists in the database.</p>
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                <p style="margin: 0.25rem 0;"><strong>Certificate Number:</strong> <span id="duplicateCertNumber"></span></p>
                <p style="margin: 0.25rem 0;"><strong>Status:</strong> <span id="duplicateCertStatus"></span></p>
                <p style="margin: 0.25rem 0;"><strong>Company:</strong> <span id="duplicateCertCompany"></span></p>
            </div>
            <p>Please change the certificate number before saving, or view the existing certificate in the Database View tab.</p>
            <div class="modal-buttons">
                <button class="btn-edit" onclick="hideDuplicateCertModal()">OK, I'll Change It</button>
            </div>
        </div>
    </div>
</body>
</html>
