<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIDA Certificate OCR & Converter</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            max-width: 1000px; 
            margin: 2rem auto; 
            padding: 0 1rem;
            background: #f5f5f5;
            color: #333;
        }
        h1 { color: #2c3e50; margin-bottom: 0.5rem; }
        h2 { color: #34495e; border-bottom: 2px solid #3498db; padding-bottom: 0.5rem; margin-top: 2rem; }
        h3 { color: #2c3e50; margin-top: 1.5rem; }
        
        .container { 
            background: white;
            border: 1px solid #ddd; 
            padding: 2rem; 
            border-radius: 8px; 
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #555;
        }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
        }
        .form-group input[type="file"] {
            padding: 0.5rem 0;
        }
        .form-group small {
            display: block;
            margin-top: 0.25rem;
            color: #888;
            font-style: italic;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        
        .row {
            display: flex;
            gap: 1rem;
        }
        .row .form-group {
            flex: 1;
        }
        
        pre { 
            background: #f8f9fa; 
            padding: 1rem; 
            overflow-x: auto; 
            border-radius: 4px;
            border: 1px solid #e9ecef;
            font-size: 0.85rem;
        }
        
        button { 
            padding: 0.75rem 1.5rem; 
            cursor: pointer;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: 600;
            transition: background 0.2s;
        }
        button:hover { background: #2980b9; }
        button:disabled { background: #bdc3c7; cursor: not-allowed; }
        
        .btn-secondary {
            background: #95a5a6;
        }
        .btn-secondary:hover { background: #7f8c8d; }
        
        /* Results section */
        .results-section { margin-top: 2rem; }
        
        .summary-stats {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .stat-card {
            flex: 1;
            background: #ecf0f1;
            padding: 1rem;
            border-radius: 4px;
            text-align: center;
        }
        .stat-card .number {
            font-size: 2rem;
            font-weight: bold;
            color: #2c3e50;
        }
        .stat-card .label {
            color: #7f8c8d;
            font-size: 0.85rem;
        }
        .stat-card.matched { background: #d5f4e6; }
        .stat-card.matched .number { color: #27ae60; }
        .stat-card.unmatched { background: #fdecea; }
        .stat-card.unmatched .number { color: #e74c3c; }
        
        /* Table styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 0.9rem;
        }
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #3498db;
            color: white;
            font-weight: 600;
        }
        tr:hover { background: #f8f9fa; }
        tr:nth-child(even) { background: #fafafa; }
        tr:nth-child(even):hover { background: #f0f0f0; }
        
        .match-score {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.85rem;
        }
        .match-score.high { background: #d5f4e6; color: #27ae60; }
        .match-score.medium { background: #fef3cd; color: #856404; }
        .match-score.low { background: #fdecea; color: #e74c3c; }
        
        /* Warnings section */
        .warnings-section {
            margin-top: 1.5rem;
        }
        .warning-item {
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
            border-left: 4px solid;
        }
        .warning-item.error {
            background: #fdecea;
            border-color: #e74c3c;
        }
        .warning-item.warning {
            background: #fef3cd;
            border-color: #f39c12;
        }
        .warning-item.info {
            background: #d6eaf8;
            border-color: #3498db;
        }
        .warning-item .invoice-item {
            font-weight: 600;
            color: #2c3e50;
        }
        .warning-item .reason {
            margin-top: 0.25rem;
            color: #555;
        }
        .warning-item .severity-badge {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            border-radius: 3px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
            margin-left: 0.5rem;
        }
        .severity-badge.error { background: #e74c3c; color: white; }
        .severity-badge.warning { background: #f39c12; color: white; }
        .severity-badge.info { background: #3498db; color: white; }
        
        /* Error message */
        .error-message {
            background: #fdecea;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
        }
        .error-message h4 {
            margin: 0 0 0.5rem 0;
            color: #721c24;
        }
        
        /* Loading state */
        .loading {
            text-align: center;
            padding: 2rem;
            color: #7f8c8d;
        }
        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #3498db;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 0.5rem;
            vertical-align: middle;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 0;
            margin-bottom: 0;
        }
        .tab {
            padding: 0.75rem 1.5rem;
            background: #ecf0f1;
            border: 1px solid #ddd;
            border-bottom: none;
            cursor: pointer;
            font-weight: 600;
            color: #7f8c8d;
            border-radius: 4px 4px 0 0;
        }
        .tab.active {
            background: white;
            color: #3498db;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        /* Hidden */
        .hidden { display: none; }
        
        /* View toggle buttons */
        .view-toggle {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .toggle-btn {
            padding: 0.5rem 1rem;
            background: #ecf0f1;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .toggle-btn:hover {
            background: #d5dbdb;
        }
        .toggle-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        /* Form flag badge */
        .form-flag-badge {
            display: inline-block;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        .form-flag-badge.form-d {
            background: #fdecea;
            color: #e74c3c;
        }
        .form-flag-badge.empty {
            background: #d5f4e6;
            color: #27ae60;
        }
        
        /* Total row styling */
        tr.total-row {
            background: #f8f9fa !important;
            font-weight: bold;
            border-top: 2px solid #3498db;
        }
        tr.total-row:hover {
            background: #f0f0f0 !important;
        }
        
        /* Certificate Parser Styles */
        .cert-header {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        .cert-header-field {
            display: flex;
            flex-direction: column;
        }
        .cert-header-field label {
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 0.25rem;
            font-weight: 600;
        }
        .cert-header-field .value {
            font-size: 1rem;
            color: #2c3e50;
            padding: 0.5rem;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            min-height: 38px;
        }
        .cert-header-field .value.editable {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        .cert-header-field input {
            font-size: 1rem;
            padding: 0.5rem;
            border: 1px solid #3498db;
            border-radius: 4px;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        /* Editable table cells */
        .editable-cell {
            transition: all 0.2s;
        }
        .editable-cell.editing {
            background: #fff3cd !important;
            border: 2px solid #3498db !important;
            padding: 0.5rem;
        }
        td[contenteditable="true"] {
            background: #fff3cd;
            border: 2px solid #3498db;
            outline: none;
        }
        td[contenteditable="true"]:focus {
            background: #fffef0;
        }
        
        /* Action buttons group */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        .btn-edit {
            background: #f39c12;
        }
        .btn-edit:hover { background: #e67e22; }
        .btn-save {
            background: #27ae60;
        }
        .btn-save:hover { background: #219a52; }
        .btn-cancel {
            background: #e74c3c;
        }
        .btn-cancel:hover { background: #c0392b; }
        .btn-database {
            background: #27ae60;
        }
        .btn-database:hover { background: #1e8449; }
        
        /* Confirmation Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        .modal-content h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        .modal-content p {
            color: #555;
            line-height: 1.6;
        }
        .modal-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }
        
        /* Parser results container */
        .parser-results {
            margin-top: 1.5rem;
        }
        
        /* Items table for parser */
        .items-table-container {
            overflow-x: auto;
            margin-top: 1rem;
        }
        .items-table th {
            white-space: nowrap;
        }
        .items-table td {
            min-width: 80px;
        }
        .items-table td:nth-child(3) {
            min-width: 200px;
        }
        
        /* Success message */
        .success-message {
            background: #d5f4e6;
            border: 1px solid #27ae60;
            color: #155724;
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
        }
        .success-message h4 {
            margin: 0 0 0.5rem 0;
            color: #155724;
        }
        
        /* Warnings badge */
        .warnings-badge {
            background: #fef3cd;
            color: #856404;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.85rem;
            margin-left: 0.5rem;
        }
    </style>
</head>
<body>
    <h1>üè≠ MIDA Certificate System</h1>
    
    <!-- Tabs -->
    <div class="tabs">
        <div class="tab active" onclick="switchTab('converter')">Invoice Converter</div>
        <div class="tab" onclick="switchTab('parser')">Certificate Parser</div>
    </div>
    
    <!-- Converter Tab -->
    <div id="converter-tab" class="tab-content active">
        <div class="container">
            <h2>üìÑ Invoice to MIDA Converter</h2>
            <p>Upload an invoice file (Excel .xls or .xlsx) and optionally match against a MIDA certificate.</p>
            
            <div class="form-group">
                <label for="invoiceFile">Invoice File</label>
                <input type="file" id="invoiceFile" accept=".xls,.xlsx">
            </div>
            
            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="midaMode" onchange="toggleMidaMode()">
                    <label for="midaMode" style="display: inline; margin-bottom: 0;">Enable MIDA Matching Mode</label>
                </div>
            </div>
            
            <div id="midaOptions" class="hidden">
                <div class="form-group">
                    <label for="midaCertNumber">MIDA Certificate Number</label>
                    <input type="text" id="midaCertNumber" placeholder="e.g., MIDA/2024/001">
                    <small>üìù Dropdown selection will be added later.</small>
                </div>
                
                <div class="row">
                    <div class="form-group">
                        <label for="matchMode">Match Mode</label>
                        <select id="matchMode">
                            <option value="fuzzy">Fuzzy (Recommended)</option>
                            <option value="exact">Exact</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="matchThreshold">Match Threshold</label>
                        <input type="number" id="matchThreshold" value="0.88" min="0" max="1" step="0.01">
                    </div>
                </div>
            </div>
            
            <button onclick="convertInvoice()" id="convertBtn">Convert Invoice</button>
            
            <!-- Results -->
            <div id="converterResults" class="results-section hidden">
                <!-- Summary Stats -->
                <div id="summaryStats" class="summary-stats"></div>
                
                <!-- Matched Items Table -->
                <div id="matchedItemsSection" class="hidden">
                    <h3>‚úÖ Matched Items (MIDA-Eligible)</h3>
                    <div style="overflow-x: auto;">
                        <table id="matchedItemsTable">
                            <thead>
                                <tr>
                                    <th>Line</th>
                                    <th>Parts Name</th>
                                    <th>Qty</th>
                                    <th>MIDA Line</th>
                                    <th>MIDA Item</th>
                                    <th>Remaining</th>
                                    <th>Score</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- All Invoice Items (Normal Mode) -->
                <div id="allItemsSection" class="hidden">
                    <div class="view-toggle">
                        <button id="viewFilteredBtn" class="toggle-btn active" onclick="switchToFilteredView()">
                            üìã Non-FORM-D Items Only
                        </button>
                        <button id="viewFullBtn" class="toggle-btn" onclick="switchToFullView()">
                            üìÑ All Items (incl. FORM-D & Total)
                        </button>
                    </div>
                    <h3 id="itemsTableTitle">üìã Invoice Items with Empty Form Flag (Non-FORM-D)</h3>
                    <div style="overflow-x: auto;">
                        <table id="allItemsTable">
                            <thead id="allItemsTableHead">
                                <tr>
                                    <th>Line</th>
                                    <th>Parts No</th>
                                    <th>Parts Name</th>
                                    <th>HS Code</th>
                                    <th>Qty</th>
                                    <th>Amount (USD)</th>
                                    <th>Net Wt (Kg)</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Warnings Section -->
                <div id="warningsSection" class="warnings-section hidden">
                    <h3>‚ö†Ô∏è Warnings</h3>
                    <div id="warningsList"></div>
                </div>
                
                <!-- Raw JSON -->
                <details style="margin-top: 1.5rem;">
                    <summary style="cursor: pointer; color: #7f8c8d;">Show Raw JSON Response</summary>
                    <pre id="rawResult"></pre>
                </details>
            </div>
            
            <!-- Error Display -->
            <div id="converterError" class="error-message hidden">
                <h4>‚ùå Error</h4>
                <p id="errorText"></p>
            </div>
            
            <!-- Loading -->
            <div id="converterLoading" class="loading hidden">Processing invoice...</div>
        </div>
    </div>
    
    <!-- Parser Tab -->
    <div id="parser-tab" class="tab-content">
        <div class="container">
            <h2>üîç MIDA Certificate Parser</h2>
            <p>Upload a MIDA certificate PDF to parse and extract data into an editable table.</p>
            
            <div class="form-group">
                <label for="pdfInput">Certificate PDF</label>
                <input type="file" id="pdfInput" accept=".pdf">
            </div>
            
            <button onclick="parseCertificate()" id="parseBtn">Parse Certificate</button>
            
            <!-- Loading -->
            <div id="parserLoading" class="loading hidden">Processing certificate...</div>
            
            <!-- Error Display -->
            <div id="parserError" class="error-message hidden">
                <h4>‚ùå Error</h4>
                <p id="parserErrorText"></p>
            </div>
            
            <!-- Parser Results -->
            <div id="parserResults" class="parser-results hidden">
                <h3>üìã Certificate Data 
                    <span id="warningsBadge" class="warnings-badge hidden"></span>
                </h3>
                
                <!-- Certificate Header Fields -->
                <div class="cert-header" id="certHeader">
                    <div class="cert-header-field">
                        <label>Certificate Number</label>
                        <div class="value" id="certNumber" data-field="certificate_number">-</div>
                    </div>
                    <div class="cert-header-field">
                        <label>Company Name</label>
                        <div class="value" id="certCompany" data-field="company_name">-</div>
                    </div>
                    <div class="cert-header-field">
                        <label>Exemption Start Date</label>
                        <div class="value" id="certStartDate" data-field="exemption_start_date">-</div>
                    </div>
                    <div class="cert-header-field">
                        <label>Exemption End Date</label>
                        <div class="value" id="certEndDate" data-field="exemption_end_date">-</div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button id="editBtn" class="btn-edit" onclick="toggleEditMode()">‚úèÔ∏è Edit Data</button>
                    <button id="saveDatabaseBtn" class="btn-database" onclick="showSaveConfirmation()">üíæ Save to Database</button>
                    <button id="saveBtn" class="btn-save hidden" onclick="saveChanges()">‚úÖ Save Changes</button>
                    <button id="cancelBtn" class="btn-cancel hidden" onclick="cancelEdit()">‚ùå Cancel</button>
                </div>
                
                <!-- Items Table -->
                <h3>üì¶ Certificate Items</h3>
                <div class="items-table-container">
                    <table class="items-table" id="certItemsTable">
                        <thead>
                            <tr>
                                <th>Line No</th>
                                <th>HS Code</th>
                                <th>Item Name</th>
                                <th>Approved Qty</th>
                                <th>UOM</th>
                                <th>Port Klang</th>
                                <th>KLIA</th>
                                <th>Bukit Kayu Hitam</th>
                            </tr>
                        </thead>
                        <tbody id="certItemsBody">
                        </tbody>
                    </table>
                </div>
                
                <!-- Success message -->
                <div id="saveSuccess" class="success-message hidden">
                    <h4>‚úÖ Changes Saved</h4>
                    <p>Your edits have been saved successfully.</p>
                </div>
                
                <!-- Warnings Section -->
                <div id="parserWarnings" class="warnings-section hidden">
                    <h3>‚ö†Ô∏è OCR Warnings</h3>
                    <div id="parserWarningsList"></div>
                </div>
                
                <!-- Raw JSON -->
                <details style="margin-top: 1.5rem;">
                    <summary style="cursor: pointer; color: #7f8c8d;">Show Raw JSON Response</summary>
                    <pre id="parserRawResult"></pre>
                </details>
            </div>
        </div>
    </div>

    <script>
        // Use relative URL when served from same origin, or localhost for local file access
        const API_BASE = window.location.protocol === 'file:' ? 'http://localhost:8000' : '';
        
        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            document.querySelector(`.tab-content#${tabName}-tab`).classList.add('active');
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
        }
        
        // Toggle MIDA mode options
        function toggleMidaMode() {
            const midaMode = document.getElementById('midaMode').checked;
            const midaOptions = document.getElementById('midaOptions');
            
            if (midaMode) {
                midaOptions.classList.remove('hidden');
            } else {
                midaOptions.classList.add('hidden');
            }
        }
        
        // Convert Invoice
        async function convertInvoice() {
            const fileInput = document.getElementById('invoiceFile');
            const midaMode = document.getElementById('midaMode').checked;
            const certNumber = document.getElementById('midaCertNumber').value.trim();
            const matchMode = document.getElementById('matchMode').value;
            const matchThreshold = document.getElementById('matchThreshold').value;
            
            // Reset UI
            hideElement('converterResults');
            hideElement('converterError');
            hideElement('matchedItemsSection');
            hideElement('allItemsSection');
            hideElement('warningsSection');
            
            // Validation
            if (!fileInput.files[0]) {
                showError('Please select an invoice file first.');
                return;
            }
            
            if (midaMode && !certNumber) {
                showError('Please enter a MIDA certificate number when MIDA mode is enabled.');
                return;
            }
            
            // Show loading
            showElement('converterLoading');
            document.getElementById('convertBtn').disabled = true;
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('match_mode', matchMode);
            formData.append('match_threshold', matchThreshold);
            
            if (midaMode && certNumber) {
                formData.append('mida_certificate_number', certNumber);
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/convert`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    // Handle error responses
                    const errorDetail = data.detail;
                    if (typeof errorDetail === 'object') {
                        if (errorDetail.detail === 'Invalid MIDA certificate number') {
                            showError(`Certificate not found: "${certNumber}" is not a valid MIDA certificate number. Please check the certificate number and try again.`);
                        } else {
                            showError(errorDetail.detail || 'An error occurred');
                        }
                    } else {
                        showError(errorDetail || 'An error occurred');
                    }
                    return;
                }
                
                // Display results
                displayResults(data, midaMode);
                
            } catch (error) {
                console.error('Error:', error);
                showError('Error connecting to server: ' + error.message);
            } finally {
                hideElement('converterLoading');
                document.getElementById('convertBtn').disabled = false;
            }
        }
        
        // Display results
        function displayResults(data, midaMode) {
            showElement('converterResults');
            
            // Summary stats
            const statsHtml = `
                <div class="stat-card">
                    <div class="number">${data.total_invoice_items}</div>
                    <div class="label">Total Items</div>
                </div>
                <div class="stat-card matched">
                    <div class="number">${data.matched_item_count}</div>
                    <div class="label">Matched</div>
                </div>
                <div class="stat-card unmatched">
                    <div class="number">${data.unmatched_item_count}</div>
                    <div class="label">Unmatched</div>
                </div>
            `;
            document.getElementById('summaryStats').innerHTML = statsHtml;
            
            // Raw JSON
            document.getElementById('rawResult').textContent = JSON.stringify(data, null, 2);
            
            if (midaMode && data.mida_matched_items && data.mida_matched_items.length > 0) {
                // Display matched items table
                displayMatchedItems(data.mida_matched_items);
            } else if (!midaMode && data.all_invoice_items && data.all_invoice_items.length > 0) {
                // Display all items table (normal mode) - start with filtered view
                cachedResponseData = data;
                currentViewMode = 'filtered';
                updateToggleUI();
                displayAllItems(data.all_invoice_items, false);
            }
            
            // Display warnings (only in full view for normal mode, since filtered view won't match totals)
            if (data.warnings && data.warnings.length > 0) {
                if (midaMode) {
                    displayWarnings(data.warnings);
                }
                // For normal mode, warnings shown only when switching to full view
            }
        }
        
        // Cache response data for toggle functionality
        let cachedResponseData = null;
        let currentViewMode = 'filtered'; // 'filtered' or 'full'
        
        // Switch to filtered view (non-FORM-D only)
        function switchToFilteredView() {
            if (!cachedResponseData) return;
            currentViewMode = 'filtered';
            updateToggleUI();
            displayAllItems(cachedResponseData.all_invoice_items, false);
            document.getElementById('itemsTableTitle').textContent = 'üìã Invoice Items with Empty Form Flag (Non-FORM-D)';
            
            // Hide warnings in filtered view (totals won't match since FORM-D items are excluded)
            hideElement('warningsSection');
        }
        
        // Switch to full view (all items including FORM-D and Total)
        function switchToFullView() {
            if (!cachedResponseData) return;
            currentViewMode = 'full';
            updateToggleUI();
            
            if (cachedResponseData.full_invoice_items && cachedResponseData.full_invoice_items.length > 0) {
                displayAllItems(cachedResponseData.full_invoice_items, true);
            } else {
                console.warn('full_invoice_items is empty or undefined');
                // Fallback: show message
                const tbody = document.querySelector('#allItemsTable tbody');
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #7f8c8d;">No items available in full view</td></tr>';
            }
            document.getElementById('itemsTableTitle').textContent = 'üìÑ All Invoice Items (Including FORM-D & Total)';
            
            // Show warnings in full view (Total Row Validation)
            if (cachedResponseData.warnings && cachedResponseData.warnings.length > 0) {
                displayWarnings(cachedResponseData.warnings);
            } else {
                hideElement('warningsSection');
            }
        }
        
        // Update toggle button UI
        function updateToggleUI() {
            document.getElementById('viewFilteredBtn').classList.toggle('active', currentViewMode === 'filtered');
            document.getElementById('viewFullBtn').classList.toggle('active', currentViewMode === 'full');
        }
        
        // Display matched items table
        function displayMatchedItems(items) {
            showElement('matchedItemsSection');
            const tbody = document.querySelector('#matchedItemsTable tbody');
            tbody.innerHTML = '';
            
            items.forEach(item => {
                const scoreClass = item.match_score >= 0.95 ? 'high' : 
                                   item.match_score >= 0.8 ? 'medium' : 'low';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.line_no}</td>
                    <td>${escapeHtml(item.description)}</td>
                    <td>${item.quantity}</td>
                    <td>${item.mida_line_no}</td>
                    <td>${escapeHtml(item.mida_item_name)}</td>
                    <td>${item.remaining_qty} ${item.remaining_uom}</td>
                    <td><span class="match-score ${scoreClass}">${(item.match_score * 100).toFixed(0)}%</span></td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Display all items table (normal mode)
        function displayAllItems(items, showFormFlag = false) {
            showElement('allItemsSection');
            
            // Update table header based on view mode
            const thead = document.getElementById('allItemsTableHead');
            if (showFormFlag) {
                thead.innerHTML = `
                    <tr>
                        <th>Line</th>
                        <th>Parts No</th>
                        <th>Parts Name</th>
                        <th>HS Code</th>
                        <th>Form Flag</th>
                        <th>Qty</th>
                        <th>Amount (USD)</th>
                        <th>Net Wt (Kg)</th>
                    </tr>
                `;
            } else {
                thead.innerHTML = `
                    <tr>
                        <th>Line</th>
                        <th>Parts No</th>
                        <th>Parts Name</th>
                        <th>HS Code</th>
                        <th>Qty</th>
                        <th>Amount (USD)</th>
                        <th>Net Wt (Kg)</th>
                    </tr>
                `;
            }
            
            const tbody = document.querySelector('#allItemsTable tbody');
            tbody.innerHTML = '';
            
            items.forEach(item => {
                const row = document.createElement('tr');
                const isTotal = item.is_total_row === true;
                const isFormD = item.form_flag === 'FORM-D';
                
                if (isTotal) {
                    row.className = 'total-row';
                }
                
                if (showFormFlag) {
                    // Full view with Form Flag column
                    const formFlagBadge = isTotal ? '' : 
                        isFormD ? '<span class="form-flag-badge form-d">FORM-D</span>' :
                        '<span class="form-flag-badge empty">Non-FORM-D</span>';
                    
                    row.innerHTML = `
                        <td>${isTotal ? '' : item.line_no}</td>
                        <td>${escapeHtml(item.parts_no || '')}</td>
                        <td>${isTotal ? '<strong>Total</strong>' : escapeHtml(item.description)}</td>
                        <td>${escapeHtml(item.hs_code || '')}</td>
                        <td>${formFlagBadge}</td>
                        <td>${item.quantity}</td>
                        <td>${item.amount ? '$' + item.amount.toFixed(2) : '-'}</td>
                        <td>${item.net_weight_kg ? item.net_weight_kg.toFixed(2) : '-'}</td>
                    `;
                } else {
                    // Filtered view without Form Flag column
                    row.innerHTML = `
                        <td>${item.line_no}</td>
                        <td>${escapeHtml(item.parts_no || '')}</td>
                        <td>${escapeHtml(item.description)}</td>
                        <td>${escapeHtml(item.hs_code || '')}</td>
                        <td>${item.quantity}</td>
                        <td>${item.amount ? '$' + item.amount.toFixed(2) : '-'}</td>
                        <td>${item.net_weight_kg ? item.net_weight_kg.toFixed(2) : '-'}</td>
                    `;
                }
                tbody.appendChild(row);
            });
        }
        
        // Display warnings
        function displayWarnings(warnings) {
            showElement('warningsSection');
            const container = document.getElementById('warningsList');
            container.innerHTML = '';
            
            warnings.forEach(warning => {
                const div = document.createElement('div');
                div.className = `warning-item ${warning.severity}`;
                div.innerHTML = `
                    <span class="invoice-item">${escapeHtml(warning.invoice_item)}</span>
                    <span class="severity-badge ${warning.severity}">${warning.severity}</span>
                    <div class="reason">${escapeHtml(warning.reason)}</div>
                `;
                container.appendChild(div);
            });
        }
        
        // Show error message
        function showError(message) {
            document.getElementById('errorText').textContent = message;
            showElement('converterError');
        }
        
        // Helper functions
        function showElement(id) {
            document.getElementById(id).classList.remove('hidden');
        }
        
        function hideElement(id) {
            document.getElementById(id).classList.add('hidden');
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Certificate Parser (existing functionality)
        async function uploadFile() {
            const fileInput = document.getElementById('pdfInput');
            const resultDisplay = document.getElementById('result');
            
            if (!fileInput.files[0]) {
                alert('Please select a PDF file first.');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            resultDisplay.textContent = 'Uploading and processing...';

            try {
                const response = await fetch(`${API_BASE}/api/mida/certificate/parse`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                resultDisplay.textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                console.error('Error:', error);
                resultDisplay.textContent = 'Error processing request: ' + error.message;
            }
        }
        
        // ==========================================
        // Certificate Parser - Interactive Table
        // ==========================================
        
        let parsedCertificateData = null;
        let originalCertificateData = null;
        let isEditMode = false;
        
        // Parse Certificate
        async function parseCertificate() {
            const fileInput = document.getElementById('pdfInput');
            
            // Reset UI
            hideElement('parserResults');
            hideElement('parserError');
            hideElement('saveSuccess');
            hideElement('parserWarnings');
            
            if (!fileInput.files[0]) {
                showParserError('Please select a PDF file first.');
                return;
            }
            
            // Show loading
            showElement('parserLoading');
            document.getElementById('parseBtn').disabled = true;
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            try {
                const response = await fetch(`${API_BASE}/api/mida/certificate/parse`, {
                    method: 'POST',
                    body: formData
                });
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    showParserError(`Server error: ${text || response.statusText}`);
                    return;
                }
                
                const data = await response.json();
                
                if (!response.ok) {
                    const errorMsg = data.detail || 'Failed to parse certificate';
                    showParserError(typeof errorMsg === 'object' ? JSON.stringify(errorMsg) : errorMsg);
                    return;
                }
                
                // Store data
                parsedCertificateData = JSON.parse(JSON.stringify(data));
                originalCertificateData = JSON.parse(JSON.stringify(data));
                
                // Display results
                displayParsedCertificate(data);
                
            } catch (error) {
                console.error('Error:', error);
                showParserError('Error connecting to server: ' + error.message);
            } finally {
                hideElement('parserLoading');
                document.getElementById('parseBtn').disabled = false;
            }
        }
        
        // Date format conversion utilities
        function isoToDisplay(isoDate) {
            // Convert YYYY-MM-DD to DD/MM/YYYY
            if (!isoDate || isoDate === '-') return '-';
            const parts = isoDate.split('-');
            if (parts.length !== 3) return isoDate;
            return `${parts[2]}/${parts[1]}/${parts[0]}`;
        }
        
        function displayToIso(displayDate) {
            // Convert DD/MM/YYYY to YYYY-MM-DD
            if (!displayDate || displayDate === '-') return null;
            const parts = displayDate.split('/');
            if (parts.length !== 3) return displayDate;
            return `${parts[2]}-${parts[1]}-${parts[0]}`;
        }
        
        function isoToInputValue(isoDate) {
            // Convert YYYY-MM-DD to input date value (YYYY-MM-DD for HTML date input)
            if (!isoDate || isoDate === '-') return '';
            return isoDate;
        }
        
        // Display parsed certificate data
        function displayParsedCertificate(data) {
            showElement('parserResults');
            
            // Populate header fields (note: backend uses mida_no, exemption_start, exemption_end)
            document.getElementById('certNumber').textContent = data.mida_no || '-';
            document.getElementById('certCompany').textContent = data.company_name || '-';
            
            // Store ISO dates as data attributes and display in DD/MM/YYYY format
            const startDateEl = document.getElementById('certStartDate');
            const endDateEl = document.getElementById('certEndDate');
            
            startDateEl.dataset.isoDate = data.exemption_start || '';
            startDateEl.textContent = isoToDisplay(data.exemption_start) || '-';
            
            endDateEl.dataset.isoDate = data.exemption_end || '';
            endDateEl.textContent = isoToDisplay(data.exemption_end) || '-';
            
            // Populate items table
            const tbody = document.getElementById('certItemsBody');
            tbody.innerHTML = '';
            
            if (data.items && data.items.length > 0) {
                data.items.forEach((item, index) => {
                    const row = document.createElement('tr');
                    row.dataset.index = index;
                    row.innerHTML = `
                        <td class="editable-cell" data-field="line_no">${item.line_no || ''}</td>
                        <td class="editable-cell" data-field="hs_code">${escapeHtml(item.hs_code || '')}</td>
                        <td class="editable-cell" data-field="item_name">${escapeHtml(item.item_name || '')}</td>
                        <td class="editable-cell" data-field="approved_quantity">${item.approved_quantity ?? ''}</td>
                        <td class="editable-cell" data-field="uom">${escapeHtml(item.uom || '')}</td>
                        <td class="editable-cell" data-field="port_klang_qty">${item.port_klang_qty ?? ''}</td>
                        <td class="editable-cell" data-field="klia_qty">${item.klia_qty ?? ''}</td>
                        <td class="editable-cell" data-field="bukit_kayu_hitam_qty">${item.bukit_kayu_hitam_qty ?? ''}</td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #7f8c8d;">No items found in certificate</td></tr>';
            }
            
            // Show warnings if any
            if (data.warnings && data.warnings.length > 0) {
                document.getElementById('warningsBadge').textContent = `${data.warnings.length} warning(s)`;
                showElement('warningsBadge');
                displayParserWarnings(data.warnings);
            } else {
                hideElement('warningsBadge');
            }
            
            // Show raw JSON
            document.getElementById('parserRawResult').textContent = JSON.stringify(data, null, 2);
            
            // Reset edit mode
            isEditMode = false;
            updateEditButtons();
        }
        
        // Display parser warnings
        function displayParserWarnings(warnings) {
            showElement('parserWarnings');
            const container = document.getElementById('parserWarningsList');
            container.innerHTML = '';
            
            warnings.forEach(warning => {
                const div = document.createElement('div');
                div.className = 'warning-item warning';
                div.innerHTML = `<span class="reason">${escapeHtml(warning)}</span>`;
                container.appendChild(div);
            });
        }
        
        // Toggle edit mode
        function toggleEditMode() {
            isEditMode = !isEditMode;
            
            // Store current data before editing
            if (isEditMode) {
                originalCertificateData = JSON.parse(JSON.stringify(parsedCertificateData));
            }
            
            // Handle non-date header fields (certificate number, company name)
            const certNumberEl = document.getElementById('certNumber');
            const certCompanyEl = document.getElementById('certCompany');
            
            if (isEditMode) {
                certNumberEl.contentEditable = 'true';
                certNumberEl.classList.add('editable');
                certCompanyEl.contentEditable = 'true';
                certCompanyEl.classList.add('editable');
            } else {
                certNumberEl.contentEditable = 'false';
                certNumberEl.classList.remove('editable');
                certCompanyEl.contentEditable = 'false';
                certCompanyEl.classList.remove('editable');
            }
            
            // Handle date fields with date input
            const startDateEl = document.getElementById('certStartDate');
            const endDateEl = document.getElementById('certEndDate');
            
            if (isEditMode) {
                // Replace text with date input for start date
                const startIso = startDateEl.dataset.isoDate || '';
                startDateEl.innerHTML = `<input type="date" id="startDateInput" value="${startIso}" style="width: 100%; padding: 0.4rem; border: 1px solid #3498db; border-radius: 4px;">`;
                startDateEl.classList.add('editable');
                
                // Replace text with date input for end date
                const endIso = endDateEl.dataset.isoDate || '';
                endDateEl.innerHTML = `<input type="date" id="endDateInput" value="${endIso}" style="width: 100%; padding: 0.4rem; border: 1px solid #3498db; border-radius: 4px;">`;
                endDateEl.classList.add('editable');
            } else {
                // Restore text display
                startDateEl.textContent = isoToDisplay(startDateEl.dataset.isoDate) || '-';
                startDateEl.classList.remove('editable');
                
                endDateEl.textContent = isoToDisplay(endDateEl.dataset.isoDate) || '-';
                endDateEl.classList.remove('editable');
            }
            
            // Make table cells editable
            const cells = document.querySelectorAll('#certItemsBody .editable-cell');
            cells.forEach(cell => {
                if (isEditMode) {
                    cell.contentEditable = 'true';
                    cell.classList.add('editing');
                } else {
                    cell.contentEditable = 'false';
                    cell.classList.remove('editing');
                }
            });
            
            updateEditButtons();
            hideElement('saveSuccess');
        }
        
        // Update edit button visibility
        function updateEditButtons() {
            if (isEditMode) {
                hideElement('editBtn');
                hideElement('saveDatabaseBtn');
                showElement('saveBtn');
                showElement('cancelBtn');
            } else {
                showElement('editBtn');
                showElement('saveDatabaseBtn');
                hideElement('saveBtn');
                hideElement('cancelBtn');
            }
        }
        
        // Save changes
        function saveChanges() {
            // Collect data from header fields (use backend field names: mida_no, exemption_start, exemption_end)
            parsedCertificateData.mida_no = document.getElementById('certNumber').textContent.trim();
            parsedCertificateData.company_name = document.getElementById('certCompany').textContent.trim();
            
            // Get dates from date inputs (they return ISO format YYYY-MM-DD)
            const startDateInput = document.getElementById('startDateInput');
            const endDateInput = document.getElementById('endDateInput');
            
            const startDateValue = startDateInput ? startDateInput.value : '';
            const endDateValue = endDateInput ? endDateInput.value : '';
            
            // Update data attributes for display later
            document.getElementById('certStartDate').dataset.isoDate = startDateValue;
            document.getElementById('certEndDate').dataset.isoDate = endDateValue;
            
            parsedCertificateData.exemption_start = startDateValue || null;
            parsedCertificateData.exemption_end = endDateValue || null;
            
            // Collect data from items table
            const rows = document.querySelectorAll('#certItemsBody tr');
            parsedCertificateData.items = [];
            
            rows.forEach((row, index) => {
                if (row.dataset.index !== undefined) {
                    const item = {
                        line_no: parseInt(row.querySelector('[data-field="line_no"]').textContent.trim()) || index + 1,
                        hs_code: row.querySelector('[data-field="hs_code"]').textContent.trim(),
                        item_name: row.querySelector('[data-field="item_name"]').textContent.trim(),
                        approved_quantity: parseFloat(row.querySelector('[data-field="approved_quantity"]').textContent.trim()) || null,
                        uom: row.querySelector('[data-field="uom"]').textContent.trim(),
                        port_klang_qty: parseFloat(row.querySelector('[data-field="port_klang_qty"]').textContent.trim()) || null,
                        klia_qty: parseFloat(row.querySelector('[data-field="klia_qty"]').textContent.trim()) || null,
                        bukit_kayu_hitam_qty: parseFloat(row.querySelector('[data-field="bukit_kayu_hitam_qty"]').textContent.trim()) || null
                    };
                    parsedCertificateData.items.push(item);
                }
            });
            
            // Exit edit mode
            isEditMode = false;
            toggleEditMode();
            
            // Update raw JSON display
            document.getElementById('parserRawResult').textContent = JSON.stringify(parsedCertificateData, null, 2);
            
            // Show success message
            showElement('saveSuccess');
            
            // Hide success after 3 seconds
            setTimeout(() => {
                hideElement('saveSuccess');
            }, 3000);
        }
        
        // Cancel edit - restore original data and exit edit mode
        function cancelEdit() {
            // Restore original data from the snapshot taken when edit mode started
            parsedCertificateData = JSON.parse(JSON.stringify(originalCertificateData));
            
            // Exit edit mode
            isEditMode = false;
            
            // Re-render the display with the original data
            displayParsedCertificate(parsedCertificateData);
        }
        
        // Show save to database confirmation modal
        function showSaveConfirmation() {
            document.getElementById('confirmModal').classList.add('active');
        }
        
        // Hide confirmation modal
        function hideConfirmModal() {
            document.getElementById('confirmModal').classList.remove('active');
        }
        
        // Save to database after confirmation
        function saveToDatabaseConfirmed() {
            hideConfirmModal();
            
            // TODO: Implement actual database save API call
            // For now, just show a success message
            console.log('Saving to database:', parsedCertificateData);
            
            // Show success message (placeholder until API is implemented)
            alert('Certificate data will be saved to database.\n\nNote: Database save functionality will be implemented later.');
        }
        
        // Show parser error
        function showParserError(message) {
            document.getElementById('parserErrorText').textContent = message;
            showElement('parserError');
        }
    </script>
    
    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal-overlay">
        <div class="modal-content">
            <h3>üíæ Save to Database</h3>
            <p>Are you sure you want to save this certificate data to the database?</p>
            <p>Please confirm that all the information is correct before proceeding.</p>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="hideConfirmModal()">Cancel</button>
                <button class="btn-database" onclick="saveToDatabaseConfirmed()">Yes, Save to Database</button>
            </div>
        </div>
    </div>
</body>
</html>
